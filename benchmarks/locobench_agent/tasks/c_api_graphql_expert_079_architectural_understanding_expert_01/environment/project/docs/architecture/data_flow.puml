@startuml data_flow
' =============================================================================
'  SynestheticCanvas API Suite — Data Flow Diagram
' =============================================================================
'  File:          docs/architecture/data_flow.puml
'  Language:      PlantUML (documentation)
'  Generated-by:  Architectural Automation Toolchain
' ---------------------------------------------------------------------------
'  Description:
'  Illustrates the end-to-end flow of a request as it traverses the
'  SynestheticCanvas constellation.  The diagram emphasizes how the API
'  Gateway orchestrates synchronous GraphQL/REST calls while the NATS
'  message bus handles asynchronous, event-driven communication between
'  domain-specific microservices.
' ---------------------------------------------------------------------------
'  Key Architectural Concerns Addressed
'  – Versioning            (semver tags on GraphQL schemas)
'  – Validation            (JSON Schema / GraphQL SDL assertions)
'  – Observability         (Prometheus metrics, Jaeger traces, JSON logs)
'  – Performance           (token-bucket rate limiting, Redis cache)
'  – Modularity            (repository pattern, CQRS, service isolation)
' ---------------------------------------------------------------------------
'  PlantUML Settings
' ---------------------------------------------------------------------------
!define ICONURL https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master
!include ICONURL/common.puml
!include ICONURL/font-awesome-5/gitlab.puml
!include ICONURL/font-awesome-5/database.puml
!include ICONURL/font-awesome-5/redis.puml
!include ICONURL/font-awesome-5/cloud.puml
!include ICONURL/font-awesome-5/cubes.puml
!include ICONURL/font-awesome-5/user-astronaut.puml

skinparam shadowing true
skinparam componentStyle rectangle
skinparam rectangle {
    BackgroundColor #F4F4F4
    BorderColor     #888888
    BorderRadius    4
}
skinparam package {
    BackgroundColor #FEFEFE
    BorderColor     #555555
    BorderRadius    2
}
skinparam database {
    BackgroundColor #FFFAF0
    BorderColor     #D2691E
}
skinparam queue {
    BackgroundColor #FFFFE0
    BorderColor     #CCCC00
}

' ----------------------------------------------------------------------------
' Top-Level Actors & Gateway
' ----------------------------------------------------------------------------
actor Client <<$user-astronaut>>  #3366FF

node "API Gateway\n(GraphQL / REST)\n<<Gateway>>" as APIGW <<$gitlab>> {
}

queue "Rate Limiter\n(Token Bucket)" as RL
component "Request Validator\n(JSONSchema/SDL)" as VAL
database "Redis\nResponse Cache" as Cache <<$redis>>
component "GraphQL Resolver\nService Layer" as GQL

' ----------------------------------------------------------------------------
' Domain-Specific Microservices
' ----------------------------------------------------------------------------
package "Microservices" <<Rectangle>> {
    [Palette Service]  as Palette
    [Texture Service]  as Texture
    [Audio-Reactive Service] as Audio
    [Narrative Service] as Narrative
}

' ----------------------------------------------------------------------------
' Persistence Layer
' ----------------------------------------------------------------------------
database "PostgreSQL\nPalette DB"    as PG_Palette    <<$database>>
database "PostgreSQL\nTexture DB"    as PG_Texture    <<$database>>
database "PostgreSQL\nAudio DB"      as PG_Audio      <<$database>>
database "PostgreSQL\nNarrative DB"  as PG_Narrative  <<$database>>

cloud "Message Bus\n(NATS JetStream)" as Bus <<$cloud>>

component "Monitoring & Tracing\n(Prometheus + Jaeger)" as Monitor <<$cloud>>
component "Structured Logger\n(JSON Logs)"              as Logger  <<$cloud>>

' ----------------------------------------------------------------------------
' Request Path (Synchronous)
' ----------------------------------------------------------------------------
Client   -->  APIGW    : HTTPS Request\n(GraphQL query / REST call)
APIGW    -->  RL       : Check quota
RL       -->  APIGW    : Allow / 429
APIGW    -->  Cache    : Read-through lookup
Cache    -->  APIGW    : Hit / Miss
APIGW    -->  VAL      : Validate payload
VAL      -->  APIGW    : OK / 400
APIGW    -->  GQL      : Execute query

' ----------------------------------------------------------------------------
' Service Layer Fan-out
' ----------------------------------------------------------------------------
GQL      -->  Palette  : gRPC / HTTP call
GQL      -->  Texture
GQL      -->  Audio
GQL      -->  Narrative

' ----------------------------------------------------------------------------
' Data Access
' ----------------------------------------------------------------------------
Palette  -->  PG_Palette
Texture  -->  PG_Texture
Audio    -->  PG_Audio
Narrative-->  PG_Narrative

' ----------------------------------------------------------------------------
' Event Publication (Asynchronous)
' ----------------------------------------------------------------------------
Palette   -->  Bus  : PaletteUpdated
Texture   -->  Bus  : TextureSynthesized
Audio     -->  Bus  : AudioEnvelopeCaptured
Narrative -->  Bus  : StoryBranchSelected

' ----------------------------------------------------------------------------
' Event Subscription (Fan-in)
' ----------------------------------------------------------------------------
Bus --> Palette
Bus --> Texture
Bus --> Audio
Bus --> Narrative

' ----------------------------------------------------------------------------
' Response Handling
' ----------------------------------------------------------------------------
APIGW    --> Cache    : Store response (TTL ± SWR)
APIGW    --> Client   : HTTPS Response

' ----------------------------------------------------------------------------
' Observability
' ----------------------------------------------------------------------------
APIGW   ..> Monitor : Metrics / Traces
GQL     ..> Monitor
Palette ..> Monitor
Texture ..> Monitor
Audio   ..> Monitor
Narrative ..> Monitor

APIGW   ..> Logger : JSON Structured Logs
GQL     ..> Logger
Palette ..> Logger
Texture ..> Logger
Audio   ..> Logger
Narrative ..> Logger
RL      ..> Logger

' ----------------------------------------------------------------------------
' Legend
' ----------------------------------------------------------------------------
legend left
  <b>Legend</b>
  Actor                 — External consumer
  Gateway               — Unified GraphQL/REST entry
  Queue                 — Infrastructure (rate-limiting, caching)
  Component             — Business logic / validation
  Database              — Persistent storage
  Cloud                 — External systems (bus, monitoring, logging)
endlegend

@enduml