```yaml
version: "3.9"

################################################################################
# SynestheticCanvas – Production-grade Docker Compose stack
#
# This compose file spins up the full API suite in a local or staging
# environment.  Each service is an isolated C micro-service exposing either a
# REST or GraphQL surface.  For serious production deployments, mirror this file
# into your GitOps workflow (e.g., ArgoCD / Flux) and override environment
# values through external secrets managers (Vault, AWS Secrets Manager, etc.).
################################################################################

x-common-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

x-healthcheck: &default-health
  healthcheck:
    test: ["CMD-SHELL", "curl -f http://localhost:${HEALTH_PORT:-8080}/healthz || exit 1"]
    interval: 10s
    timeout: 3s
    retries: 5
    start_period: 5s

x-common-env: &default-env
  ENVIRONMENT: ${ENVIRONMENT:-development}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  REDIS_URL: redis://redis:6379/0
  POSTGRES_HOST: postgres
  POSTGRES_DB: synesthetic
  POSTGRES_PORT: 5432
  POSTGRES_USER: syncanvas
  POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password

###############################################################################
# Services
###############################################################################
services:

  #--------------------------------------------------------------------------#
  # API Gateway – GraphQL/REST multiplexer (also performs auth & caching)
  #--------------------------------------------------------------------------#
  api_gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
      target: prod
    image: synesthetic/gateway:${TAG:-latest}
    container_name: syn_gateway
    environment:
      <<: *default-env
      GQL_INTROSPECTION: ${GQL_INTROSPECTION:-true}
      CACHE_TTL_SECONDS: 30
      RATE_LIMIT_RPS: 200
    ports:
      - "8080:8080"   # external HTTP ingress
      - "8181:8181"   # internal gRPC control plane
    networks:
      - frontend
      - backend
    depends_on:
      - palette_service
      - texture_service
      - audio_service
      - narrative_service
      - redis
      - postgres
    restart: unless-stopped
    secrets:
      - postgres_password
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Palette Management Service
  #--------------------------------------------------------------------------#
  palette_service:
    build:
      context: ./services/palette
      dockerfile: Dockerfile
      target: prod
    image: synesthetic/palette:${TAG:-latest}
    container_name: syn_palette
    environment:
      <<: *default-env
      SERVICE_PORT: 7001
    networks:
      - backend
    restart: unless-stopped
    secrets:
      - postgres_password
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Dynamic Texture Synthesis Service
  #--------------------------------------------------------------------------#
  texture_service:
    build:
      context: ./services/texture
      dockerfile: Dockerfile
      target: prod
    image: synesthetic/texture:${TAG:-latest}
    container_name: syn_texture
    environment:
      <<: *default-env
      SERVICE_PORT: 7002
    networks:
      - backend
    restart: unless-stopped
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Audio-Reactive Animation Service
  #--------------------------------------------------------------------------#
  audio_service:
    build:
      context: ./services/audio
      dockerfile: Dockerfile
      target: prod
    image: synesthetic/audio:${TAG:-latest}
    container_name: syn_audio
    environment:
      <<: *default-env
      SERVICE_PORT: 7003
    networks:
      - backend
    restart: unless-stopped
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Narrative Branching Service
  #--------------------------------------------------------------------------#
  narrative_service:
    build:
      context: ./services/narrative
      dockerfile: Dockerfile
      target: prod
    image: synesthetic/narrative:${TAG:-latest}
    container_name: syn_narrative
    environment:
      <<: *default-env
      SERVICE_PORT: 7004
    networks:
      - backend
    restart: unless-stopped
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # PostgreSQL – Artwork metadata & user-generated content
  #--------------------------------------------------------------------------#
  postgres:
    image: postgres:14-alpine
    container_name: syn_postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: synesthetic
      POSTGRES_USER: syncanvas
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    networks:
      - backend
    restart: unless-stopped
    secrets:
      - postgres_password
    <<: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 3s
      retries: 5

  #--------------------------------------------------------------------------#
  # Redis – Shared cache & rate-limiter backend
  #--------------------------------------------------------------------------#
  redis:
    image: redis:6.2-alpine
    container_name: syn_redis
    volumes:
      - redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
    networks:
      - backend
    restart: unless-stopped
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Prometheus – Metrics scraping
  #--------------------------------------------------------------------------#
  prometheus:
    image: prom/prometheus:v2.44.0
    container_name: syn_prometheus
    volumes:
      - prometheus_data:/prometheus
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - monitoring
    restart: unless-stopped
    ports:
      - "9090:9090"
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Grafana – Dashboards
  #--------------------------------------------------------------------------#
  grafana:
    image: grafana/grafana:10.0.2
    container_name: syn_grafana
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SERVER_HTTP_PORT: 3000
    networks:
      - monitoring
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    <<: *default-logging
    <<: *default-health

  #--------------------------------------------------------------------------#
  # Loki + Promtail – Log aggregation
  #--------------------------------------------------------------------------#
  loki:
    image: grafana/loki:2.9.3
    container_name: syn_loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - monitoring
    restart: unless-stopped
    volumes:
      - loki_data:/loki
    ports:
      - "3100:3100"
    <<: *default-logging
    <<: *default-health

  promtail:
    image: grafana/promtail:2.9.3
    container_name: syn_promtail
    volumes:
      - /var/log:/var/log
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      - loki
    <<: *default-logging
    <<: *default-health

###############################################################################
# Networks & Volumes
###############################################################################
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
  monitoring:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
  loki_data:

###############################################################################
# Secrets (DO NOT commit real passwords to VCS)
###############################################################################
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
```