# -------------------------------------------------------------------
# SynestheticCanvas API Gateway Example Configuration
#
# This file is a fully-annotated, production-grade template for
# SynestheticCanvas’ central API gateway.  Copy it to
#   SynestheticCanvas/api-gateway/config/gateway.toml
# and adjust to your deployment needs.  Every option can be overridden
# with an environment variable by upper-casing the key and replacing
# dots with underscores, e.g.  `SERVER.PORT` ➜ `SERVER_PORT`.
# -------------------------------------------------------------------

############################################################
# Core server configuration
############################################################
[server]
# Interface the gateway binds to.
host = "0.0.0.0"

# TCP port the gateway listens on.
port = 8080

# Time (in ms) allowed for in-flight requests to finish
# before the process exits on SIGINT/SIGTERM.
graceful_shutdown_timeout_ms = 5000

# If true, the gateway will serve HTTP/2 over TLS.
# TLS certs are configured in the [tls] table.
enable_tls = false



############################################################
# Transport-layer security
############################################################
[tls]
# Absolute paths or paths relative to the working dir.
cert_file = "/etc/synestheticcanvas/certs/gateway.crt"
key_file  = "/etc/synestheticcanvas/certs/gateway.key"

# Enable mutual TLS by specifying a trusted CA bundle.
# ca_file  = "/etc/synestheticcanvas/certs/clients_ca.crt"



############################################################
# Structured logging
############################################################
[logging]
# Supported levels: TRACE, DEBUG, INFO, WARN, ERROR
level  = "INFO"

# json, console, or colorized
format = "json"

# stdout, stderr, or absolute path to a log file.
output = "stdout"

# Optional file-rotation settings (only used when output
# points to a file).  Rotation happens on startup and when
# max size is exceeded.
file_rotate_max_mb        = 100
file_rotate_max_backups   = 10  # 0 = unlimited
file_rotate_max_age_days  = 14



############################################################
# Operational metrics (Prometheus, OpenTelemetry, …)
############################################################
[metrics]
enabled      = true
route        = "/metrics"
sample_rate  = 0.10        # 10 % of traces are sampled



############################################################
# Distributed tracing
############################################################
[tracing]
enabled            = true
# Supported exporters: otlp, jaeger, zipkin, stdout
exporter           = "otlp"
collector_endpoint = "http://otel-collector:4317"
service_name       = "synestheticcanvas-api-gateway"



############################################################
# Quotas & rate-limiting
############################################################
[rate_limit]
enabled       = true
default_rps   = 100     # Requests per second per client
burst         = 50      # Allowed to exceed default_rps by this much
source_header = "X-Forwarded-For"



############################################################
# Request/response caching
############################################################
[cache]
enabled     = true
adapter     = "redis"      # redis | memcached | in-memory
redis_dsn   = "redis://redis:6379/0"
ttl_seconds = 30           # Default TTL; endpoints can override



############################################################
# Cross-origin resource sharing (CORS)
############################################################
[security]
cors_allowed_origins = ["*"]
cors_allowed_methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
# 1 MiB request-body limit by default
max_request_body_bytes = 1_048_576



############################################################
# Authentication & authorization
############################################################
[auth]
# If true, the gateway will reject requests without a valid JWT
# except for paths listed in `pass_through_routes`.
required              = true
jwt_public_key_file   = "/etc/synestheticcanvas/keys/jwt.pub"
algorithm             = "RS256"
pass_through_routes   = ["/health", "/metrics"]



############################################################
# Upstream microservice registry
#
# Each [[upstream]] block represents a creative capability
# microservice (a “brush stroke” in SynestheticCanvas jargon).
############################################################
[[upstream]]
name              = "palette"
endpoint          = "http://palette-service:7001"
graphql_route     = "/palette/graphql"
rest_route_prefix = "/palette/api"
timeout_ms        = 5000
healthcheck_path  = "/health"
schema_version    = "v1"

[[upstream]]
name              = "texture"
endpoint          = "http://texture-service:7002"
graphql_route     = "/texture/graphql"
rest_route_prefix = "/texture/api"
timeout_ms        = 6000
healthcheck_path  = "/health"
schema_version    = "v1"

[[upstream]]
name              = "audio-reactive"
endpoint          = "http://audio-reactive-service:7003"
graphql_route     = "/audio/graphql"
rest_route_prefix = "/audio/api"
timeout_ms        = 7000
healthcheck_path  = "/health"
schema_version    = "v2"



############################################################
# Schema registry & validation
############################################################
[schema_registry]
# file | consul | etcd | s3
repo_driver       = "file"
location          = "/etc/synestheticcanvas/schemas"
poll_interval_seconds = 30
validate_on_load      = true



############################################################
# Request validation plugin
############################################################
[request_validator]
enabled      = true
strict_mode  = false
max_errors   = 10



############################################################
# Pagination defaults
############################################################
[pagination]
default_page_size = 50
max_page_size     = 500



############################################################
# Health-check endpoint
############################################################
[health]
route                    = "/health"
include_dependency_status = true
cached_ttl_seconds        = 10



############################################################
# Dynamic plugin loader
############################################################
[plugins]
# Directories scanned recursively for .so/.dll plugins
load_paths = ["/usr/lib/synestheticcanvas/plugins"]
# Only explicitly listed plugins are initialized at startup
enabled    = ["request_validator", "response_compressor"]
