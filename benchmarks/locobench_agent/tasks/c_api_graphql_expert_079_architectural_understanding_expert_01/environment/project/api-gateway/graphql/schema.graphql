/*
 * SynestheticCanvas/api-gateway/graphql/schema.graphql
 *
 * IMPORTANT:
 *   Although the file extension is “.graphql”, this unit is C source that
 *   statically embeds the GraphQL Schema Definition Language (SDL) for the
 *   SynestheticCanvas API-Gateway.  The gateway runtime consumes the compiled
 *   schema string directly, which lets us keep the schema versioned, hashed,
 *   and type-checked by the C tool-chain (missing symbol detection, etc.).
 *
 *   Other C modules simply:
 *
 *       #include "graphql/schema.graphql"
 *       const ScSchema *schema = sc_schema();
 *
 *   Make sure your build system compiles this file as C (e.g. by explicit rule
 *   or by compile_database entry).  Clang/GCC are both happy to compile
 *   “.graphql” as C when invoked with “-x c”.
 */

#include <stdint.h>
#include <stddef.h>
#include <pthread.h>

/* ------------------------------------------------------------------------- */
/*  Public Interface                                                         */
/* ------------------------------------------------------------------------- */

/* Immutable, thread-safe runtime representation of the GraphQL SDL. */
typedef struct ScSchema
{
    const char *text;      /* NULL-terminated SDL string                 */
    size_t      len;       /* Length in bytes (excludes terminator)      */
    uint32_t    hash32;    /* FNV-1a 32-bit hash for cache/ETag/version  */
    const char *version;   /* SemVer tag embedded in schema directives   */
} ScSchema;

/* Returns pointer to global schema object; guaranteed non-NULL. */
const ScSchema *sc_schema(void);

/* ------------------------------------------------------------------------- */
/*  Private Implementation                                                   */
/* ------------------------------------------------------------------------- */

static const char k_schema_version[] = "1.2.0";   /* <-- bump on each change */

/*  Pure-C static string literal containing the GraphQL SDL.  Escape
 *  quotes/newlines as required.  Keep formatting identical to canonical
 *  “schema.graphql” for human diffability. */
static const char k_schema_sdl[] =
/* clang-format off */
"schema {\n"
"  query: Query\n"
"  mutation: Mutation\n"
"  subscription: Subscription\n"
"}\n"
"\n"
"# --------------------------------------------------------------------\n"
"#  Root Types                                                         \n"
"# --------------------------------------------------------------------\n"
"type Query {\n"
"  healthCheck: HealthStatus!\n"
"  getCanvas(id: ID!): Canvas\n"
"  listCanvases(pagination: PaginationInput): CanvasConnection!\n"
"}\n"
"\n"
"type Mutation {\n"
"  createCanvas(input: CreateCanvasInput!): Canvas!\n"
"  deleteCanvas(id: ID!): OperationResult!\n"
"}\n"
"\n"
"type Subscription {\n"
"  canvasUpdated(id: ID!): CanvasEvent!\n"
"}\n"
"\n"
"# --------------------------------------------------------------------\n"
"#  Core Objects                                                       \n"
"# --------------------------------------------------------------------\n"
"type Canvas {\n"
"  id: ID!\n"
"  title: String!\n"
"  description: String\n"
"  createdAt: Timestamp!\n"
"  updatedAt: Timestamp!\n"
"  strokes(limit: Int = 128): [Stroke!]!\n"
"}\n"
"\n"
"type Stroke {\n"
"  id: ID!\n"
"  author: String!\n"
"  colorHex: HexColor!\n"
"  dataUri: String!\n"
"  timestamp: Timestamp!\n"
"}\n"
"\n"
"# --------------------------------------------------------------------\n"
"#  Connection + Pagination                                            \n"
"# --------------------------------------------------------------------\n"
"type CanvasConnection {\n"
"  nodes:  [Canvas!]!\n"
"  pageInfo: PageInfo!\n"
"}\n"
"\n"
"input PaginationInput {\n"
"  after: Cursor\n"
"  first: Int = 25\n"
"}\n"
"\n"
"type PageInfo {\n"
"  endCursor: Cursor\n"
"  hasNextPage: Boolean!\n"
"}\n"
"\n"
"# --------------------------------------------------------------------\n"
"#  Events, Aux Types, Scalars                                         \n"
"# --------------------------------------------------------------------\n"
"scalar Timestamp\n"
"scalar Cursor\n"
"scalar HexColor\n"
"\n"
"type HealthStatus {\n"
"  status: String!\n"
"  uptimeMs: Long!\n"
"}\n"
"\n"
"input CreateCanvasInput {\n"
"  title: String!\n"
"  description: String\n"
"}\n"
"\n"
"type OperationResult {\n"
"  ok: Boolean!\n"
"  message: String\n"
"}\n"
"\n"
"type CanvasEvent {\n"
"  canvas: Canvas!\n"
"  eventType: String!\n"
"  occurredAt: Timestamp!\n"
"}\n";
/* clang-format on */

/* Size in bytes, excluding null terminator. */
static const size_t k_schema_len = sizeof(k_schema_sdl) - 1U;

/* ------------------------------------------------------------------------- */
/*  FNV-1a 32-bit                                                             */
/* ------------------------------------------------------------------------- */

static uint32_t
sc_fnv1a_32(const void *data, size_t len)
{
    const uint8_t *d = (const uint8_t *)data;
    uint32_t hash   = 0x811c9dc5u; /* offset_basis */
    for (size_t i = 0; i < len; ++i)
    {
        hash ^= d[i];
        hash *= 0x01000193u; /* prime */
    }
    return hash;
}

/* ------------------------------------------------------------------------- */
/*  Singleton Schema Instance                                                */
/* ------------------------------------------------------------------------- */

static ScSchema        g_schema;
static pthread_once_t  g_schema_once = PTHREAD_ONCE_INIT;

static void
sc_schema_init_once(void)
{
    g_schema.text    = k_schema_sdl;
    g_schema.len     = k_schema_len;
    g_schema.hash32  = sc_fnv1a_32(k_schema_sdl, k_schema_len);
    g_schema.version = k_schema_version;
}

const ScSchema *
sc_schema(void)
{
    /* pthread_once guarantees thread-safe initialization. */
    pthread_once(&g_schema_once, sc_schema_init_once);
    return &g_schema;
}
