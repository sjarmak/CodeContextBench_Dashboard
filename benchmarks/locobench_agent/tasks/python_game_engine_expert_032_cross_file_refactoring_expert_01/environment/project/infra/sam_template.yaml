```yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  LedgerQuest Engine â€“ Serverless, Business-Grade Game Framework
  Core infrastructure template (SAM).  Provides a fully-managed,
  event-driven back-end including the main game-loop Step Function,
  stateless Lambda micro-services (physics, AI, ECS mutations), WebSocket
  gateway, GPU burst rendering via Fargate, as well as multi-tenant data
  stores and audit facilities.

##########################################################
#                    Global Defaults                     #
##########################################################
Globals:
  Function:
    Runtime: python3.12
    MemorySize: 512
    Timeout: 30
    Tracing: Active
    Environment:
      Variables:
        STAGE: !Ref Stage
        GAME_STATE_TABLE: !Ref GameStateTable
        TENANT_INDEX_TABLE: !Ref TenantIndexTable
        SCENE_BUCKET: !Ref SceneBucket
        EVENT_BUS: !Ref EngineEventBus

##########################################################
#                    Template Parameters                 #
##########################################################
Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues: [dev, test, prod]
    Description: Deployment stage/alias (used for namespacing & env vars).

##########################################################
#                    Resource Section                    #
##########################################################
Resources:
##########################################################
#                    Data Layer                          #
##########################################################
  GameStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "lq-${Stage}-game-state"
      AttributeDefinitions:
        - AttributeName: gameId
          AttributeType: S
        - AttributeName: entityId
          AttributeType: S
      KeySchema:
        - AttributeName: gameId
          KeyType: HASH
        - AttributeName: entityId
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  TenantIndexTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "lq-${Stage}-tenant-index"
      AttributeDefinitions:
        - AttributeName: tenantId
          AttributeType: S
        - AttributeName: gameId
          AttributeType: S
      KeySchema:
        - AttributeName: tenantId
          KeyType: HASH
        - AttributeName: gameId
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true

  SceneBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub "lq-${Stage}-scene-assets"
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: NonCurrentVersionExpiration
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

##########################################################
#                    Event Bus                           #
##########################################################
  EngineEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub "lq-${Stage}-bus"

##########################################################
#                    IAM Policies                        #
##########################################################
  BaseFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "lq-${Stage}-lambda-base"
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:UpdateItem
              - dynamodb:Query
              - dynamodb:BatchWriteItem
            Resource:
              - !GetAtt GameStateTable.Arn
              - !GetAtt TenantIndexTable.Arn
              - !Sub "${GameStateTable.Arn}/index/*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource: !Sub "${SceneBucket.Arn}/*"
          - Effect: Allow
            Action: events:PutEvents
            Resource: !GetAtt EngineEventBus.Arn
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: "arn:aws:logs:*:*:*"

##########################################################
#                    Lambda Functions                    #
##########################################################
  GameLoopProcessorFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-game-loop"
      CodeUri: ../src/lambdas/game_loop/
      Handler: app.handler
      MemorySize: 1024
      Timeout: 60
      Policies:
        - BaseFunctionPolicy
        - AWSLambdaDynamoDBExecutionRole
      Events:
        BusTrigger:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source: ["lq.engine"]
              detail-type: ["tick"]
            EventBusName: !Ref EngineEventBus

  PhysicsEngineFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-physics"
      CodeUri: ../src/lambdas/physics/
      Handler: app.handler
      MemorySize: 1024
      Timeout: 40
      Policies:
        - BaseFunctionPolicy
      Events:
        BusTrigger:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source: ["lq.engine"]
              detail-type: ["physics.update"]
            EventBusName: !Ref EngineEventBus

  AIBehaviourFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-ai"
      CodeUri: ../src/lambdas/ai_behaviour/
      Handler: app.handler
      Timeout: 40
      Policies:
        - BaseFunctionPolicy
      Events:
        BusTrigger:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source: ["lq.engine"]
              detail-type: ["ai.decision"]
            EventBusName: !Ref EngineEventBus

  SceneAssetHandlerFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-scene-handler"
      CodeUri: ../src/lambdas/scene_asset/
      Handler: app.handler
      MemorySize: 1536
      Timeout: 300
      Policies:
        - BaseFunctionPolicy
        - S3ReadPolicy:
            BucketName: !Ref SceneBucket
      Events:
        ScenePut:
          Type: S3
          Properties:
            Bucket: !Ref SceneBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: suffix
                    Value: .scene.json

##########################################################
#         Step Function (Main Orchestration Loop)        #
##########################################################
  GameLoopStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "lq-${Stage}-loop-sm"
      DefinitionUri: ../src/step_functions/game_loop.asl.json
      Role: !GetAtt GameLoopSMRole.Arn
      Tracing:
        Enabled: true
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref GameLoopProcessorFn
        - LambdaInvokePolicy:
            FunctionName: !Ref PhysicsEngineFn
        - LambdaInvokePolicy:
            FunctionName: !Ref AIBehaviourFn
        - EventsPutPolicy:
            EventBusName: !Ref EngineEventBus

  GameLoopSMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "lq-${Stage}-sm-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaRole

##########################################################
#              WebSocket API for real-time I/O           #
##########################################################
  GameWebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "lq-${Stage}-ws"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WSConnectFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-ws-connect"
      CodeUri: ../src/lambdas/ws_connect/
      Handler: app.handler
      Policies:
        - BaseFunctionPolicy
        - AmazonAPIGatewayInvokeFullAccess
      Events:
        ConnectRoute:
          Type: Api
          Properties:
            ApiId: !Ref GameWebSocketApi
            RouteKey: $connect

  WSDisconnectFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "lq-${Stage}-ws-disconnect"
      CodeUri: ../src/lambdas/ws_disconnect/
      Handler: app.handler
      Policies:
        - BaseFunctionPolicy
      Events:
        DisconnectRoute:
          Type: Api
          Properties:
            ApiId: !Ref GameWebSocketApi
            RouteKey: $disconnect

##########################################################
#              ECS / Fargate GPU Burst Renderer          #
##########################################################
  RenderCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "lq-${Stage}-render-cluster"
      CapacityProviders: ["FARGATE", "FARGATE_SPOT"]

  RenderTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub "lq-${Stage}-render-task"
      Cpu: 4096
      Memory: 8192
      NetworkMode: awsvpc
      RequiresCompatibilities: ["FARGATE"]
      ExecutionRoleArn: !GetAtt RenderTaskRole.Arn
      TaskRoleArn: !GetAtt RenderTaskRole.Arn
      ContainerDefinitions:
        - Name: renderer
          Image: public.ecr.aws/game/render-gpu:latest
          Essential: true
          Environment:
            - Name: SCENE_BUCKET
              Value: !Ref SceneBucket
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Sub "/aws/ecs/lq/${Stage}/render"
              awslogs-region: !Ref "AWS::Region"
              awslogs-stream-prefix: ecs

  RenderTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "lq-${Stage}-render-task-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: s3-access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub "${SceneBucket.Arn}/*"

##########################################################
#                       Outputs                          #
##########################################################
Outputs:
  WebSocketApiEndpoint:
    Description: WSS endpoint for real-time game traffic
    Value: !Sub "wss://${GameWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"

  GameStateTableName:
    Description: DynamoDB table holding entity-component states
    Value: !Ref GameStateTable

  SceneBucketName:
    Description: Scene assets bucket
    Value: !Ref SceneBucket

  EventBusName:
    Description: Internal LedgerQuest event bus
    Value: !Ref EngineEventBus
```