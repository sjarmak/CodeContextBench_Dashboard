```yaml
# ---------------------------------------------------------------------------------
# PaletteStream ETL Canvas â€“ Continuous Integration Pipeline
# File:     build/ci-pipeline.yml
# Purpose:  Compile, test, analyse, package and containerise the solution on
#           every pull-request / push to the default branch.
# ---------------------------------------------------------------------------------

name: CI-${{ github.run_number }}-${{ github.sha }}

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Cancel intermediate runs on the same branch/PR to save CI minutes
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write      # Required for OpenID Connect auth to container registry
  pull-requests: write # Required for comments / coverage status

env:
  SOLUTION_FILE: PaletteStream-ETL-Canvas.sln
  DOTNET_VERSION: '8.0.x'
  DOCKER_IMAGE_NAME: ghcr.io/${{ github.repository }}/palettestream-etl-canvas
  CONFIGURATION: Release
  ARTIFACT_NAME: drop
  COVERAGE_OUTPUT: coverage.opencover.xml

jobs:
# --------------------------------------------------------------------------- #
# LINT â€“ static code formatting check
# --------------------------------------------------------------------------- #
  lint:
    name: Lint ðŸ§¹
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full depth for SonarCloud blame

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        id: nuget-cache
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: dotnet format --verify-no-changes
        run: dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity diagnostic

# --------------------------------------------------------------------------- #
# BUILD + TEST â€“ build against a cross-platform matrix
# --------------------------------------------------------------------------- #
  build-test:
    name: Build & Test ðŸ§ª
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        id: nuget-cache
        with:
          path: ~/.nuget/packages
          key: nuget-${{ matrix.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ matrix.os }}-

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: Test with coverage
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --logger trx \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=opencover \
            /p:CoverletOutput=${{ env.COVERAGE_OUTPUT }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-test-results-${{ matrix.os }}
          path: |
            **/TestResults/*.trx
            **/${{ env.COVERAGE_OUTPUT }}

# --------------------------------------------------------------------------- #
# ANALYSE â€“ SonarCloud static analysis  (Linux only)
# --------------------------------------------------------------------------- #
  analyse:
    name: Static Analysis ðŸ”
    needs: build-test
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-analysis-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-analysis-

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=csharp_data_etl_expert_047
            -Dsonar.organization=palettestream
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.cs.opencover.reportsPaths=**/${{ env.COVERAGE_OUTPUT }}

# --------------------------------------------------------------------------- #
# PACKAGE â€“ produce build artifacts and push container images
# --------------------------------------------------------------------------- #
  package:
    name: Package ðŸ“¦
    needs: analyse
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-package-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-package-

      - name: Publish (self-contained)
        run: |
          dotnet publish src/PaletteStream.ETLCanvas/PaletteStream.ETLCanvas.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --self-contained false \
            --output build/publish

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/PaletteStream.ETLCanvas/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: build/publish

# --------------------------------------------------------------------------- #
# SECURITY â€“ Dependabot + Snyk scanning (nightly)
# --------------------------------------------------------------------------- #
  security-scan:
    name: Security Scan ðŸ”’
    if: ${{ github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    schedule:
      - cron: '0 3 * * *' # Nightly @ 03:00 UTC

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Snyk .NET & Container scan
        uses: snyk/actions/dotnet@v2
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: >
            --file=${{ env.SOLUTION_FILE }} --severity-threshold=high

# --------------------------------------------------------------------------- #
# VERIFY â€“ smoke test container & publish summary
# --------------------------------------------------------------------------- #
  smoke-test:
    name: Smoke Test ðŸš¦
    needs: package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull container image
        run: docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: Run container smoke test
        run: |
          docker run --rm \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -p 5050:8080 \
            --name etl-canvas-test \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} &
          PID=$!
          echo "Container started with PID $PID"
          sleep 20 # Allow service to warm-up
          curl --fail http://localhost:5050/healthz
          docker stop etl-canvas-test

      - name: Report success
        run: echo "Smoke test successful âœ…"

```