{
  "Service": {
    "Name": "PaletteStream.Ingestion",
    "Environment": "Production",
    "Version": "1.0.0",
    "InstanceId": "${HOSTNAME}",
    "StartupTimeoutSeconds": 60
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "SqlMetadata": "Server=tcp:palettestream-metadata.database.windows.net,1433;Initial Catalog=ps_metadata;Persist Security Info=False;User ID=ps_app;Password=${SQL_METADATA_PASSWORD};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;",
    "Hangfire": "Server=tcp:palettestream-jobs.database.windows.net,1433;Initial Catalog=ps_jobs;Persist Security Info=False;User ID=ps_app;Password=${HANGFIRE_PASSWORD};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;",
    "Redis": "${REDIS_CONNECTION_STRING}"
  },
  "Kafka": {
    "BootstrapServers": "kafka-broker-01:9092,kafka-broker-02:9092,kafka-broker-03:9092",
    "SecurityProtocol": "SaslSsl",
    "SaslMechanism": "Plain",
    "SaslUsername": "${KAFKA_USERNAME}",
    "SaslPassword": "${KAFKA_PASSWORD}",
    "Consumer": {
      "Topic": "ps.raw.pigments",
      "DeadLetterTopic": "ps.dlq.ingestion",
      "GroupId": "palettestream.ingestion",
      "AutoOffsetReset": "Earliest",
      "EnableAutoCommit": false,
      "MaxPollIntervalMs": 300000,
      "EnablePartitionEof": false,
      "StatisticsIntervalMs": 60000
    },
    "Producer": {
      "CompressionType": "snappy",
      "DeliveryTimeoutMs": 30000,
      "Acks": "all",
      "LingerMs": 50,
      "BatchSize": 131072,
      "EnableIdempotence": true
    }
  },
  "DataLake": {
    "Provider": "Azure",
    "ConnectionString": "DefaultEndpointsProtocol=https;AccountName=psdatalake;AccountKey=${DATALAKE_KEY};EndpointSuffix=core.windows.net",
    "Containers": {
      "Raw": "raw-zone",
      "Refined": "refined-zone",
      "Curated": "curated-zone"
    },
    "PathTemplate": "{zone}/{yyyy}/{MM}/{dd}/{HH}/{mm}/{source}.parquet",
    "Compression": "ZSTD",
    "MaxBlockSizeMb": 512
  },
  "BatchProcessing": {
    "Enabled": true,
    "Scheduler": "Hangfire",
    "WorkerCount": 4,
    "Queues": [ "critical", "default", "low" ],
    "CronExpressions": {
      "IngestMetadata": "0 */15 * * * *",
      "CleanseDeadLetterQueue": "0 0 */6 * * *",
      "DataQualitySweep": "0 30 2 * * *"
    }
  },
  "DataQuality": {
    "NullCheck": {
      "Enabled": true,
      "Threshold": 0
    },
    "SchemaDrift": {
      "Enabled": true,
      "AlertOnly": true
    },
    "OutlierDetection": {
      "Enabled": true,
      "StdDeviationThreshold": 3
    },
    "DuplicateDetection": {
      "Enabled": true,
      "PrimaryKeyColumns": [ "Id", "SourceSystem" ]
    }
  },
  "Observer": {
    "OpenTelemetry": {
      "EnableTracing": true,
      "EnableMetrics": true,
      "OtlpExporterEndpoint": "http://otel-collector:4317",
      "SamplingRatio": 1.0
    },
    "Prometheus": {
      "ScrapeEndpoint": "/metrics",
      "EnableHttpListener": true
    },
    "Alerting": {
      "PagerDuty": {
        "IntegrationKey": "${PAGERDUTY_KEY}",
        "SeverityThreshold": "error"
      }
    }
  },
  "RetryPolicy": {
    "MaxRetryAttempts": 5,
    "ExponentialBackoff": {
      "BaseDelaySeconds": 2,
      "MaxDelaySeconds": 60
    },
    "HandleTransientHttpErrorCodes": [ 408, 500, 502, 503, 504 ]
  },
  "CircuitBreaker": {
    "FailureThreshold": 0.5,
    "MinimumThroughput": 20,
    "SamplingDurationSeconds": 120,
    "DurationOfBreakSeconds": 30
  },
  "Serilog": {
    "Using": [ "Serilog.Sinks.Console", "Serilog.Sinks.File", "Serilog.Sinks.Seq" ],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Error"
      }
    },
    "Enrich": [ "FromLogContext", "WithThreadId", "WithMachineName" ],
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {SourceContext} {Message:lj}{NewLine}{Exception}"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/palettestream/ingestion-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30,
          "fileSizeLimitBytes": 104857600
        }
      },
      {
        "Name": "Seq",
        "Args": {
          "serverUrl": "http://seq:5341",
          "apiKey": "${SEQ_API_KEY}"
        }
      }
    ]
  },
  "Http": {
    "UseHttpsRedirection": true,
    "MaxRequestBodySize": 104857600,
    "EnableForwardedHeaders": true
  },
  "Metrics": {
    "EnablePrometheusExporter": true,
    "EnableInfluxDbExporter": false
  },
  "FeatureFlags": {
    "EnableGpuAcceleration": false,
    "EnableRealtimePreview": true,
    "EnableSchemaInference": true
  },
  "Policies": {
    "MaxConcurrentStreams": 16,
    "MaxBatchSize": 104857600,
    "GracefulShutdownTimeoutSeconds": 90
  }
}