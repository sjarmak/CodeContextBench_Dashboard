{
  "$schema": "https://json.schemastore.org/appsettings.json",

  "Service": {
    "Name": "PaletteStream.ApiGateway",
    "Version": "1.0.0",
    "Environment": "Production",

    "Telemetry": {
      "OpenTelemetry": {
        "Enabled": true,
        "OtlpEndpoint": "http://otel-collector:4317",
        "SamplingRatio": 0.25,
        "ExportLogs": true,
        "ExportMetrics": true,
        "ExportTraces": true
      }
    }
  },

  "Http": {
    "Port": 8080,

    "Cors": {
      "AllowedOrigins": [
        "https://studio.palettestream.io",
        "https://dashboards.palettestream.io"
      ],
      "AllowedHeaders": [
        "Content-Type",
        "X-Requested-With",
        "Authorization",
        "X-Correlation-ID"
      ],
      "AllowedMethods": [
        "GET",
        "POST",
        "PUT",
        "PATCH",
        "DELETE",
        "OPTIONS"
      ],
      "AllowCredentials": true
    },

    "RateLimiting": {
      "Enabled": true,
      "RequestsPerMinute": 6000,
      "Whitelist": [
        "127.0.0.1",
        "::1"
      ]
    }
  },

  "Authentication": {
    "JwtBearer": {
      "Authority": "https://login.palettestream.io/",
      "Audience": "palettestream-api",
      "RequireHttpsMetadata": true,
      "ClockSkewSeconds": 60,
      "CacheDurationMinutes": 30
    }
  },

  "ReverseProxy": {
    "Routes": {
      "pipeline": {
        "ClusterId": "etl-pipeline",
        "Match": {
          "Path": "/pipeline/{**catch-all}"
        },
        "Transforms": [
          {
            "PathRemovePrefix": "/pipeline"
          }
        ]
      },
      "visualization": {
        "ClusterId": "visualization",
        "Match": {
          "Path": "/viz/{**catch-all}"
        },
        "Transforms": [
          {
            "PathRemovePrefix": "/viz"
          }
        ]
      }
    },

    "Clusters": {
      "etl-pipeline": {
        "Destinations": {
          "primary": { "Address": "http://etl-pipeline:5000/" }
        },
        "HealthCheck": {
          "Active": {
            "Path": "/health",
            "Interval": "00:00:10"
          }
        }
      },
      "visualization": {
        "Destinations": {
          "primary": { "Address": "http://viz-service:6000/" }
        },
        "HealthCheck": {
          "Passive": {
            "Policy": "ConsecutiveFailures",
            "ReactivationPeriod": "00:05:00"
          }
        }
      }
    }
  },

  "Kafka": {
    "BootstrapServers": "kafka:29092",
    "SchemaRegistry": {
      "Url": "http://schema-registry:8081",
      "AutoRegisterSchemas": false
    },
    "Security": {
      "SaslMechanism": "PLAIN",
      "SaslUsername": "__KAFKA_USER__",
      "SaslPassword": "__KAFKA_PASSWORD__",
      "SslCaLocation": "/etc/ssl/certs"
    },
    "Consumer": {
      "GroupId": "palettestream.gateway",
      "EnableAutoCommit": false,
      "AutoOffsetReset": "latest",
      "SessionTimeoutMs": 6000
    },
    "Producer": {
      "EnableIdempotence": true,
      "CompressionType": "lz4",
      "MessageSendMaxRetries": 3,
      "LingerMs": 20,
      "BatchSize": 65536
    }
  },

  "Hangfire": {
    "ServerName": "palette-etl-hangfire",
    "DashboardPath": "/jobs",
    "Queues": [ "default" ],
    "WorkerCount": 20,
    "Storage": {
      "Provider": "postgres",
      "ConnectionString": "Host=postgres;Port=5432;Database=hangfire;Username=hangfire;Password=__HANGFIRE_DB_PASSWORD__",
      "Schema": "hangfire"
    }
  },

  "Serilog": {
    "Using": [
      "Serilog.Sinks.Console",
      "Serilog.Sinks.Elasticsearch"
    ],

    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },

    "Enrich": [
      "FromLogContext",
      "WithMachineName",
      "WithThreadId",
      "WithCorrelationId"
    ],

    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "Elasticsearch",
        "Args": {
          "nodeUris": "http://elasticsearch:9200",
          "indexFormat": "gateway-logs-{0:yyyy.MM.dd}",
          "autoRegisterTemplate": true,
          "templateName": "gateway-log-template",
          "numberOfShards": 2,
          "numberOfReplicas": 1
        }
      }
    ]
  },

  "DataLake": {
    "Buckets": {
      "Raw": "s3://palettestream-raw",
      "Refined": "s3://palettestream-refined",
      "Curated": "s3://palettestream-curated"
    },
    "Credentials": {
      "AccessKey": "__S3_ACCESS_KEY__",
      "SecretKey": "__S3_SECRET_KEY__"
    },
    "Region": "us-east-1",
    "MultipartUpload": {
      "PartSizeMb": 128,
      "Parallelism": 4
    }
  },

  "FeatureManagement": {
    "data_visualization": true,
    "monitoring": true,
    "data_quality_checks": true,
    "data_validation": true,
    "data_ingestion": true
  },

  "HealthChecksUI": {
    "HealthChecks": [
      {
        "Name": "API Gateway",
        "Uri": "http://localhost:8080/health"
      },
      {
        "Name": "Kafka Broker",
        "Uri": "http://kafka:29092/health"
      },
      {
        "Name": "ETL Pipeline Service",
        "Uri": "http://etl-pipeline:5000/health"
      },
      {
        "Name": "Visualization Service",
        "Uri": "http://viz-service:6000/health"
      }
    ],
    "EvaluationTimeOnSeconds": 30,
    "MinimumSecondsBetweenFailureNotifications": 60,
    "WebhookNotification": {
      "Uri": "https://hooks.palettestream.io/notify",
      "Payload": "{ \"text\": \"{{FAILURE}}\" }",
      "RestoredPayload": "{ \"text\": \"{{RECOVERY}}\" }"
    }
  },

  "AllowedHosts": "*"
}