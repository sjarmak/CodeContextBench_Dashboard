# GitHub Actions workflow for building, testing, packaging, and releasing
# the FlockDesk desktop application.
#
# Trigger:
#   â€¢ On every tag that begins with "v" (e.g., v1.2.3)
#   â€¢ Manual dispatch via the GitHub UI
#
# Matrix:
#   â€¢ Operating Systems: Ubuntu, Windows, macOS
#   â€¢ Python: 3.10 (single source of truth for runtime; adjust as needed)
#
# Key features:
#   â€¢ Sub-module checkout (plugins live in sub-repos)
#   â€¢ Dependency caching
#   â€¢ Linting & type-checking (ruff + mypy)
#   â€¢ PyTest with coverage upload to Codecov
#   â€¢ PyInstaller packaging for each OS
#   â€¢ Artifact upload (per-OS ZIP bundles)
#   â€¢ Automated changelog extraction (Keep-a-Changelog)
#   â€¢ Draft (or published) GitHub release with binaries attached
#
# Preconditions:
#   â€¢ CODECOV_TOKEN secret (for coverage uploadsâ€”optional)
#   â€¢ GH_PAT or default GITHUB_TOKEN (for GH release uploads)
#   â€¢ macOS cross-signing certificates (if notarization is desired)
#
# Notes:
#   â€¢ Step-level conditional execution keeps Linux-specific steps segregated.
#   â€¢ A single failure in any matrix node fails the entire release gate.
#   â€¢ 'concurrency' ensures only one release job runs per ref.
name: Release

on:
  push:
    tags:
      - "v*.*.*"        # Semantic version tags trigger release
  workflow_dispatch:     # Manual trigger

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  # Centralised build output directory (overridden per-OS as needed)
  DIST_DIR: dist

jobs:
  build-test-package:
    name: Build âžœ Test âžœ Package (${{ matrix.os }}, py${{ matrix.python }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ["3.10"]

    steps:
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Checkout source (incl. sub-modules)
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0   # full history for changelog generation

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Setup Python toolchain
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: "pip"

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # OS-specific system dependencies (Qt / PySide6)
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install system libs (Linux/PySide6)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libpulse0 \
            libglu1-mesa

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Install Python dependencies
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Static analysis: linters & type checkers
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Lint with ruff
        run: ruff check flockdesk

      - name: Type-check with mypy
        run: mypy flockdesk

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Execute unit tests
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run test suite
        run: |
          pytest --color=yes --cov=flockdesk --cov-report=xml --cov-report=term

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload coverage to Codecov (optional)
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
        continue-on-error: true   # Non-critical

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build stand-alone binaries via PyInstaller
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Inject build metadata
        shell: bash
        run: |
          echo "__version__ = '${{ github.ref_name }}'" > flockdesk/_version.py

      - name: Package application with PyInstaller
        shell: bash
        run: |
          pyinstaller \
            --noconfirm \
            --clean \
            --name FlockDesk \
            --windowed \
            --add-data "flockdesk/resources${{ runner.os == 'Windows' && ';' || ':' }}flockdesk/resources" \
            flockdesk/__main__.py

      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Compress & upload artifacts
      #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Compress distributable
        shell: bash
        run: |
          cd "$DIST_DIR"
          ARCHIVE="FlockDesk-${{ github.ref_name }}-${{ runner.os }}.zip"
          zip -r "$ARCHIVE" FlockDesk/
          mv "$ARCHIVE" ../
          echo "ARCHIVE_NAME=$ARCHIVE" >> $GITHUB_ENV

      - name: Publish build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_NAME }}
          retention-days: 14

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Draft (or publish) GitHub release with assets
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-release:
    name: Create GitHub Release
    needs: build-test-package
    runs-on: ubuntu-latest
    if: success()

    steps:
      # Aggregate artifacts from matrix
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      # Generate changelog section for this tag
      - name: Extract changelog entry
        id: changelog
        uses: thomaseizinger/keep-a-changelog-new-release@v3
        with:
          version: ${{ github.ref_name }}

      # Create or update the GitHub Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: FlockDesk ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false            # Set to true if manual review is desired
          files: |
            dist/**/FlockDesk-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # (Optional) Notify internal Slack/Discord channels about the release
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1.25.0
      #   with:
      #     payload: |
      #       {
      #         "text": "ðŸŽ‰ FlockDesk ${{ github.ref_name }} has been released!"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}