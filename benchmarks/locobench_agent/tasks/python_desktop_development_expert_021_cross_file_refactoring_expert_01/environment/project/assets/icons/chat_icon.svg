```python
"""
FlockDesk – Chat Icon Provider
==============================

This module exposes a thin, convenience-oriented wrapper that lazily
converts an *embedded* SVG chat bubble into a `QIcon`, optionally re-tinting
it to match the active application palette (light / dark / branded themes).

The SVG payload is inlined so that the icon is distributable as a single
Python module (no resource file required) and remains fully functional in
frozen deployments (PyInstaller, cx_Freeze, etc.).

Path in repository:
    assets/icons/chat_icon.svg      ← kept for backwards-compat, but now Python.

Public API:
    get_chat_icon(size: int | QSize = 16, *, color: QColor | str | None = None) -> QIcon
"""

from __future__ import annotations

import base64
import functools
import logging
from pathlib import Path
from typing import Final, Optional, Union

from PySide6.QtCore import QByteArray, QBuffer, QIODevice, QSize, Qt
from PySide6.QtGui import QColor, QIcon, QPainter, QPixmap
from PySide6.QtSvg import QSvgRenderer

_LOGGER: Final = logging.getLogger(__name__)


# ────────────────────────────────────────────────────────────────────────────────
# Embedded SVG payload
# The asset is base64-encoded to avoid accidental mangling by Python formatters.
# ▶ To update the icon: replace SVG_CONTENT with new data & run `encode_svg.py`.
# ────────────────────────────────────────────────────────────────────────────────
_SVG_BASE64: Final[str] = (
    "PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3Ln"
    "czLm9yZy8yMDAwL3N2ZyI+PHRpdGxlPk1lc3NhZ2U8L3RpdGxlPjxnIGZpbGwtb"
    "3BhY2l0eT0iMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjEuNSIg"
    "ZmlsbD0ibm9uZSI+PHBhdGggZD0iTTEyIDIuNUM3LjU4IDIuNSAzLjUgNS4yMyA"
    "zLjUgOC40NXY2LjA5YzAgMi4zNiAyLjMxIDQuMjYgNS40NyA0Ljczdi40N2MwIC"
    "40OS4zNTIuODguODcuODguMTQ1IDAgLjI5MS0uMDIuNDMtLjA3bDMuNTQtMS4zM"
    "2gxLjIyYzQuNDIgMCA4LjUtMi43MyA4LjUtNi4wN1Y4LjQ1QzIwLjUgNS4yMyAx"
    "Ni40MiAyLjUgMTIgMi41eiIvPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTEuNSIgcj0"
    "iMS4zIi8+PGNpcmNsZSBjeD0iOC4yIiBjeT0iMTEuNSIgcj0iMS4zIi8+PGNpcm"
    "NsZSBjeD0iMTUuOCIgY3k9IjExLjUiIHI9IjEuMyIvPjwvZz48L3N2Zz4="
)


def _decode_svg_payload() -> QByteArray:
    """
    Decode the base64-encoded SVG asset into a QByteArray.

    This keeps the decoded version out of the module’s global scope,
    minimising import-time overhead.
    """
    try:
        raw_bytes = base64.b64decode(_SVG_BASE64)
        return QByteArray(raw_bytes)
    except (base64.binascii.Error, ValueError) as exc:  # pragma: no cover
        # Hard-fail only during development; in production return an empty asset
        #     to avoid crashing the whole client because of a single icon.
        _LOGGER.exception("Failed to decode embedded chat SVG: %s", exc)
        return QByteArray()


# ────────────────────────────────────────────────────────────────────────────────
# Core API
# ────────────────────────────────────────────────────────────────────────────────
SizeArg = Union[int, QSize]


@functools.lru_cache(maxsize=128)
def _render_svg_to_pixmap(
    size: QSize,
    *,
    color: Optional[QColor] = None,
) -> QPixmap:
    """
    Rasterise the embedded SVG to a `QPixmap`.

    Args
    ----
    size:
        The requested icon *outer* size (width == height).
    color:
        Optional tint to apply to the stroke & fill. Accepts Qt color names
        ("red"), hex strings ("#ffaa00"), or `QColor`. If `None`, the SVG keeps
        its intrinsic colour (currentColor).
    """
    # Lazily load renderer — retains internal caching for subsequent calls
    renderer = QSvgRenderer(_decode_svg_payload())

    # Prepare target pixmap
    pixmap = QPixmap(size)
    pixmap.fill(Qt.GlobalColor.transparent)

    # Paint SVG
    painter = QPainter(pixmap)
    try:
        if color:
            # Override currentColor by setting painter pen & brush
            q_color = QColor(color)
            painter.setPen(q_color)
            painter.setBrush(q_color)

        renderer.render(painter)
    finally:
        painter.end()

    return pixmap


def get_chat_icon(
    size: SizeArg | None = 20,
    *,
    color: Optional[Union[QColor, str]] = None,
) -> QIcon:
    """
    Return the chat *bubble* icon as a `QIcon`.

    The icon is memoised internally — identical `(size, color)` pairs
    will be returned from cache on subsequent calls.

    Parameters
    ----------
    size:
        Either an `int` (square icon) or a `QSize`. Omitting the argument
        (or passing `None`) yields the SVG’s natural size.
    color:
        Optional tint for theming. Omitting keeps original / inheritable
        `currentColor`.
    """

    if size is None:
        qsize = QSize()  # null size → "natural" SVG dimension
    elif isinstance(size, QSize):
        qsize = size
    else:
        qsize = QSize(int(size), int(size))

    if qsize.isEmpty():
        # Fallback to a sensible default if SVG has no size metadata
        qsize = QSize(20, 20)

    # Use string representation of QColor in cache key to avoid unhashable type
    cache_key = (qsize.width(), qsize.height(), str(color) if color else None)

    @functools.lru_cache(maxsize=128)
    def _build_icon(_cache_key):  # noqa: D401 - nested for cache
        pm = _render_svg_to_pixmap(qsize, color=color)
        icon = QIcon(pm)
        return icon

    return _build_icon(cache_key)


# ────────────────────────────────────────────────────────────────────────────────
# CLI helper (dev-only): dump icon to PNG for sanity checks
# ────────────────────────────────────────────────────────────────────────────────
def _dump_png(
    path: str | Path,
    *,
    size: int = 48,
    color: str | QColor | None = None,
) -> None:  # pragma: no cover
    """
    Save the rendered icon as a PNG for offline inspection / documentation.
    """
    qsize = QSize(size, size)
    pixmap = _render_svg_to_pixmap(qsize, color=color)
    ok = pixmap.save(str(path), "PNG")
    if not ok:  # pragma: no cover
        raise IOError(f"Failed to save PNG to {path}")


# ────────────────────────────────────────────────────────────────────────────────
# Unit-like smoke test
# ────────────────────────────────────────────────────────────────────────────────
if __name__ == "__main__":  # pragma: no cover
    # Only run if module executed directly (e.g. `python chat_icon.svg`)
    logging.basicConfig(level=logging.DEBUG)
    out = Path(__file__).with_suffix(".png")
    _dump_png(out, size=64, color="#4caf50")
    print(f"Exported chat icon → {out.resolve()}")
```