"""flockdesk/core/theming/themes/light_theme.qss

Light Theme stylesheet generator for FlockDesk.

This module ships a fully-fledged Qt Style Sheet (QSS) for the light variant of
the FlockDesk design system.  The style sheet is generated at run-time instead
of being shipped as a static *.qss resource so that we can (a) inject a user
selected accent colour on the fly and (b) roll out palette updates across the
entire application without having to distribute a new resource file to each
micro-front-end.

Example
-------
>>> from PySide6.QtWidgets import QApplication
>>> from flockdesk.core.theming.themes.light_theme import apply_to
>>> app = QApplication([])
>>> apply_to(app, accent_color="#ff4081")
>>> # ... show some widgets ...
"""

from __future__ import annotations

import functools
import re
from dataclasses import dataclass, asdict
from typing import Dict, Final

try:
    # In production these are available from the FlockDesk codebase.
    from flockdesk.core.logging import get_logger
    from flockdesk.core.theming.exceptions import InvalidColorError
except ModuleNotFoundError:  # pragma: no cover  – fallback for standalone linting
    import logging

    def get_logger(name: str) -> logging.Logger:  # type: ignore
        logger = logging.getLogger(name)
        if not logger.handlers:
            logging.basicConfig(level=logging.INFO)
        return logger

    class InvalidColorError(RuntimeError):  # type: ignore
        """Raised when a user provided colour string is not a valid hex."""

from PySide6.QtGui import QColor, QPalette
from PySide6.QtWidgets import QApplication

__all__ = [
    "LightPalette",
    "render_qss",
    "apply_to",
]

_LOG = get_logger(__name__)

_HEX_COLOR_RE: Final[re.Pattern[str]] = re.compile(r"^#(?:[0-9a-fA-F]{3}){1,2}$")


@dataclass(frozen=True, slots=True)
class LightPalette:
    """Central colour palette for the light theme.

    All colours are full 6-digit, lowercase hex values.
    """
    background: str = "#fafafa"
    foreground: str = "#202124"
    secondary_text: str = "#5f6368"
    disabled_text: str = "#9aa0a6"
    border: str = "#dadce0"
    selection: str = "#e8f0fe"
    selection_text: str = "#202124"
    accent: str = "#1a73e8"  # Default accent (Google Blue 600)
    accent_hover: str = "#1765cc"
    accent_pressed: str = "#0b57d0"

    def with_accent(self, accent: str) -> "LightPalette":
        """Return a new palette that uses *accent* as its base accent colour."""
        accent = accent.lower()
        if not _HEX_COLOR_RE.match(accent):
            raise InvalidColorError(f"Invalid hex colour: {accent!r}")

        # Derive hover/pressed colours by adjusting luminance.
        base = QColor(accent)
        hover = _adjust_color_luminance(base, 0.9)
        pressed = _adjust_color_luminance(base, 0.8)
        return LightPalette(
            background=self.background,
            foreground=self.foreground,
            secondary_text=self.secondary_text,
            disabled_text=self.disabled_text,
            border=self.border,
            selection=self.selection,
            selection_text=self.selection_text,
            accent=accent,
            accent_hover=hover,
            accent_pressed=pressed,
        )


def _adjust_color_luminance(color: QColor, factor: float) -> str:
    """Brighten/darken *color* by *factor* (0-1 = darker, >1 = brighter)."""
    h, s, v, a = color.getHsvF()
    v = max(0, min(1, v * factor))
    c = QColor.fromHsvF(h, s, v, a)
    return c.name(QColor.HexRgb)


_QSS_TEMPLATE: Final[str] = r"""
/* --=== FlockDesk Light Theme ===-- */

/* Top-level colours
   ================= */
* {{
    /* Do not use these in actual Qt style sheet rules – only for python side
       interpolation.  They are replaced before the QSS reaches Qt. */
    /* background: {background}; */
}}

QWidget {{
    background-color: {background};
    color: {foreground};
    selection-background-color: {selection};
    selection-color: {selection_text};
}}

QToolTip {{
    background-color: {foreground};
    color: {background};
    border: 1px solid {border};
}}

QPushButton {{
    background-color: {accent};
    border: 1px solid {accent};
    border-radius: 3px;
    padding: 4px 10px;
    color: #fff;
}}
QPushButton:hover {{
    background-color: {accent_hover};
    border-color: {accent_hover};
}}
QPushButton:pressed {{
    background-color: {accent_pressed};
    border-color: {accent_pressed};
}}
QPushButton:disabled {{
    background-color: {border};
    border-color: {border};
    color: {disabled_text};
}}

QLineEdit, QTextEdit, QPlainTextEdit {{
    background-color: #ffffff;
    border: 1px solid {border};
    border-radius: 3px;
    padding: 2px;
}}
QLineEdit:focus, QTextEdit:focus, QPlainTextEdit:focus {{
    border-color: {accent};
}}

QTabBar::tab {{
    background: transparent;
    padding: 6px 12px;
    border: 1px solid {border};
    border-bottom: none;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    color: {secondary_text};
}}
QTabBar::tab:selected {{
    background: #ffffff;
    color: {foreground};
    border-color: {border};
    border-bottom: 1px solid #ffffff;
}}

QScrollBar:vertical {{
    background: transparent;
    width: 10px;
    margin: 0px 0px 0px 0px;
}}
QScrollBar::handle:vertical {{
    background: {border};
    border-radius: 4px;
}}
QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{
    height: 0;
    subcontrol-position: none;
}}

QCheckBox::indicator {{
    width: 16px;
    height: 16px;
}}
QCheckBox::indicator:unchecked {{
    border: 1px solid {border};
    background: #ffffff;
    border-radius: 2px;
}}
QCheckBox::indicator:checked {{
    image: none;
    background: {accent};
    border-radius: 2px;
}}
"""


def _render_template(palette: LightPalette) -> str:
    """Render the raw QSS template using *palette*."""
    mapping: Dict[str, str] = asdict(palette)
    return _QSS_TEMPLATE.format(**mapping)


# --------------------------------------------------------------------------- #
# Public helpers
# --------------------------------------------------------------------------- #

@functools.lru_cache(maxsize=8)
def render_qss(accent_color: str | None = None) -> str:
    """Return a fully rendered QSS string for the light theme.

    The result is cached – repeated calls with the same *accent_color* do not
    hit the template renderer again.

    Parameters
    ----------
    accent_color:
        Optional hex colour (e.g. "#ff4081") that overrides the default accent.
    """
    _LOG.debug("Rendering light theme QSS (accent=%s)", accent_color)

    palette = LightPalette()
    if accent_color is not None:
        palette = palette.with_accent(accent_color)

    qss = _render_template(palette)

    # As a sanity check ensure that no placeholders are left in the output.
    leftover = re.findall(r"{\w+}", qss)
    if leftover:
        raise RuntimeError(
            f"Unresolved placeholders in rendered QSS: {', '.join(leftover)}"
        )

    return qss


def apply_to(app: QApplication, accent_color: str | None = None) -> None:
    """Apply the light theme QSS to *app* and update the palette.

    Only call this from the GUI thread.

    Parameters
    ----------
    app:
        The QApplication instance to which the theme should be applied.
    accent_color:
        Optional custom accent colour (hex string).
    """
    qss = render_qss(accent_color)

    _LOG.info("Applying light theme to QApplication (accent=%s)", accent_color)
    app.setStyleSheet(qss)

    # Update QPalette so that widgets which use QPalette roles instead of
    # explicit QSS values still follow the theme.  This covers custom/3rd-party
    # widgets and certain complex controls (e.g. QSyntaxHighlighter).
    palette = QPalette()

    p = LightPalette() if accent_color is None else LightPalette().with_accent(accent_color)
    palette.setColor(QPalette.Window, QColor(p.background))
    palette.setColor(QPalette.WindowText, QColor(p.foreground))
    palette.setColor(QPalette.Base, QColor("#ffffff"))
    palette.setColor(QPalette.AlternateBase, QColor(p.selection))
    palette.setColor(QPalette.ToolTipBase, QColor(p.foreground))
    palette.setColor(QPalette.ToolTipText, QColor(p.background))
    palette.setColor(QPalette.Text, QColor(p.foreground))
    palette.setColor(QPalette.Button, QColor(p.accent))
    palette.setColor(QPalette.ButtonText, QColor("#ffffff"))
    palette.setColor(QPalette.Link, QColor(p.accent))
    palette.setColor(QPalette.Disabled, QPalette.Text, QColor(p.disabled_text))
    palette.setColor(QPalette.Disabled, QPalette.ButtonText, QColor(p.disabled_text))

    app.setPalette(palette)

    _LOG.debug("Light theme applied successfully.")
