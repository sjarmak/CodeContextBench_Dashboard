# ---------------------------------------------------------------------------
# FlockDesk – Social Workspace Orchestrator
# Logging configuration (Python logging.config.fileConfig compatible).
#
# This file follows the INI schema expected by `logging.config.fileConfig`.
# It is designed for both development and production usage:
#   • The console handler prints coloured, human-readable output during dev.
#   • Timed/size rotating files capture INFO and ERROR level diagnostics.
#   • A Sentry handler forwards WARNING+ events to Sentry (when DSN set).
#
# Environment variable interpolation is supported via ConfigParser defaults.
#
#   export FD_LOG_LEVEL=DEBUG        # overrides the default root level
#   export FD_LOG_DIR=/var/log/flockdesk
#   export SENTRY_DSN=<dsn>          # enables Sentry handler
#
# NOTE:
#   • Any custom filters / handlers referenced below MUST be importable
#     before `logging.config.fileConfig` is called.
#   • For colours install `colorlog`:  pip install colorlog
# ---------------------------------------------------------------------------

[DEFAULT]
# Fallback values; can be overridden by environment variables of the same name.
FD_LOG_LEVEL       = INFO
FD_LOG_DIR         = ./logs
FD_ROTATION_WHEN   = midnight
FD_ROTATION_COUNT  = 14

##############################################################################
# Formatters
##############################################################################
[formatters]
keys = color, detailed, json

[formatter_color]
class           = colorlog.ColoredFormatter
format          = %(log_color)s[%(asctime)s] [%(levelname)8s] [%(name)s]  \
                  (%(threadName)s) %(message)s
datefmt         = %Y-%m-%d %H:%M:%S
()              = colorlog.ColoredFormatter
# log_colors requires keyword args, but config parser treats them as options.
# Use key=value pairs understood by colorlog (case-sensitive).
log_colors      =   
    DEBUG    reset
    INFO     bold_green
    WARNING  bold_yellow
    ERROR    bold_red
    CRITICAL bold_purple

[formatter_detailed]
class           = logging.Formatter
format          = [%(asctime)s] [%(levelname)8s] [%(name)s] \
                  {%('session_id' in vars(self) and session_id or '-')} \
                  %(filename)s:%(lineno)d ▶ %(message)s
datefmt         = %Y-%m-%d %H:%M:%S

[formatter_json]
# Requires python-json-logger
class           = pythonjsonlogger.jsonlogger.JsonFormatter
format          = %(asctime)s %(levelname)s %(name)s %(message)s \
                  %(session_id)s %(user_id)s
datefmt         = %Y-%m-%dT%H:%M:%S

##############################################################################
# Filters
##############################################################################
[filters]
keys = context

[filter_context]
()              = flockdesk.core.logging.ContextFilter
# The above custom filter injects `session_id`, `user_id`, and
# `correlation_id` into LogRecord instances for better traceability.

##############################################################################
# Handlers
##############################################################################
[handlers]
keys = console, file_info, file_error, sentry

[handler_console]
class           = logging.StreamHandler
level           = %(FD_LOG_LEVEL)s
formatter       = color
args            = (sys.stdout,)
filters         = context

[handler_file_info]
class           = logging.handlers.TimedRotatingFileHandler
level           = INFO
formatter       = detailed
args            = ('%(FD_LOG_DIR)s/flockdesk_info.log',
                   '%(FD_ROTATION_WHEN)s',
                   1,
                   %(FD_ROTATION_COUNT)s,
                   'utf-8')
encoding        = utf-8
delay           = True
filters         = context

[handler_file_error]
class           = logging.handlers.RotatingFileHandler
level           = ERROR
formatter       = detailed
args            = ('%(FD_LOG_DIR)s/flockdesk_error.log',
                   'a',
                   1048576,     # 1 MiB
                   10,
                   'utf-8')
encoding        = utf-8
delay           = True
filters         = context

[handler_sentry]
# Only initialised if SENTRY_DSN is defined (handled in application bootstrap).
class           = sentry_sdk.integrations.logging.EventHandler
level           = WARNING
formatter       = json
# sentry_sdk's EventHandler expects no args; ConfigParser still wants tuple.
args            = ()
filters         = context

##############################################################################
# Loggers
##############################################################################
[loggers]
keys = root, flockdesk, event_bus, plugin_manager, gui, qt

[logger_root]
level           = %(FD_LOG_LEVEL)s
handlers        = console, file_info, file_error, sentry

[logger_flockdesk]
qualname        = flockdesk
level           = DEBUG
handlers        = 
propagate       = 1

[logger_event_bus]
qualname        = flockdesk.event_bus
level           = INFO
handlers        = 
propagate       = 1

[logger_plugin_manager]
qualname        = flockdesk.plugin
level           = INFO
handlers        = 
propagate       = 1

[logger_gui]
qualname        = flockdesk.gui
level           = INFO
handlers        = 
propagate       = 1

[logger_qt]
qualname        = Qt
level           = WARNING
handlers        = 
propagate       = 0   # Prevent double-logging Qt messages through root

# End of logging.conf
