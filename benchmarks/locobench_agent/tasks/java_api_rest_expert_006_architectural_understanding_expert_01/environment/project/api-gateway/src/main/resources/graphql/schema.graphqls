"""
OpsForge Utility Nexus – GraphQL Schema (v1)

This schema exposes a façade over the heterogeneous micro-utilities that power
OpsForge.  It follows Relay-style pagination, includes coarse-grained error
handling via the ApiError union, and comes with directives to aid the API
gateway in response-caching and rate-limiting.

NOTE:
  • All mutations return a union of <ResultType> | ApiError so that clients
    can branch on the concrete response type without relying on the GraphQL
    “errors” array alone.
  • Every paginated query returns a <Connection> wrapper that contains
    <Edge>, nodes, and a relay-compatible PageInfo object.
"""

# -------------------------------------------------------------
#  Scalars
# -------------------------------------------------------------
scalar DateTime          # RFC-3339 timestamp with TZ
scalar JSON              # Arbitrary JSON object, encoded as a Map
scalar Upload            # Multipart file upload (per GraphQL multipart spec)

# -------------------------------------------------------------
#  Directives
# -------------------------------------------------------------
directive @cacheControl(
  "Max-age in seconds"
  maxAge : Int! = 60,

  "PRIVATE or PUBLIC"
  scope  : CacheControlScope! = PUBLIC
) on FIELD_DEFINITION | OBJECT

enum CacheControlScope {
  PUBLIC
  PRIVATE
}

directive @rateLimit(
  "Maximum number of invocations per window"
  limit   : Int!,

  "Length of the window in seconds"
  window  : Int!,

  "Unique identifier for the bucket; defaults to caller IP if omitted"
  identityArg : String = ""
) on FIELD_DEFINITION

# -------------------------------------------------------------
#  Pagination
# -------------------------------------------------------------
input PageInput {
  first  : Int
  after  : String
  last   : Int
  before : String
}

type PageInfo {
  hasNextPage     : Boolean!
  hasPreviousPage : Boolean!
  startCursor     : String
  endCursor       : String
}

# -------------------------------------------------------------
#  Common Types & Enums
# -------------------------------------------------------------
enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELED
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

type ApiError {
  code      : String!        # Machine-readable error code
  message   : String!        # Human-readable description
  severity  : ErrorSeverity!
  debugId   : ID             # Correlates with server logs/trace-ids
  details   : JSON           # Arbitrary extra context
}

"""
Union wrapper used by most mutations/queries that can return either
a domain object or ApiError.
"""
union UtilityResponse<T> = T | ApiError

# -------------------------------------------------------------
#  Interface: Job
# -------------------------------------------------------------
interface Job {
  id         : ID!
  status     : JobStatus!
  createdAt  : DateTime!
  updatedAt  : DateTime!
}

# -------------------------------------------------------------
#  1) File Conversion
# -------------------------------------------------------------
enum FileFormat {
  PDF
  DOCX
  XLSX
  CSV
  JSON
  XML
  TXT
  MARKDOWN
  PNG
  JPEG
  ZIP
  TAR
  UNKNOWN
}

type FileConversionJob implements Job @cacheControl(maxAge: 5, scope: PRIVATE) {
  id          : ID!
  status      : JobStatus!
  createdAt   : DateTime!
  updatedAt   : DateTime!

  sourceUri   : String!
  targetUri   : String
  sourceFormat: FileFormat!
  targetFormat: FileFormat!
  progress    : Float!      # 0.0 – 1.0
  message     : String
}

input FileConversionRequest {
  file        : Upload!
  targetFormat: FileFormat!
  callbackUrl : String
}

type FileConversionJobEdge {
  cursor : String!
  node   : FileConversionJob!
}

type FileConversionJobConnection {
  edges    : [FileConversionJobEdge!]!
  nodes    : [FileConversionJob!]!
  pageInfo : PageInfo!
}

# -------------------------------------------------------------
#  2) Checksum Generation
# -------------------------------------------------------------
enum ChecksumAlgorithm {
  MD5
  SHA1
  SHA256
  SHA512
  CRC32
}

type ChecksumResult @cacheControl(maxAge: 31536000, scope: PUBLIC) {
  algorithm : ChecksumAlgorithm!
  checksum  : String!     # Hex-encoded digest
  length    : Int!        # Length in bytes
}

# -------------------------------------------------------------
#  3) Data Anonymization
# -------------------------------------------------------------
type AnonymizationFieldStat {
  fieldName        : String!
  originalExamples : [String!]!   # Sample before anonymization
  anonymizedSample : [String!]!   # Sample after anonymization
}

type AnonymizationResult {
  originalSize    : Int!     # Bytes
  anonymizedSize  : Int!
  fieldsAnonymized: Int!
  stats           : [AnonymizationFieldStat!]!
  uri             : String   # Location of anonymized file, if persisted
}

input AnonymizeDataRequest {
  file          : Upload!
  strategy      : String = "DEFAULT"   # e.g., "GDPR", "HIPAA"
  preserveKeys  : Boolean = false
  salt          : String
}

# -------------------------------------------------------------
#  4) Time-Zone Aware Scheduling
# -------------------------------------------------------------
input ScheduleTaskRequest {
  cronExpression : String!      # Standard CRON (Quartz) expression
  timeZone       : String!      # IANA TZ database name, e.g., "America/New_York"
  payload        : JSON!        # Arbitrary payload forwarded on execution
  maxRetries     : Int  = 0
}

type ScheduledTask implements Job {
  id          : ID!
  status      : JobStatus!
  createdAt   : DateTime!
  updatedAt   : DateTime!
  cronExpression: String!
  timeZone    : String!
  nextRunAt   : DateTime
  payload     : JSON!
}

type ScheduleEdge {
  cursor : String!
  node   : ScheduledTask!
}

type ScheduleConnection {
  edges    : [ScheduleEdge!]!
  nodes    : [ScheduledTask!]!
  pageInfo : PageInfo!
}

# -------------------------------------------------------------
#  5) Bulk Text Transformation
# -------------------------------------------------------------
enum TextTransformOption {
  UPPERCASE
  LOWERCASE
  CAMELCASE
  SNAKECASE
  TRIM
  NORMALIZE
  REVERSE
}

input TextTransformInput {
  text      : String!
  transforms: [TextTransformOption!]!
}

type TextTransformResult {
  originalText : String!
  transformed  : String!
  applied      : [TextTransformOption!]!
}

input BulkTextTransformRequest {
  entries    : [TextTransformInput!]!
}

type BulkTextTransformResult {
  results : [TextTransformResult!]!
  count   : Int!
}

# -------------------------------------------------------------
#  Root Types
# -------------------------------------------------------------
type Query {
  # --- File conversion jobs ---------------------------------
  fileConversionJob(id: ID!): FileConversionJob @rateLimit(limit: 30, window: 60)
  fileConversionJobs(page: PageInput): FileConversionJobConnection!

  # --- Checksum ---------------------------------------------
  checksum(
    text      : String!,
    algorithm : ChecksumAlgorithm! = SHA256
  ): ChecksumResult! @cacheControl(maxAge: 86400, scope: PUBLIC)

  # --- Anonymization ----------------------------------------
  anonymizePreview(
    file     : Upload!,
    strategy : String = "DEFAULT"
  ): AnonymizationResult!

  # --- Scheduling -------------------------------------------
  scheduledTasks(page: PageInput): ScheduleConnection!

  # --- Text transformation ----------------------------------
  textTransform(input: TextTransformInput!): TextTransformResult!
}

type Mutation {
  # --- File conversion --------------------------------------
  convertFile(
    request: FileConversionRequest!
  ): UtilityResponse<FileConversionJob>!

  cancelJob(id: ID!): UtilityResponse<Job>!

  # --- Checksum (batch) -------------------------------------
  checksumBulk(
    texts     : [String!]!,
    algorithm : ChecksumAlgorithm! = SHA256
  ): UtilityResponse<[ChecksumResult!]!>!

  # --- Data anonymization -----------------------------------
  anonymizeData(
    request: AnonymizeDataRequest!
  ): UtilityResponse<AnonymizationResult>!

  # --- Scheduling -------------------------------------------
  scheduleTask(
    request: ScheduleTaskRequest!
  ): UtilityResponse<ScheduledTask>!

  cancelScheduledTask(
    id: ID!
  ): UtilityResponse<ScheduledTask>!

  # --- Text transformation ----------------------------------
  bulkTextTransform(
    request: BulkTextTransformRequest!
  ): UtilityResponse<BulkTextTransformResult>!
}

schema {
  query: Query
  mutation: Mutation
}