# =========================================================================================
#  ChirpPulse – Real-Time Social Sentiment Lake
#  Global Runtime Configuration
#
#  Format: TOML  (chosen for its first-class support in the Rust ecosystem via `toml` crate)
#  All values can be overridden by environment variables using the convention
#      CHIRP_<SECTION>_<KEY>=value
#  or by supplying a second, overlay config passed via `--config-extra /path/to/file.toml`.
# -----------------------------------------------------------------------------------------
#  NOTE:
#  1. Secret material *MUST NOT* be committed in plaintext. Use env-var or HashiCorp Vault
#     interpolations such as "${KAFKA_PASSWORD}" or "vault://secret/prod/chirp_pulse#token".
#  2. After any change, run `chirpctl config lint` to ensure semantic validity.
# =========================================================================================

############################################################################################
# Core Application Settings
############################################################################################
[app]
name            = "chirp-pulse"        # Logical application identifier
environment     = "production"         # {development|staging|production}
log_level       = "info"               # {trace|debug|info|warn|error}
telemetry       = true                 # Emit OpenTelemetry traces
metrics_port    = 9090                 # Prometheus metrics exposition
http_port       = 8080                 # REST & gRPC gateway

############################################################################################
# Kafka Broker & Producer/Consumer Defaults
############################################################################################
[kafka]
bootstrap_servers   = ["kafka-1:9092", "kafka-2:9092", "kafka-3:9092"]
security_protocol   = "SASL_SSL"        # {PLAINTEXT|SSL|SASL_PLAINTEXT|SASL_SSL}
sasl_mechanism      = "SCRAM-SHA-512"
sasl_username       = "${KAFKA_USERNAME}"
sasl_password       = "${KAFKA_PASSWORD}"
client_id           = "chirp-pulse-core"
acks                = "all"             # Ensure exactly-once semantics
compression_type    = "lz4"
enable_idempotence  = true
linger_ms           = 50
batch_size          = 1_048_576         # 1 MiB
session_timeout_ms  = 30_000
heartbeat_interval_ms = 10_000

############################################################################################
# Apache Iceberg Catalog
############################################################################################
[iceberg]
catalog              = "hadoop"
warehouse            = "s3://social-data-lake/warehouse/"
namespace            = "chirp_pulse"
heartbeat_interval_ms= 20_000
commit_retry_max     = 5
commit_retry_backoff_ms = 2_000

############################################################################################
# Streaming Pipelines
# Each [[pipelines]] entry is hot-swappable at runtime through the Strategy pattern.
############################################################################################
[[pipelines]]
name               = "language_detection"
enabled            = true
input_topic        = "social_raw"
output_topic       = "social_lang"
worker_pool_size   = 16
timeout_ms         = 3_000
strategy_impl      = "lang_detect::FastTextStrategy"

[[pipelines]]
name               = "toxicity_scoring"
enabled            = true
input_topic        = "social_lang"
output_topic       = "social_toxic"
worker_pool_size   = 24
timeout_ms         = 5_000
dependencies       = ["language_detection"]
strategy_impl      = "toxicity::PerspectiveStrategy"

[[pipelines]]
name               = "influencer_graph"
enabled            = true
input_topic        = "social_lang"
output_topic       = "social_graph"
worker_pool_size   = 8
timeout_ms         = 8_000
dependencies       = ["language_detection"]
strategy_impl      = "graph::PagerankStrategy"

############################################################################################
# Data Quality Guardrails
############################################################################################
[quality_checks]
discard_on_schema_mismatch = false
max_event_lag_seconds      = 60
null_handling              = "drop_row"      # {drop_row|impute|allow}
permitted_languages        = ["en", "es", "fr", "de", "pt", "zh", "ja", "ar"]
max_toxicity_score         = 0.92            # Upper bound; rows above are routed to quarantine
quarantine_topic           = "social_quarantine"

############################################################################################
# Observability & Alerting
############################################################################################
[observability]
jaeger_endpoint           = "http://jaeger:14268/api/traces"
prometheus_push_gateway   = "http://prometheus-pushgateway:9091"
alertmanager_endpoint     = "http://alertmanager:9093"

[observability.slo]
error_budget_percent      = 0.1        # 99.9% success target
latency_threshold_ms      = 1_000      # 99th percentile latency target

############################################################################################
# Scheduler – Batch & Back-Fill Jobs
############################################################################################
[scheduler.historical_aggregator]
cron              = "0 */6 * * *"     # Every 6 hours
max_backfill_days = 3
parallel_jobs     = 4
job_timeout_sec   = 1_800

############################################################################################
# Self-Healing & Failover
############################################################################################
[failover]
max_restarts        = 5
window_seconds      = 300
backoff_base_ms     = 1_000
backoff_max_ms      = 30_000
partition_rebalance = "cooperative-sticky"  # Improves MTTR during broker failover

############################################################################################
# Feature Flags – Toggle Experimental Capabilities
############################################################################################
[feature_flags]
enable_realtime_sentiment       = true
enable_emerging_topic_detection = true
enable_audio_caption_ingest     = false
enable_schema_evolution_v2      = true

############################################################################################
# Secret Management
############################################################################################
[secrets]
vault_path                 = "secret/prod/chirp_pulse"
refresh_interval_minutes   = 30
tls_skip_verify            = false

############################################################################################
# End of File
############################################################################################