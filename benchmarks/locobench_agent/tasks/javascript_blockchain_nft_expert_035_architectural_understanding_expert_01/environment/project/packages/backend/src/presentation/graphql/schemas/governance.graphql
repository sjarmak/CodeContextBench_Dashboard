"""
GraphQL schema for Governance module
This schema surfaces the on-chain governance layer that allows fans
to stake their NFT show-passes and participate in platform decisions
(line-up curation, feature roadmap, revenue share, etc.).

All business rules live in the domain / application layers.
Resolvers simply delegate to use-case services such as:

  - StakePassService          (packages/core/usecases/StakePass.ts)
  - CastLiveVoteService       (packages/core/usecases/CastLiveVote.ts)
  - CreateProposalService     (packages/core/usecases/CreateProposal.ts)
  - DelegateVotingPower       (packages/core/usecases/DelegateVotingPower.ts)

The schema below follows Relay-style cursor pagination and includes
subscription hooks for real-time UI updates.  Custom scalars are
implemented via `graphql-scalars` and mapped in the Apollo server
bootstrap (see packages/backend/src/presentation/graphql/scalars.ts)
"""

########################
#  CUSTOM SCALARS
########################

scalar BigInt          # uint256 encoded as string
scalar DateTime        # ISO-8601 string
scalar EthereumAddress # 0x-prefixed, EIP-55 checksummed
scalar HexString       # arbitrary hex blob, 0x-prefixed
scalar Cursor          # opaque base64 cursor for pagination

########################
#  COMMON ENUMS
########################

"""
Current life-cycle stage of a governance proposal. Mirrors the
on-chain Governor contract’s state machine.
"""
enum ProposalState {
  PENDING        # Awaiting voting period start
  ACTIVE         # Voting window open
  SUCCEEDED      # Sufficient FOR votes collected
  DEFEATED       # Quorum not met or AGAINST majority
  QUEUED         # Timelocked for execution
  EXECUTED       # On-chain transactions performed
  CANCELED       # Manually canceled or proposer slashed
  EXPIRED        # Never executed within timelock
}

"""
Type of voting power measurement.  
Used for future extensibility (e.g. quadratic, conviction, etc.).
"""
enum VotePowerUnit {
  RAW          # raw token amount
  WEIGHTED     # includes boosts / multipliers
}

enum Role { ADMIN MODERATOR USER }

########################
#  DIRECTIVES
########################

"""
@auth enforces caller authorization.
Implementation uses the context’s `auth` service to validate roles.
"""
directive @auth(requires: Role = USER) on FIELD_DEFINITION

########################
#  PAGINATION INTERFACES
########################

interface Edge {
  cursor: Cursor!
  node: Node!
}

interface Connection {
  pageInfo: PageInfo!
}

interface Node {
  id: ID!
}

type PageInfo {
  endCursor: Cursor
  hasNextPage: Boolean!
}

########################
#  DOMAIN OBJECTS
########################

"""
Snapshot of overall governance metrics.
Feeds dashboards & tokenomics pages.
"""
type GovernanceStats {
  totalStakedPower: BigInt!
  circulatingPower: BigInt!
  activeProposals: Int!
  totalProposals: Int!
  voterCount: Int!
  lastUpdated: DateTime!
}

type Proposal implements Node {
  id: ID!
  title: String!
  description: String
  proposer: EthereumAddress!
  choices: [String!]!       # e.g. ["FOR", "AGAINST", "ABSTAIN"]
  startTime: DateTime!
  endTime: DateTime!
  snapshotBlock: BigInt!
  state: ProposalState!
  quorum: BigInt!
  totalPower: BigInt!
  votes(
    first: Int = 50
    after: Cursor
  ): VoteConnection!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type Vote implements Node {
  id: ID!
  voter: EthereumAddress!
  proposalId: ID!
  choice: String!
  power: BigInt!            # voting power applied
  powerUnit: VotePowerUnit!
  txHash: HexString!
  blockNumber: BigInt!
  castAt: DateTime!
}

type Stake implements Node {
  id: ID!
  staker: EthereumAddress!
  tokenId: BigInt!
  amount: BigInt!
  power: BigInt!
  stakedAt: DateTime!
  unstakedAt: DateTime
}

type Delegation implements Node {
  id: ID!
  delegator: EthereumAddress!
  delegatee: EthereumAddress!
  power: BigInt!
  active: Boolean!
  createdAt: DateTime!
  revokedAt: DateTime
}

########################
#  CONNECTION TYPES
########################

type ProposalEdge implements Edge {
  cursor: Cursor!
  node: Proposal!
}

type ProposalConnection implements Connection {
  edges: [ProposalEdge!]!
  pageInfo: PageInfo!
}

type VoteEdge implements Edge {
  cursor: Cursor!
  node: Vote!
}

type VoteConnection implements Connection {
  edges: [VoteEdge!]!
  pageInfo: PageInfo!
}

########################
#  INPUT OBJECTS
########################

input PaginationInput {
  first: Int = 50
  after: Cursor
}

input ProposalFilter {
  state: ProposalState
  proposer: EthereumAddress
}

input CreateProposalInput {
  title: String!
  description: String
  choices: [String!]!        # Must contain at least 2 options
  startTime: DateTime!       # Cannot be in the past
  endTime: DateTime!         # Must be greater than startTime
}

input CastVoteInput {
  proposalId: ID!
  choice: String!
}

input StakePassInput {
  tokenId: BigInt!
  amount: BigInt!            # Number of passes to stake
}

input UnstakePassInput {
  stakeId: ID!
}

input DelegatePowerInput {
  delegatee: EthereumAddress!
}

input RevokeDelegationInput {
  delegationId: ID!
}

########################
#  ROOT TYPES
########################

type Query {
  governanceStats: GovernanceStats!

  proposal(id: ID!): Proposal @auth
  proposals(
    filter: ProposalFilter
    paging: PaginationInput
  ): ProposalConnection! @auth

  stake(id: ID!): Stake @auth
  stakes(
    staker: EthereumAddress!
    paging: PaginationInput
  ): [Stake!]! @auth
}

type Mutation {
  createProposal(input: CreateProposalInput!): Proposal! @auth(requires: MODERATOR)

  castVote(input: CastVoteInput!): Vote! @auth
  stakePass(input: StakePassInput!): Stake! @auth
  unstakePass(input: UnstakePassInput!): Stake! @auth

  delegateVotingPower(input: DelegatePowerInput!): Delegation! @auth
  revokeDelegation(input: RevokeDelegationInput!): Delegation! @auth
}

########################
#  SUBSCRIPTIONS
########################

type Subscription {
  """
  Emits whenever a new proposal is created.
  Filters can be applied using `state` or `proposer`.
  """
  proposalCreated(filter: ProposalFilter): Proposal!

  """
  Emits real-time tally updates during an ACTIVE voting period.
  """
  voteCast(proposalId: ID!): Vote!

  """
  Emits governance stats snapshot whenever total staked power changes.
  """
  governanceStatsUpdated: GovernanceStats!
}