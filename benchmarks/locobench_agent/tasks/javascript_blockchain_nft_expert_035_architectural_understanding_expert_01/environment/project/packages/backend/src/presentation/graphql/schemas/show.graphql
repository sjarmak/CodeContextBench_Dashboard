"""
StellarStage Carnival GraphQL Schema
File: packages/backend/src/presentation/graphql/schemas/show.graphql

This schema exposes read/write operations needed by the front-end (React-Three)
and other consumers.  All mutation side-effects are routed to application
use-cases (MintShowPass, DistributeLoot, CastLiveVote, StakePass, …) via
controller adapters; no direct infrastructure logic is executed here.

The SDL purposefully mirrors the domain layer while remaining agnostic to
storage and blockchain details.  Custom scalars are implemented through
Apollo’s `GraphQLScalarType` and automatically registered in the server
bootstrap.
"""

# ---------------------------------------------------------------------------
# Custom Scalars
# ---------------------------------------------------------------------------

"""
ISO-8601 timestamp with millisecond precision.
"""
scalar DateTime

"""
EVM address (0x prefixed, 20 bytes).
"""
scalar Address

"""
Unsigned 256-bit integer serialized as string to preserve precision.
"""
scalar BigInt

"""
Arbitrary JSON payload (e.g. dynamic NFT metadata).
"""
scalar JSON

# ---------------------------------------------------------------------------
# Enums
# ---------------------------------------------------------------------------

"""
High-level lifecycle for a live show.
"""
enum ShowStatus {
  SCHEDULED   # Announcement published, tickets available
  ONBOARDING  # Audience is checking in / wallet gating
  LIVE        # The performer is on stage
  INTERMISSION
  FINISHED    # Stream ended, results tallied
  CANCELLED
}

"""
Finite states an audience pass can move through.
"""
enum PassStakingState {
  UNSTAKED
  STAKING
  STAKED
  UNSTAKING
}

# ---------------------------------------------------------------------------
# Core Domain Types
# ---------------------------------------------------------------------------

"""
A single staged performance—concert, tournament, film screening, etc.
"""
type Show {
  id: ID!
  slug: String!
  title: String!
  description: String
  thumbnailUrl: String
  coverUrl: String
  organizer: Address!
  venue: String
  startsAt: DateTime!
  endsAt: DateTime!
  status: ShowStatus!
  acts: [Act!]!
  passContract: Address!             # ERC-721 proxy contract address
  lootContracts: [Address!]!         # ERC-1155 contracts spawned during show
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""
An act/segment within a show (e.g. opening band, map round, short film).
"""
type Act {
  id: ID!
  showId: ID!
  index: Int!
  title: String!
  performer: String!
  startsAt: DateTime!
  endsAt: DateTime!
  metadata: JSON
}

"""
On-chain NFT representing an audience seat/badge with evolving traits.
"""
type Pass {
  tokenId: BigInt!
  contract: Address!
  show: Show!
  owner: Address!
  metadataUri: String!
  currentTraits: [Trait!]!
  stakingState: PassStakingState!
  stakedAt: DateTime
  level: Int!
  experience: BigInt!
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""
A single dynamic trait attached to a Pass (e.g. “Backstage xp”).
"""
type Trait {
  key: String!
  value: String!
  lastUpdated: DateTime!
}

"""
ERC-1155 loot item dropped during a show.
"""
type Loot {
  tokenId: BigInt!
  contract: Address!
  show: Show!
  name: String!
  description: String
  image: String
  rarity: Float!
  quantity: Int!
  claimedBy: [Address!]!
  totalClaimed: Int!
}

"""
Audience governance vote attached to a proposal (off-chain snapshot, on-chain
finalization).
"""
type Vote {
  voter: Address!
  weight: BigInt!
  choice: Int!
  castAt: DateTime!
}

"""
DAO proposal controlling future show decisions (line-up, revenue split).
"""
type GovernanceProposal {
  id: ID!
  proposer: Address!
  show: Show!
  title: String!
  description: String!
  snapshotBlock: BigInt!
  startTime: DateTime!
  endTime: DateTime!
  executed: Boolean!
  votes: [Vote!]!
}

# ---------------------------------------------------------------------------
# Query Root
# ---------------------------------------------------------------------------

type Query {
  # Show Queries -------------------------------------------------------------

  """
  Return detailed information for a single show.
  """
  show(id: ID!): Show

  """
  Paginated list of shows (reverse chronological by default).
  """
  shows(
    first: Int = 20,
    after: ID,
    status: ShowStatus
  ): ShowConnection!

  """
  Convenience query for shows with status = LIVE.
  """
  activeShows: [Show!]!

  # Pass Queries -------------------------------------------------------------

  """
  Fetch a single pass via tokenId and contract address.
  """
  pass(contract: Address!, tokenId: BigInt!): Pass

  """
  All passes held by the current authenticated wallet.
  """
  myPasses(first: Int = 50, after: BigInt): PassConnection!

  # Loot Queries -------------------------------------------------------------

  """
  All loot drops for a given show.
  """
  lootByShow(showId: ID!): [Loot!]!

  """
  Governance proposals for a show ordered by startTime desc.
  """
  proposals(showId: ID!, first: Int = 50, after: ID): GovernanceProposalConnection!
}

# ---------------------------------------------------------------------------
# Mutation Root
# ---------------------------------------------------------------------------

type Mutation {
  # Show Lifecycle -----------------------------------------------------------

  """
  Organizer creates a new show.  Emits DomainEvent: ShowCreated
  """
  createShow(input: CreateShowInput!): ShowResponse!

  """
  Organizer updates status (e.g. mark as LIVE).
  """
  updateShowStatus(showId: ID!, status: ShowStatus!): ShowResponse!

  # Pass Flow ----------------------------------------------------------------

  """
  Mint a new pass NFT.  Emits DomainEvent: PassMinted
  """
  mintPass(input: MintPassInput!): PassResponse!

  """
  Stake an existing pass to begin earning governance rewards.
  """
  stakePass(contract: Address!, tokenId: BigInt!): PassResponse!

  """
  Unstake a pass and stop accruing rewards.
  """
  unstakePass(contract: Address!, tokenId: BigInt!): PassResponse!

  # Engagement ---------------------------------------------------------------

  """
  Audience casts a vote during a live interactive segment.
  """
  castLiveVote(input: CastVoteInput!): VoteResponse!

  """
  Claim loot dropped during a show.  Emits DomainEvent: LootClaimed
  """
  claimLoot(contract: Address!, tokenId: BigInt!): LootResponse!
}

# ---------------------------------------------------------------------------
# Subscription Root
# ---------------------------------------------------------------------------

type Subscription {
  """
  Realtime stream of a show’s status + act transitions.
  """
  showUpdated(showId: ID!): Show!

  """
  Emitted whenever an engagement poll is opened or closed.
  """
  stageEvent(showId: ID!): JSON!

  """
  Listen for new loot drops in near-real time.
  """
  lootDropped(showId: ID!): Loot!
}

# ---------------------------------------------------------------------------
# Pagination Helpers
# ---------------------------------------------------------------------------

"""
Relay-style cursored connection for Show.
"""
type ShowConnection {
  edges: [ShowEdge!]!
  pageInfo: PageInfo!
}

type ShowEdge {
  cursor: ID!
  node: Show!
}

"""
Relay-style cursored connection for Pass.
"""
type PassConnection {
  edges: [PassEdge!]!
  pageInfo: PageInfo!
}

type PassEdge {
  cursor: BigInt!
  node: Pass!
}

"""
Relay-style cursored connection for GovernanceProposal.
"""
type GovernanceProposalConnection {
  edges: [GovernanceProposalEdge!]!
  pageInfo: PageInfo!
}

type GovernanceProposalEdge {
  cursor: ID!
  node: GovernanceProposal!
}

type PageInfo {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: ID
  endCursor: ID
}

# ---------------------------------------------------------------------------
# Inputs
# ---------------------------------------------------------------------------

input CreateShowInput {
  slug: String!
  title: String!
  description: String
  thumbnailUrl: String
  coverUrl: String
  venue: String
  startsAt: DateTime!
  endsAt: DateTime!
  acts: [CreateActInput!]!
}

input CreateActInput {
  index: Int!
  title: String!
  performer: String!
  startsAt: DateTime!
  endsAt: DateTime!
  metadata: JSON
}

input MintPassInput {
  showId: ID!
  owner: Address!          # If omitted, defaults to caller wallet
}

input CastVoteInput {
  proposalId: ID!
  choice: Int!             # Freeform option index
  weight: BigInt
}

# ---------------------------------------------------------------------------
# Payload Wrapper Types
# ---------------------------------------------------------------------------

"""
Standard mutation wrapper containing result data or errors.
"""
type ShowResponse {
  ok: Boolean!
  error: Error
  show: Show
}

type PassResponse {
  ok: Boolean!
  error: Error
  pass: Pass
}

type LootResponse {
  ok: Boolean!
  error: Error
  loot: Loot
}

type VoteResponse {
  ok: Boolean!
  error: Error
  vote: Vote
}

"""
Uniform error shape.
"""
type Error {
  code: String!
  message: String!
  meta: JSON
}

# ---------------------------------------------------------------------------
# Schema Root Mapping
# ---------------------------------------------------------------------------

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}