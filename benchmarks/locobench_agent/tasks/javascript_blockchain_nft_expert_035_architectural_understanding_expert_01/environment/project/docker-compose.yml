```yaml
# --------------------------------------------------------------------------------------------------
# docker-compose.yml
#
# StellarStage Carnival – Local/CI Orchestration Stack
# -----------------------------------------------------------------------------------------------
# Spawns a reproducible, fully-integrated environment containing:
#   • PostgreSQL          – Primary relational store (domain state, auth, etc.)
#   • Redis               – Pub/Sub + ephemeral caching (event bus, rate-limiting)
#   • Hardhat Node        – Local EVM chain with deterministic accounts for testing
#   • IPFS                – Content-addressed asset storage (media, metadata)
#   • Graph-Node          – Indexer for on-chain events exposed via GraphQL
#   • API (Backend)       – Clean-Architecture use-case layer (REST + WS)
#   • Worker              – Queue consumer for async jobs (air-drops, media transcoding)
#   • Web (Frontend)      – React-Three immersive client served via NGINX
#
# Each service is isolated on the “stage-net” bridge network and exposed through
# well-known ports for DX convenience. Production deploys should leverage an IaC
# module (e.g., Terraform, Helm) instead.
# --------------------------------------------------------------------------------------------------
version: "3.9"

x-common-env: &common-env
  NODE_ENV: ${NODE_ENV:-development}
  LOG_LEVEL: ${LOG_LEVEL:-info}

x-healthcheck: &healthcheck
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 15s

networks:
  stage-net:
    driver: bridge

volumes:
  pg_data:
  graph_pg_data:
  redis_data:
  ipfs_staging:
  node_modules_api:
  node_modules_worker:
  node_modules_web:

services:
  # ------------------------------------------------------------------------------------------------
  # Relational DB – PostgreSQL 14
  # ------------------------------------------------------------------------------------------------
  postgres:
    image: postgres:14-alpine
    restart: unless-stopped
    container_name: ss-db
    networks: [stage-net]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-stage}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-stage}
      POSTGRES_DB: ${POSTGRES_DB:-stellarstage}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]

  # ------------------------------------------------------------------------------------------------
  # Redis – event-bus / cache
  # ------------------------------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    container_name: ss-redis
    command: ["redis-server", "--appendonly", "yes"]
    networks: [stage-net]
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "redis-cli", "ping"]

  # ------------------------------------------------------------------------------------------------
  # Hardhat – deterministic local Ethereum chain
  # ------------------------------------------------------------------------------------------------
  chain:
    image: ghcr.io/nomicfoundation/hardhat:latest
    container_name: ss-chain
    restart: unless-stopped
    networks: [stage-net]
    command: ["npx", "hardhat", "node", "--hostname", "0.0.0.0"]
    ports:
      - "8545:8545"
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8545 || exit 1"]

  # ------------------------------------------------------------------------------------------------
  # IPFS – asset pinning
  # ------------------------------------------------------------------------------------------------
  ipfs:
    image: ipfs/kubo:latest
    container_name: ss-ipfs
    restart: unless-stopped
    networks: [stage-net]
    ports:
      - "5001:5001"  # API
      - "8080:8080"  # Gateway
    environment:
      IPFS_PROFILE: server
    volumes:
      - ipfs_staging:/data/ipfs
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "ipfs", "id"]

  # ------------------------------------------------------------------------------------------------
  # Graph-Node – Ethereum indexer + GraphQL server
  # ------------------------------------------------------------------------------------------------
  graph-node:
    image: graphprotocol/graph-node:latest
    container_name: ss-graph
    restart: unless-stopped
    depends_on:
      chain:
        condition: service_healthy
      graph-db:
        condition: service_healthy
    networks: [stage-net]
    env_file: ./.graph.env
    environment:
      GRAPH_NODE_POSTGRES_HOST: graph-db
      GRAPH_NODE_POSTGRES_USER: ${POSTGRES_USER:-stage}
      GRAPH_NODE_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-stage}
      GRAPH_NODE_POSTGRES_DB: graph
      GRAPH_NODE_ETHEREUM_NODE_HTTP: http://chain:8545
      GRAPH_LOG: info
      RUST_LOG: info
    ports:
      - "8000:8000"   # GraphQL main
      - "8020:8020"   # Admin / metrics
    healthcheck:
      <<: *healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]

  graph-db:
    image: postgres:14-alpine
    container_name: ss-graph-db
    restart: unless-stopped
    networks: [stage-net]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-stage}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-stage}
      POSTGRES_DB: graph
    volumes:
      - graph_pg_data:/var/lib/postgresql/data
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]

  # ------------------------------------------------------------------------------------------------
  # API Gateway / Application Server
  # ------------------------------------------------------------------------------------------------
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: ss-api
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${POSTGRES_USER:-stage}:${POSTGRES_PASSWORD:-stage}@postgres:5432/${POSTGRES_DB:-stellarstage}
      REDIS_URL: redis://redis:6379
      CHAIN_RPC_URL: http://chain:8545
      IPFS_HOST: ipfs
      IPFS_PORT: 5001
      GRAPH_NODE_URL: http://graph-node:8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      chain:
        condition: service_healthy
    networks: [stage-net]
    volumes:
      - node_modules_api:/usr/src/app/node_modules # persist yarn cache
    ports:
      - "4000:4000"
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]

  # ------------------------------------------------------------------------------------------------
  # Worker – BullMQ / Agenda job runner
  # ------------------------------------------------------------------------------------------------
  worker:
    build:
      context: ./services/worker
      dockerfile: Dockerfile
    container_name: ss-worker
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      <<: *common-env
      DATABASE_URL: postgres://${POSTGRES_USER:-stage}:${POSTGRES_PASSWORD:-stage}@postgres:5432/${POSTGRES_DB:-stellarstage}
      REDIS_URL: redis://redis:6379
      CHAIN_RPC_URL: http://chain:8545
      IPFS_HOST: ipfs
      IPFS_PORT: 5001
      GRAPH_NODE_URL: http://graph-node:8000
    depends_on:
      api:
        condition: service_started
    networks: [stage-net]
    volumes:
      - node_modules_worker:/usr/src/app/node_modules
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "kill -0 1"]  # naive liveness probe

  # ------------------------------------------------------------------------------------------------
  # Front-End – React-Three SPA served via NGINX
  # ------------------------------------------------------------------------------------------------
  web:
    build:
      context: ./services/web
      dockerfile: Dockerfile
    container_name: ss-web
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      VITE_API_URL: http://localhost:4000
      VITE_GRAPHQL_URL: http://localhost:8000/graphql
    networks: [stage-net]
    volumes:
      - node_modules_web:/usr/src/app/node_modules
    ports:
      - "3000:80"
    healthcheck:
      <<: *healthcheck
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
```