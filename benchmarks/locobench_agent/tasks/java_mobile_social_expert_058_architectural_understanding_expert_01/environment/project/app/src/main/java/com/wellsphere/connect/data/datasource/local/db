package com.wellsphere.connect.data.datasource.local.db;

import android.content.Context;

import androidx.annotation.NonNull;
import androidx.lifecycle.LiveData;
import androidx.room.AutoMigration;
import androidx.room.Database;
import androidx.room.DeleteTable;
import androidx.room.Entity;
import androidx.room.ForeignKey;
import androidx.room.Index;
import androidx.room.Insert;
import androidx.room.PrimaryKey;
import androidx.room.Query;
import androidx.room.Room;
import androidx.room.RoomDatabase;
import androidx.room.TypeConverter;
import androidx.room.TypeConverters;
import androidx.sqlite.db.SupportSQLiteDatabase;

import net.sqlcipher.database.SQLiteDatabase;
import net.sqlcipher.database.SupportFactory;

import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * Production-grade Room database for WellSphere Connect.
 *
 * The database is encrypted with SQLCipher, supports auto migrations,
 * and exposes asynchronous DAO APIs suitable for reactive MVVM usage.
 */
@Database(
        version = 3,
        exportSchema = true,
        autoMigrations = {
                @AutoMigration(from = 1, to = 2),
                // Sample: removing deprecated "draft_post" table in v3
                @AutoMigration(
                        from = 2,
                        to = 3,
                        deleteTables = @DeleteTable(tableName = "draft_post")
                )
        },
        entities = {
                WellSphereDatabase.PatientProfileEntity.class,
                WellSphereDatabase.JournalEntryEntity.class,
                WellSphereDatabase.VitalReadingEntity.class
        }
)
@TypeConverters(WellSphereDatabase.Converters.class)
public abstract class WellSphereDatabase extends RoomDatabase {

    private static final String DB_NAME = "wellsphere_connect.db";
    private static final int THREAD_COUNT = 4;

    // -----------------------------------------------------------------------------
    // Singleton instantiation
    // -----------------------------------------------------------------------------
    private static volatile WellSphereDatabase INSTANCE;
    private static final ExecutorService DB_IO_EXECUTOR =
            Executors.newFixedThreadPool(THREAD_COUNT);

    /**
     * Returns the singleton database instance.
     *
     * @param context    application context (do not pass an Activity!)
     * @param passphrase Encryption passphrase; retrieved from keystore-driven
     *                   Biometric module after successful authentication.
     */
    public static WellSphereDatabase getInstance(@NonNull Context context,
                                                 @NonNull char[] passphrase) {
        if (INSTANCE == null) {
            synchronized (WellSphereDatabase.class) {
                if (INSTANCE == null) {
                    INSTANCE = buildDatabase(context.getApplicationContext(), passphrase);
                }
            }
        }
        return INSTANCE;
    }

    private static WellSphereDatabase buildDatabase(Context context, char[] passphrase) {
        // SQLCipher factory for transparent encryption-at-rest
        final byte[] passphraseBytes = SQLiteDatabase.getBytes(passphrase);
        SupportFactory factory = new SupportFactory(passphraseBytes);

        return Room.databaseBuilder(context, WellSphereDatabase.class, DB_NAME)
                .openHelperFactory(factory)
                .fallbackToDestructiveMigrationOnDowngrade() // policy: wipe on major downgrade
                .addCallback(PREPOPULATION_CALLBACK)
                .build();
    }

    // -----------------------------------------------------------------------------
    // DAO accessors
    // -----------------------------------------------------------------------------
    public abstract PatientProfileDao patientProfileDao();

    public abstract JournalDao journalDao();

    public abstract VitalDao vitalDao();

    // -----------------------------------------------------------------------------
    // Callback for initial pre-population
    // -----------------------------------------------------------------------------
    private static final Callback PREPOPULATION_CALLBACK =
            new Callback() {
                @Override
                public void onCreate(@NonNull SupportSQLiteDatabase db) {
                    super.onCreate(db);
                    // Offload heavy inserts to the executor
                    DB_IO_EXECUTOR.execute(() -> {
                        // Initial data such as default units, example profile, etc.
                        // Keep operations within Room session to leverage encryption.
                        PatientProfileEntity demo =
                                new PatientProfileEntity("demo_uid", "Demo User", "demo@acme.com");
                        INSTANCE.patientProfileDao().insertReplace(demo);
                    });
                }
            };

    // -----------------------------------------------------------------------------
    // Type Converters
    // -----------------------------------------------------------------------------
    public static final class Converters {

        @TypeConverter
        public static long toEpochMillis(LocalDateTime dateTime) {
            return dateTime == null ? 0 : dateTime.toInstant(ZoneOffset.UTC).toEpochMilli();
        }

        @TypeConverter
        public static LocalDateTime toLocalDateTime(long epochMillis) {
            return epochMillis == 0
                    ? null
                    : LocalDateTime.ofInstant(Instant.ofEpochMilli(epochMillis), ZoneOffset.UTC);
        }
    }

    // -----------------------------------------------------------------------------
    // Entities (simplified for demonstration)
    // -----------------------------------------------------------------------------
    @Entity(
            tableName = "patient_profile",
            indices = {@Index(value = {"email"}, unique = true)}
    )
    public static class PatientProfileEntity {

        @PrimaryKey
        @NonNull
        public final String uid;

        @NonNull
        public final String displayName;

        @NonNull
        public final String email;

        public PatientProfileEntity(@NonNull String uid,
                                    @NonNull String displayName,
                                    @NonNull String email) {
            this.uid = uid;
            this.displayName = displayName;
            this.email = email;
        }
    }

    @Entity(
            tableName = "journal_entry",
            foreignKeys = @ForeignKey(
                    entity = PatientProfileEntity.class,
                    parentColumns = "uid",
                    childColumns = "authorUid",
                    onDelete = ForeignKey.CASCADE,
                    onUpdate = ForeignKey.CASCADE
            ),
            indices = {@Index("authorUid")}
    )
    public static class JournalEntryEntity {

        @PrimaryKey(autoGenerate = true)
        public long id;

        @NonNull
        public final String authorUid;

        @NonNull
        public final String body;

        @NonNull
        public final LocalDateTime createdAtUtc;

        public JournalEntryEntity(@NonNull String authorUid,
                                  @NonNull String body,
                                  @NonNull LocalDateTime createdAtUtc) {
            this.authorUid = authorUid;
            this.body = body;
            this.createdAtUtc = createdAtUtc;
        }
    }

    @Entity(
            tableName = "vital_reading",
            foreignKeys = @ForeignKey(
                    entity = PatientProfileEntity.class,
                    parentColumns = "uid",
                    childColumns = "patientUid",
                    onDelete = ForeignKey.CASCADE,
                    onUpdate = ForeignKey.CASCADE
            ),
            indices = {@Index("patientUid")}
    )
    public static class VitalReadingEntity {

        @PrimaryKey(autoGenerate = true)
        public long id;

        @NonNull
        public final String patientUid;

        @NonNull
        public final String label;      // e.g., "Blood Pressure", "Glucose"
        @NonNull
        public final String value;      // to keep flexible units
        @NonNull
        public final LocalDateTime timestampUtc;

        public VitalReadingEntity(@NonNull String patientUid,
                                  @NonNull String label,
                                  @NonNull String value,
                                  @NonNull LocalDateTime timestampUtc) {
            this.patientUid = patientUid;
            this.label = label;
            this.value = value;
            this.timestampUtc = timestampUtc;
        }
    }

    // -----------------------------------------------------------------------------
    // DAO Definitions
    // -----------------------------------------------------------------------------
    public interface PatientProfileDao {

        @Query("SELECT * FROM patient_profile LIMIT 1")
        LiveData<PatientProfileEntity> getActiveProfile();

        @Insert(onConflict = androidx.room.OnConflictStrategy.REPLACE)
        void insertReplace(PatientProfileEntity profile);
    }

    public interface JournalDao {

        @Query("SELECT * FROM journal_entry WHERE authorUid = :uid ORDER BY createdAtUtc DESC")
        LiveData<List<JournalEntryEntity>> findByAuthor(String uid);

        @Insert
        void insert(JournalEntryEntity entry);

        @Query("DELETE FROM journal_entry WHERE id = :entryId")
        void deleteById(long entryId);
    }

    public interface VitalDao {

        @Query("SELECT * FROM vital_reading WHERE patientUid = :uid " +
               "AND label = :label ORDER BY timestampUtc DESC LIMIT 50")
        LiveData<List<VitalReadingEntity>> latestReadings(String uid, String label);

        @Insert
        void insert(VitalReadingEntity reading);
    }
}