/**
 * MercuryMonolith Commerce Hub — Core Constants
 *
 * File path: src/constants.txt       (treated as a normal C translation unit)
 * ---------------------------------------------------------------------------
 * This compilation unit declares and (optionally) defines every compile-time
 * string literal, numeric literal, enumeration and bit-flag that must remain
 * globally unique and immutable throughout the lifetime of the running
 * process.  By collecting them in a single place, we avoid subtle ODR-violations
 * across shared objects, minimise string duplication in the binary image, and
 * give integrators one authoritative location for system-wide knobs.
 *
 * NOTE:  Although the filename carries a “.txt” suffix (to avoid accidental
 *        compilation when building only a subtree) it is nevertheless valid C
 *        code and can be #included or compiled directly.
 *
 * Copyright 2024  Mercury Labs, Inc.
 * SPDX-License-Identifier: MIT
 */
#ifndef MERCURYMONOLITH_CONSTANTS_H
#define MERCURYMONOLITH_CONSTANTS_H

/* ========================================================================== */
/*  Standard Library Dependencies                                             */
/* ========================================================================== */
#include <stdint.h>     /* uint*_t                                          */
#include <stddef.h>     /* size_t                                           */
#include <limits.h>     /* PATH_MAX                                         */

#ifdef __cplusplus
extern "C" {
#endif

/* ========================================================================== */
/*  Build & Version Metadata                                                 */
/* ========================================================================== */

/* High-level program identifiers */
#define MM_APP_NAME                "MercuryMonolith Commerce Hub"
#define MM_APP_VENDOR              "Mercury Labs, Inc."
#define MM_APP_URL                 "https://mercury.example.com"

/* Semantic versioning string is generated at build time via -D flag.
 * Fallback to “0.0.0-dev” when not provided. */
#ifndef MM_APP_VERSION
#  define MM_APP_VERSION           "0.0.0-dev"
#endif

/* Git commit SHA is injected during CI builds */
#ifndef MM_GIT_COMMIT
#  define MM_GIT_COMMIT            "unknown"
#endif

/* Build timestamp in ISO-8601 UTC. Prefer SOURCE_DATE_EPOCH for reproducible
 * builds. */
#ifndef MM_BUILD_TIMESTAMP_UTC
#  define MM_BUILD_TIMESTAMP_UTC   __DATE__ " " __TIME__ "Z"
#endif

/* ========================================================================== */
/*  Environment Variable Names                                               */
/* ========================================================================== */
#define MM_ENV_DB_URL              "MM_DB_URL"
#define MM_ENV_DB_MAX_POOL         "MM_DB_MAX_POOL"
#define MM_ENV_LISTEN_ADDR         "MM_LISTEN_ADDR"
#define MM_ENV_LOG_LEVEL           "MM_LOG_LEVEL"
#define MM_ENV_JWT_PUBLIC_KEY      "MM_JWT_PUBLIC_KEY"
#define MM_ENV_TLS_CERT_FILE       "MM_TLS_CERT_FILE"
#define MM_ENV_TLS_KEY_FILE        "MM_TLS_KEY_FILE"
#define MM_ENV_PROM_ENDPOINT       "MM_PROM_ENDPOINT"
#define MM_ENV_CACHE_SIZE          "MM_CACHE_SIZE_BYTES"
#define MM_ENV_RATE_LIMIT          "MM_RATE_LIMIT_RPS"
#define MM_ENV_CONFIG_FILE         "MM_CONFIG_FILE"

/* Default fallback values used when environment variables are absent */
#define MM_DEFAULT_LISTEN_ADDR     "0.0.0.0:8080"
#define MM_DEFAULT_DB_URL          "sqlite://:memory:"
#define MM_DEFAULT_LOG_LEVEL       "INFO"
#define MM_DEFAULT_RATE_LIMIT_RPS  2500U  /* Requests per second */

/* ========================================================================== */
/*  API Versioning                                                            */
/* ========================================================================== */

/* Numeric representation aligns with X-header “X-MM-Api-Version”.
 * Increment only when backwards-incompatible changes land. */
typedef enum {
    MM_API_V1 = 1,
    MM_API_V2 = 2,   /* Introduced GraphQL mutations */
    /* Add new versions above and bump MM_API_CURRENT                        */
} mm_api_version_e;

#define MM_API_CURRENT             MM_API_V2

/* String mapping for debugging / OpenAPI generation */
static const char *const mm_api_version_str[] = {
    [MM_API_V1] = "v1",
    [MM_API_V2] = "v2"
};

/* ========================================================================== */
/*  HTTP & REST Constants                                                    */
/* ========================================================================== */

/* Common HTTP header names (lower-case as required by HTTP/2 HPACK) */
#define MM_HTTP_HEADER_AUTH        "authorization"
#define MM_HTTP_HEADER_X_REQUESTID "x-request-id"
#define MM_HTTP_HEADER_X_API_VER   "x-mm-api-version"
#define MM_HTTP_HEADER_USER_AGENT  "user-agent"
#define MM_HTTP_HEADER_CACHE_CTRL  "cache-control"
#define MM_HTTP_HEADER_ETAG        "etag"

/* RESTful sub-routes */
#define MM_ROUTE_HEALTHZ           "/healthz"
#define MM_ROUTE_METRICS           "/metrics"
#define MM_ROUTE_OPENAPI           "/openapi.json"
#define MM_ROUTE_GRAPHQL           "/graphql"
#define MM_ROUTE_DOCS              "/docs"

/* ========================================================================== */
/*  Bit-flags for Feature Toggles                                             */
/* ========================================================================== */
typedef enum {
    MM_FEATURE_NONE            = 0,
    MM_FEATURE_RESPONSE_CACHE  = 1u << 0,
    MM_FEATURE_RATE_LIMITING   = 1u << 1,
    MM_FEATURE_JWT_AUTH        = 1u << 2,
    MM_FEATURE_MUTUAL_TLS      = 1u << 3,
    MM_FEATURE_PROM_METRICS    = 1u << 4,
    MM_FEATURE_ALL             = 0xFFFFFFFFu
} mm_feature_flags_e;

/* ========================================================================== */
/*  Error Codes                                                               */
/* ========================================================================== */
typedef enum {
    MM_OK                          = 0,

    /* Generic failures */
    MM_ERR_INTERNAL                = -1,
    MM_ERR_NO_MEM                  = -2,
    MM_ERR_INVALID_ARG             = -3,
    MM_ERR_IO                      = -4,
    MM_ERR_NOT_IMPL                = -5,

    /* HTTP-specific */
    MM_ERR_HTTP_BAD_REQ            = -100,
    MM_ERR_HTTP_UNAUTH             = -101,
    MM_ERR_HTTP_FORBID             = -102,
    MM_ERR_HTTP_NOT_FOUND          = -103,
    MM_ERR_HTTP_RATE_LIMIT         = -104,

    /* Repository / DB */
    MM_ERR_DB_CONN                 = -200,
    MM_ERR_DB_TXN                  = -201,
    MM_ERR_DB_CONSTRAINT           = -202,
    MM_ERR_DB_NOT_FOUND            = -203,

    /* Domain-specific */
    MM_ERR_ORDER_NOT_FOUND         = -300,
    MM_ERR_INVENTORY_SHORTAGE      = -301,
    MM_ERR_PAYMENT_DECLINED        = -302

} mm_err_e;

/* ========================================================================== */
/*  Structured Logging Keys                                                  */
/* ========================================================================== */
#define MM_LOG_KEY_EVENT           "event"
#define MM_LOG_KEY_SERVICE         "service"
#define MM_LOG_KEY_MODULE          "module"
#define MM_LOG_KEY_ERROR           "error"
#define MM_LOG_KEY_LATENCY_MS      "latency_ms"
#define MM_LOG_KEY_USER_ID         "user_id"
#define MM_LOG_KEY_ORDER_ID        "order_id"
#define MM_LOG_KEY_CORRELATION_ID  "correlation_id"

/* ========================================================================== */
/*  Prometheus Metrics                                                       */
/* ========================================================================== */
#define MM_METRIC_HTTP_REQ_TOTAL   "mm_http_requests_total"
#define MM_METRIC_HTTP_LATENCY_MS  "mm_http_request_latency_ms"
#define MM_METRIC_DB_CONN_OPEN     "mm_db_connections_open"
#define MM_METRIC_DB_TXN_TIME_MS   "mm_db_transaction_time_ms"

/* ========================================================================== */
/*  Utility Inline Functions                                                 */
/* ========================================================================== */

/**
 * Translate an mm_err_e error code into a brief, human-readable string.
 * The returned pointer is to a static literal; caller must not free().
 */
static inline const char*
mm_err_to_string(mm_err_e code)
{
    switch (code) {
        case MM_OK:                       return "OK";
        case MM_ERR_INTERNAL:             return "Internal error";
        case MM_ERR_NO_MEM:               return "Out of memory";
        case MM_ERR_INVALID_ARG:          return "Invalid argument";
        case MM_ERR_IO:                   return "I/O error";
        case MM_ERR_NOT_IMPL:             return "Not implemented";
        case MM_ERR_HTTP_BAD_REQ:         return "Bad request";
        case MM_ERR_HTTP_UNAUTH:          return "Unauthorized";
        case MM_ERR_HTTP_FORBID:          return "Forbidden";
        case MM_ERR_HTTP_NOT_FOUND:       return "Not found";
        case MM_ERR_HTTP_RATE_LIMIT:      return "Rate limited";
        case MM_ERR_DB_CONN:              return "Database connection failed";
        case MM_ERR_DB_TXN:               return "Database transaction failed";
        case MM_ERR_DB_CONSTRAINT:        return "Database constraint violated";
        case MM_ERR_DB_NOT_FOUND:         return "Database record not found";
        case MM_ERR_ORDER_NOT_FOUND:      return "Order not found";
        case MM_ERR_INVENTORY_SHORTAGE:   return "Inventory shortage";
        case MM_ERR_PAYMENT_DECLINED:     return "Payment declined";
        default:                          return "Unknown error";
    }
}

/**
 * Map feature flags to a compact, null-terminated string of enabled features.
 * The caller supplies a char buffer of size at least out_sz; recommends 64 B.
 *
 * Returns number of bytes written (excluding the terminating NUL) on success,
 * or a negative mm_err_e code. Truncation is never performed; if the buffer
 * is too small the function returns MM_ERR_INVALID_ARG.
 */
static inline int
mm_feature_flags_to_string(mm_feature_flags_e flags,
                           char               *out,
                           size_t              out_sz)
{
    if (!out || out_sz == 0) {
        return MM_ERR_INVALID_ARG;
    }

    /* clang-format off */
    static const struct { mm_feature_flags_e flag; const char *name; } mapping[] = {
        { MM_FEATURE_RESPONSE_CACHE , "cache"     },
        { MM_FEATURE_RATE_LIMITING  , "rate-limit"},
        { MM_FEATURE_JWT_AUTH       , "jwt"       },
        { MM_FEATURE_MUTUAL_TLS     , "mtls"      },
        { MM_FEATURE_PROM_METRICS   , "prom"      }
    };
    /* clang-format on */

    size_t pos = 0;
    for (size_t i = 0; i < sizeof(mapping)/sizeof(mapping[0]); ++i) {
        if (flags & mapping[i].flag) {
            size_t len = 0;
            /* Add comma separation when necessary */
            if (pos > 0) {
                if (pos + 1 >= out_sz) return MM_ERR_INVALID_ARG;
                out[pos++] = ',';
            }
            /* Copy name */
            while ((len = (size_t)mapping[i].name[len])) { /* noop */ }
            if (pos + len >= out_sz) return MM_ERR_INVALID_ARG;
            for (size_t j = 0; mapping[i].name[j]; ++j)
                out[pos++] = mapping[i].name[j];
        }
    }
    if (pos >= out_sz) return MM_ERR_INVALID_ARG;
    out[pos] = '\0';
    return (int)pos;
}

/* ========================================================================== */
/*  Compile-time Assertions                                                  */
/* ========================================================================== */
#if defined(__STDC_VERSION__) && (__STDC_VERSION__ >= 201112L)
#  include <assert.h>
_Static_assert((sizeof(mm_api_version_str) / sizeof(*mm_api_version_str)) > MM_API_CURRENT,
               "mm_api_version_str[] table is missing entries");
#endif

#ifdef __cplusplus
} /* extern "C" */
#endif
#endif /* MERCURYMONOLITH_CONSTANTS_H */