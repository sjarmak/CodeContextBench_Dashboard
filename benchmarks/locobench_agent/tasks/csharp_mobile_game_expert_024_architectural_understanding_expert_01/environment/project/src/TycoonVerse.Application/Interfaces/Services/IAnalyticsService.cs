using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Threading;
using System.Threading.Tasks;

namespace TycoonVerse.Application.Interfaces.Services
{
    /// <summary>
    ///     Indicates how important an analytics event is.  Used to control sampling,
    ///     persistence policy, and upload priority.
    /// </summary>
    public enum AnalyticsEventSeverity
    {
        Verbose = 0,
        Info = 1,
        Warning = 2,
        Error = 3,
        Critical = 4
    }

    /// <summary>
    ///     Logical routing channels supported by the analytics pipeline.
    ///     The underlying implementation may map these to vendor-specific
    ///     designations (e.g., “event”, “commerce”, “crash”, etc.).
    /// </summary>
    public enum AnalyticsChannel
    {
        Gameplay   = 0,
        Monetization,
        Telemetry,
        Performance,
        System
    }

    /// <summary>
    ///     Immutable model describing a single analytics payload generated by the game.
    /// </summary>
    public sealed class AnalyticsEvent
    {
        /// <inheritdoc cref="AnalyticsEvent(string, AnalyticsChannel, AnalyticsEventSeverity, IDictionary{string, object}?)"/>
        public AnalyticsEvent(
            string                   name,
            AnalyticsChannel         channel,
            IDictionary<string, object>? properties = null)
            : this(name, channel, AnalyticsEventSeverity.Info, properties)
        { }

        /// <summary>
        ///     Creates a new analytics event with a fully specified severity.
        /// </summary>
        /// <param name="name">Name of the event (max 64 characters, vendor-specific limits may apply).</param>
        /// <param name="channel">High-level routing channel.</param>
        /// <param name="severity">Severity used to prioritise dispatch.</param>
        /// <param name="properties">Arbitrary key-value pairs providing structured context.</param>
        /// <exception cref="ArgumentException">Thrown if <paramref name="name"/> is blank.</exception>
        public AnalyticsEvent(
            string                   name,
            AnalyticsChannel         channel,
            AnalyticsEventSeverity   severity,
            IDictionary<string, object>? properties = null)
        {
            if (string.IsNullOrWhiteSpace(name))
                throw new ArgumentException("Event name cannot be null or whitespace.", nameof(name));

            Name       = name;
            Channel    = channel;
            Severity   = severity;
            Timestamp  = DateTimeOffset.UtcNow;
            Properties = new ReadOnlyDictionary<string, object>(
                properties ?? new Dictionary<string, object>(0));
        }

        /// <summary>Human-readable identifier; usually <c>PascalCase</c>.</summary>
        public string Name { get; }

        /// <summary>Event routing channel.</summary>
        public AnalyticsChannel Channel { get; }

        /// <summary>UTC timestamp captured on the client when the event object was created.</summary>
        public DateTimeOffset Timestamp { get; }

        /// <summary>Mutable fields are prohibited; this collection is read-only.</summary>
        public IReadOnlyDictionary<string, object> Properties { get; }

        /// <summary>Priority of the event.</summary>
        public AnalyticsEventSeverity Severity { get; }
    }

    /// <summary>
    ///     Contract for the analytics subsystem used throughout TycoonVerse.
    ///     Implementations MUST be thread-safe and await-friendly.  All methods
    ///     complete synchronously when offline by enqueueing the request for
    ///     deferred persistence.
    /// </summary>
    public interface IAnalyticsService
    {
        /// <summary>
        ///     Raised every time an event is successfully recorded—even if it is only
        ///     cached locally for future upload.  Consumers should avoid blocking work.
        /// </summary>
        event EventHandler<AnalyticsEvent> EventTracked;

        /// <summary>
        ///     Raised when the service fails to capture or upload an event.  Fatal errors
        ///     (e.g., JSON serialization problems) are surfaced here as well.
        /// </summary>
        event EventHandler<Exception> TrackingFailed;

        /// <summary>
        ///     True if the service completed <see cref="InitializeAsync"/> at least once
        ///     for the current lifecycle.
        /// </summary>
        bool IsInitialized { get; }

        /// <summary>
        ///     Indicates that networking is currently unavailable and events are being
        ///     written to the local durable queue.
        /// </summary>
        bool IsOffline { get; }

        /// <summary>
        ///     Performs async dependency resolution and remote SDK initialisation.
        ///     MUST be invoked before any tracking API.  Subsequent calls are no-ops.
        /// </summary>
        ValueTask InitializeAsync(CancellationToken cancellationToken = default);

        /// <summary>
        ///     Links a user to all subsequent events in the current session.  When called
        ///     multiple times, the latest non-null properties win.
        /// </summary>
        /// <param name="userId">Internal game identifier.</param>
        /// <param name="email">Optional e-mail hashed and forwarded as a user property.</param>
        ValueTask IdentifyUserAsync(
            Guid            userId,
            string?         email               = null,
            CancellationToken cancellationToken = default);

        /// <summary>
        ///     Records a generic event with caller-supplied context.  The method returns
        ///     as soon as the payload is either:
        ///     1) persisted to the local queue, or
        ///     2) successfully handed off to the remote analytics SDK.
        /// </summary>
        ValueTask TrackAsync(
            AnalyticsEvent   analyticsEvent,
            CancellationToken cancellationToken = default);

        /// <summary>
        ///     Convenience wrapper for fatal application errors that should surface in
        ///     crash-reporting dashboards.
        /// </summary>
        ValueTask TrackFatalAsync(
            string           message,
            Exception        exception,
            IDictionary<string, object>? context          = null,
            CancellationToken                 cancellationToken = default);

        /// <summary>
        ///     Captures a commerce transaction initiated locally or via the app store.
        ///     The analytics implementation is responsible for formatting in accordance
        ///     with the selected vendor’s requirements (e.g., Apple, Google, Unity Ads).
        /// </summary>
        ValueTask TrackPurchaseAsync(
            string           sku,
            string           currency,
            decimal          price,
            string?          transactionId    = null,
            IDictionary<string, object>? context          = null,
            CancellationToken                 cancellationToken = default);

        /// <summary>
        ///     Sets or overwrites a static attribute on the current user profile.
        ///     Property keys must adhere to the remote provider’s naming rules.
        /// </summary>
        ValueTask SetUserPropertyAsync(
            string           key,
            object           value,
            CancellationToken cancellationToken = default);

        /// <summary>
        ///     Adds a transient property to the active analytics session.  These values
        ///     are reset when the session expires or the player signs out.
        /// </summary>
        ValueTask SetSessionPropertyAsync(
            string           key,
            object           value,
            CancellationToken cancellationToken = default);

        /// <summary>
        ///     Marks the start of a timed operation; the elapsed duration is reported
        ///     when <see cref="FinishTimedEventAsync"/> is invoked with the same name.
        ///     Nested timers are allowed but must have unique names.
        /// </summary>
        ValueTask StartTimedEventAsync(
            string           eventName,
            CancellationToken cancellationToken = default);

        /// <summary>
        ///     Completes a timer started with <see cref="StartTimedEventAsync"/> and emits
        ///     a new analytics event whose properties include <c>duration_ms</c>.
        /// </summary>
        ValueTask FinishTimedEventAsync(
            string           eventName,
            IDictionary<string, object>? additionalProperties = null,
            CancellationToken                 cancellationToken = default);

        /// <summary>
        ///     Forces an immediate upload of all queued events.  If the device is
        ///     offline the method completes silently.
        /// </summary>
        ValueTask FlushAsync(CancellationToken cancellationToken = default);

        /// <summary>
        ///     Returns buffered events in FIFO order without removing them from the queue.
        ///     Intended for read-only diagnostics or for unit testing the implementation.
        /// </summary>
        IAsyncEnumerable<AnalyticsEvent> GetBufferedEventsAsync(
            int             batchSize           = 50,
            CancellationToken cancellationToken = default);
    }
}