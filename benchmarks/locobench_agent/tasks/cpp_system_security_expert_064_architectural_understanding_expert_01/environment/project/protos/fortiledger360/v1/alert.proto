syntax = "proto3";

package fortiledger360.v1;

option csharp_namespace = "FortiLedger360.V1";
option java_multiple_files = true;
option java_package        = "com.fortiledger360.proto.v1";
option go_package          = "github.com/fortiledger360/protos/gen/go/fortiledger360/v1";

// -----------------------------------------------------------------------------
//  Alert & Alerting Service Definitions
// -----------------------------------------------------------------------------
//
//  Overview
//  --------
//  - All platform components publish Alert events through the AlertBroker
//    service.  Clients (internal control-planes, monitoring dashboards, and
//    tenant-facing portals) consume alerts via the bidirectional streaming
//    endpoint `StreamAlerts`.
//  - Each Alert is immutable once persisted; mutations (e.g., “resolved” or
//    “acknowledged”) are expressed as follow-up events referencing the original
//    Alert ID.  This allows complete auditability of an alert’s life-cycle.
//  - SLA escalations and rule-based notifications rely on user-defined
//    `AlertRule` resources that match against Alert attributes.
//
//  Notes for Generated C++ Code
//  ----------------------------
//  - The C++ gRPC layer utilises the “unified service stub” pattern to inject
//    cross-cutting concerns (auth-z, tracing) via interceptors.
//  - Error handling follows Google RPC semantics—RPC status codes are surfaced
//    in the `grpc::Status` object and detailed errors are modelled with
//    `google.rpc.Status` messages where applicable.
//
// -----------------------------------------------------------------------------

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/rpc/status.proto";

// -----------------------------------------------------------------------------
//  Enumerations
// -----------------------------------------------------------------------------

// Describes how urgent / impactful an alert is.
enum AlertSeverity {
    ALERT_SEVERITY_UNSPECIFIED = 0;
    ALERT_SEVERITY_INFO        = 1;
    ALERT_SEVERITY_WARNING     = 2;
    ALERT_SEVERITY_CRITICAL    = 3;
    ALERT_SEVERITY_FATAL       = 4;
}

// Describes the platform component that generated the alert.
enum AlertComponent {
    ALERT_COMPONENT_UNSPECIFIED   = 0;
    ALERT_COMPONENT_SCANNER       = 1;
    ALERT_COMPONENT_METRICS       = 2;
    ALERT_COMPONENT_CONFIG_MANAGER = 3;
    ALERT_COMPONENT_BACKUP_NODE   = 4;
    ALERT_COMPONENT_LOAD_BALANCER = 5;
    ALERT_COMPONENT_PLATFORM      = 6; // core infra / platform-level
}

// Describes how the alert should be visualised or routed.
enum AlertCategory {
    ALERT_CATEGORY_UNSPECIFIED = 0;
    ALERT_CATEGORY_SECURITY    = 1;
    ALERT_CATEGORY_AVAILABILITY = 2;
    ALERT_CATEGORY_PERFORMANCE = 3;
    ALERT_CATEGORY_COMPLIANCE  = 4;
    ALERT_CATEGORY_BILLING     = 5;
}

// -----------------------------------------------------------------------------
//  Core Resources
// -----------------------------------------------------------------------------

// Immutable Alert event.
message Alert {
    string                          id             = 1;  // ULID / UUID-v7
    string                          tenant_id      = 2;  // issuer tenant
    string                          correlation_id = 3;  // event correlation chain
    google.protobuf.Timestamp       triggered_at   = 4;
    AlertSeverity                   severity       = 5;
    AlertComponent                  component      = 6;
    AlertCategory                   category       = 7;
    bool                            is_resolved    = 8;  // true once resolved
    google.protobuf.Timestamp       resolved_at    = 9;  // empty if not resolved

    string                          summary        = 10; // short, human-friendly
    string                          details_markdown = 11; // long-form details
    
    // Arbitrary k-v labels, primarily for rule matching and dashboards.
    map<string, string>             labels         = 12;

    // Link to the parent incident (if any).
    string                          incident_id    = 13;
}

// User-defined rule that triggers downstream actions (email, webhook, etc.).
message AlertRule {
    string                    id        = 1;
    string                    tenant_id = 2;
    string                    name      = 3;
    string                    description = 4;
    
    // Simple CEL expression evaluated against incoming Alert proto.
    // Example: `severity >= ALERT_SEVERITY_CRITICAL && category == ALERT_CATEGORY_SECURITY`
    string                    cel_expression = 5;

    bool                      enabled   = 6;
    google.protobuf.Timestamp created_at = 7;
    google.protobuf.Timestamp updated_at = 8;
}

// -----------------------------------------------------------------------------
//  Publish API
// -----------------------------------------------------------------------------

message PublishAlertRequest {
    Alert alert = 1;
}

message PublishAlertResponse {
    // Empty on success; errors are returned in grpc::Status.
    google.protobuf.Empty ack = 1;
}

// -----------------------------------------------------------------------------
//  Streaming API
// -----------------------------------------------------------------------------

// Client can resume after a disconnect by sending the last seen Alert ID.
message StreamAlertsRequest {
    string tenant_id           = 1;
    string last_seen_alert_id  = 2;
}

// Server->Client streaming envelope.
message StreamAlertsResponse {
    oneof event {
        Alert                alert     = 1;
        Heartbeat            heartbeat = 2;
    }
}

// Periodic keep-alive message so proxies don’t close idle streams.
message Heartbeat {
    google.protobuf.Timestamp server_time = 1;
}

// -----------------------------------------------------------------------------
//  Acknowledge / Resolve API
// -----------------------------------------------------------------------------

message AcknowledgeAlertRequest {
    string alert_id = 1;
    string actor    = 2; // user or system who is acknowledging
    string note     = 3;
    bool   resolve  = 4; // if true, alert is marked resolved
}

message AcknowledgeAlertResponse {
    Alert updated_alert = 1; // new state after acknowledgement
}

// -----------------------------------------------------------------------------
//  Alert Rule CRUD
// -----------------------------------------------------------------------------

message UpsertAlertRuleRequest {
    AlertRule rule = 1; // id empty => create; else update
}

message UpsertAlertRuleResponse {
    AlertRule rule = 1;
}

message DeleteAlertRuleRequest {
    string rule_id  = 1;
    string tenant_id = 2;
}

message ListAlertRulesRequest {
    string tenant_id = 1;
    int32  page_size = 2;         // server-side limit
    string page_token = 3;        // continue from token
}

message ListAlertRulesResponse {
    repeated AlertRule rules       = 1;
    string             next_token  = 2; // empty if no more
}

// -----------------------------------------------------------------------------
//  Service Definition
// -----------------------------------------------------------------------------

service AlertBroker {
    // Publishes a new Alert to the broker.
    rpc PublishAlert(PublishAlertRequest) returns (PublishAlertResponse);

    // Bi-directional stream: client sends StreamAlertsRequest once, server
    // streams Alert / Heartbeat messages indefinitely.
    rpc StreamAlerts(stream StreamAlertsRequest)
        returns (stream StreamAlertsResponse);

    // Marks an alert as acknowledged / resolved.
    rpc AcknowledgeAlert(AcknowledgeAlertRequest)
        returns (AcknowledgeAlertResponse);

    // Upsert (create or update) an AlertRule.
    rpc UpsertAlertRule(UpsertAlertRuleRequest)
        returns (UpsertAlertRuleResponse);

    // Deletes an existing AlertRule.
    rpc DeleteAlertRule(DeleteAlertRuleRequest)
        returns (google.protobuf.Empty);

    // Lists all AlertRules for a tenant (paginated).
    rpc ListAlertRules(ListAlertRulesRequest)
        returns (ListAlertRulesResponse);
}

// -----------------------------------------------------------------------------
//  Error Model (for REST gateway compatibility, optional)
// -----------------------------------------------------------------------------

// Represents a structured application error payload.  gRPC clients should rely
// on `grpc::Status`, but REST/Gateway consumers benefit from a JSON body.
message Error {
    int32                       http_status = 1;
    google.rpc.Status           status      = 2;
}
