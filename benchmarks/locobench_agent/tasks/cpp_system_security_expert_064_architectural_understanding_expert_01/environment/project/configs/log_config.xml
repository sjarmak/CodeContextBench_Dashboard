<?xml version="1.0" encoding="UTF-8"?>
<!--
    FortiLedger360 Enterprise Security Suite
    Logging Configuration (log4cxx-compatible XML)

    This configuration defines a multi-tier, hierarchical logging strategy
    consistent with the platform’s layered architecture.  Log statements
    originating in individual services are tagged with tenant-scoped
    correlation IDs (MDC key: tenantId / corrId) so that the central
    observability stack (Elastic/Prometheus/Loki) can stitch together
    distributed traces.

    Appenders
    ─────────
      • CONSOLE_JSON   : stdout in JSON for systemd-journald + fluent-bit
      • CONSOLE_COLOR  : human-readable console output for local dev
      • ROLLING_SECURE : encrypted, size-based rolling file for PII/SPI
      • SYSLOG_SEC     : RFC-5424 syslog to FortiSyslog aggregator

    Loggers (selected)
    ───────────────────
      • root                  : WARN (inherits ROLLING_SECURE)
      • com.fortiledger.api   : INFO  (CONSOLE_JSON, SYSLOG_SEC)
      • com.fortiledger.core  : DEBUG (ROLLING_SECURE)
      • com.fortiledger.scan  : INFO  (CONSOLE_JSON, SYSLOG_SEC)
      • com.fortiledger.tests : OFF   (disabled in production)

    Filters & Policies
    ───────────────────
      • DenyTraceFilter : strips out TRACE in production
      • BurstFilter     : throttles identical WARN/ERROR bursts
      • RegexFilter     : redacts credit-card & secret tokens

    Rotation Policy
    ───────────────
      • 100 MB files
      • 5 archived logs retained
      • Gzip compression
-->

<Configuration status="OFF">
    <!-- ========================================================= -->
    <!-- Shared Layouts                                            -->
    <!-- ========================================================= -->
    <Properties>
        <!-- ISO-8601 w/ timezone -->
        <Property name="ISO_TS">%d{ISO8601_TIME_ZONE}</Property>

        <!-- JSON pattern for structured logging -->
        <Property name="JSON_PATTERN">
            {
                "ts"  : "%d{UNIX_MILLIS}",
                "lvl" : "%p",
                "svc" : "%c",
                "tid" : "%t",
                "corr": "%X{corrId}",
                "ten" : "%X{tenantId}",
                "msg" : "%enc{%m}{JSON}",
                "src" : "%C{1}.%M:%L"
            }
        </Property>

        <!-- Human-friendly colorized pattern -->
        <Property name="COLOR_PATTERN">%highlight{${ISO_TS} [%p] %c{1}(%t) ‑ %m }%n</Property>

        <!-- File layout (PII redaction handled by filter) -->
        <Property name="FILE_PATTERN">${ISO_TS} %p [%c{1}] (%t) %X{tenantId} %X{corrId} - %m%n</Property>
    </Properties>

    <!-- ========================================================= -->
    <!-- Appenders                                                 -->
    <!-- ========================================================= -->
    <Appenders>

        <!-- 1. Structured JSON to stdout (fluent-bit reads it) -->
        <Console name="CONSOLE_JSON" target="SYSTEM_OUT">
            <PatternLayout pattern="${JSON_PATTERN}"/>
            <!-- Drop verbose TRACE in production -->
            <Filters>
                <ThresholdFilter level="TRACE" onMatch="DENY" onMismatch="NEUTRAL"/>
            </Filters>
        </Console>

        <!-- 2. Colored console for local debugging -->
        <Console name="CONSOLE_COLOR" target="SYSTEM_OUT">
            <PatternLayout pattern="${COLOR_PATTERN}"/>
            <Filters>
                <ThresholdFilter level="DEBUG" onMatch="ACCEPT" onMismatch="DENY"/>
            </Filters>
        </Console>

        <!-- 3. Encrypted rolling file for security-sensitive logs -->
        <RollingFile name="ROLLING_SECURE"
                     fileName="/var/log/fortiledger/secure.log"
                     filePattern="/var/log/fortiledger/secure.%i.log.gz"
                     append="true" immediateFlush="false">
            <PatternLayout pattern="${FILE_PATTERN}"/>
            <Policies>
                <!-- Rotate at 100MB -->
                <SizeBasedTriggeringPolicy size="100 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="5"/>
        </RollingFile>

        <!-- 4. Syslog to centralized FortiSyslog -->
        <Syslog name="SYSLOG_SEC"
                format="RFC5424"
                host="syslog.mesh.svc.cluster.local"
                port="6514"
                protocol="TCP"
                appName="FortiLedger360"
                facility="LOCAL0"
                mdcId="corrId"
                enterpriseNumber="45956"
                newLine="false"
                ssl="true"
                sslCertPath="/etc/ssl/certs/fortiledger.pem"
                sslKeyPath="/etc/ssl/private/fortiledger.key">
            <PatternLayout pattern="%p %c - %m"/>
        </Syslog>
    </Appenders>

    <!-- ========================================================= -->
    <!-- Loggers                                                   -->
    <!-- ========================================================= -->

    <Loggers>

        <!-- Root logger: only WARN+, inherits secure file -->
        <Root level="warn">
            <AppenderRef ref="ROLLING_SECURE"/>
        </Root>

        <!-- API Layer (Presentation) -->
        <Logger name="com.fortiledger.api" level="info" additivity="false">
            <AppenderRef ref="CONSOLE_JSON"/>
            <AppenderRef ref="SYSLOG_SEC"/>
        </Logger>

        <!-- Orchestration & Domain layer -->
        <Logger name="com.fortiledger.core" level="debug" additivity="false">
            <AppenderRef ref="ROLLING_SECURE"/>
        </Logger>

        <!-- Scanner service -->
        <Logger name="com.fortiledger.scan" level="info" additivity="false">
            <AppenderRef ref="SYSLOG_SEC"/>
            <AppenderRef ref="CONSOLE_JSON"/>
        </Logger>

        <!-- Metrics Service -->
        <Logger name="com.fortiledger.metrics" level="info" additivity="false">
            <AppenderRef ref="CONSOLE_JSON"/>
        </Logger>

        <!-- Backup & Recovery -->
        <Logger name="com.fortiledger.backup" level="debug" additivity="true"/>

        <!-- Config Manager -->
        <Logger name="com.fortiledger.config" level="info" additivity="false">
            <AppenderRef ref="ROLLING_SECURE"/>
        </Logger>

        <!-- Unit / Integration tests are silenced in prod -->
        <Logger name="com.fortiledger.tests" level="off"/>

    </Loggers>
</Configuration>