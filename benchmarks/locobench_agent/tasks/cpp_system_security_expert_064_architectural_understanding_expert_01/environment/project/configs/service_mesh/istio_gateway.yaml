# -------------------------------------------------------------------------------------------------
# FortiLedger360 – Istio Ingress Gateway & Policy Stack
#
# This configuration exposes FortiLedger360’s public-facing entry-points, enforces mTLS-everywhere,
# and wires in tenant-aware, zero-trust policies.  All resources live in the dedicated
# “fortiledger360” namespace to keep service-mesh objects isolated from the global control-plane.
#
#   Objects included:
#     • Gateway              – Edge listener with STRICT mutual-TLS
#     • VirtualService       – Host-based routing to mesh workloads
#     • DestinationRule      – STRICT mesh-internal mTLS + subset pinning
#     • ServiceEntry         – Controlled egress to external vulnerability DB
#     • RequestAuthentication – JWT validation for API calls
#     • AuthorizationPolicy  – Scope-based, least-privilege RBAC
#     • EnvoyFilter          – Lua snippet that rejects requests lacking “x-tenant-id”
#
# NOTE:
#   – Cipher suites and TLS versions satisfy PCI-DSS & SOC-2 hardening.
#   – Update credentialName/hosts to match your certificate secrets and FQDNs.
# -------------------------------------------------------------------------------------------------

---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: fortiledger360-ingress-gw
  namespace: fortiledger360
  labels:
    app.kubernetes.io/name: fortiledger360-ingress-gw
    app.kubernetes.io/part-of: fortiledger360
    app.kubernetes.io/component: ingress
spec:
  selector:
    istio: ingressgateway               # Ties this Gateway to istio-ingressgateway DaemonSet
  servers:
    - port:
        number: 443
        name: https
        protocol: HTTPS
      hosts:
        - "api.fortiledger360.example.com"
        - "metrics.fortiledger360.example.com"
        - "backup.fortiledger360.example.com"
      tls:
        mode: MUTUAL                     # Require a client cert at the edge
        credentialName: fortiledger-credential  # Reconciled by cert-manager
        minProtocolVersion: TLSV1_2
        maxProtocolVersion: TLSV1_3
        cipherSuites:
          - ECDHE-ECDSA-AES256-GCM-SHA384
          - ECDHE-RSA-AES256-GCM-SHA384
          - ECDHE-ECDSA-CHACHA20-POLY1305
          - ECDHE-RSA-CHACHA20-POLY1305
        subjectAltNames:
          - "api.fortiledger360.internal"
          - "metrics.fortiledger360.internal"
          - "backup.fortiledger360.internal"
      # Inject security headers for browser-based clients
      headers:
        response:
          add:
            Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fortiledger360-routing
  namespace: fortiledger360
spec:
  hosts:
    - "api.fortiledger360.example.com"
    - "metrics.fortiledger360.example.com"
    - "backup.fortiledger360.example.com"
  gateways:
    - fortiledger360-ingress-gw
  http:
    # ----------------------------------------------------------------------------
    # Orchestrator – handles Command bus (InitiateSecurityScan, RollClusterBackup)
    # ----------------------------------------------------------------------------
    - match:
        - uri:
            prefix: /api/v1/
      route:
        - destination:
            host: orchestrator.fortiledger360.svc.cluster.local
            port:
              number: 8080
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: gateway-error,connect-failure,refused-stream
      headers:
        request:
          add:
            X-Env: "production"

    # ------------------------------
    # Metrics – Prometheus-compatible
    # ------------------------------
    - match:
        - uri:
            regex: "/metrics(/.*)?"
      route:
        - destination:
            host: metrics.fortiledger360.svc.cluster.local
            port:
              number: 9090
      timeout: 2s

    # ----------------------------
    # Backup – Long-running uploads
    # ----------------------------
    - match:
        - uri:
            prefix: /backup/
      route:
        - destination:
            host: backup.fortiledger360.svc.cluster.local
            port:
              number: 8443
      corsPolicy:
        allowOrigins:
          - regex: "https?://.*\\.fortiledger360\\.example\\.com"
        allowMethods: [GET, POST]
        allowCredentials: true
        maxAge: "24h"

    # ---------------
    # Default – 404/NR
    # ---------------
    - route:
        - destination:
            host: blackhole.istio.io
            port:
              number: 80

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: fortiledger360-mtls-strict
  namespace: fortiledger360
spec:
  host: "*.fortiledger360.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL              # Enforce STRICT mTLS inside the mesh
      minProtocolVersion: TLSV1_2
      maxProtocolVersion: TLSV1_3
      cipherSuites:
        - ECDHE-ECDSA-AES256-GCM-SHA384
        - ECDHE-RSA-AES256-GCM-SHA384
        - ECDHE-ECDSA-CHACHA20-POLY1305
        - ECDHE-RSA-CHACHA20-POLY1305
  subsets:
    - name: v1
      labels: {version: v1}
    - name: v2
      labels: {version: v2}

---
# Grant egress to Fortinet’s vulnerability database over HTTPS.
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: vuln-db-egress
  namespace: fortiledger360
spec:
  hosts:
    - "vulndb.fortinet.com"
  location: MESH_EXTERNAL
  resolution: DNS
  ports:
    - number: 443
      name: https
      protocol: HTTPS
  tls:
    mode: SIMPLE
    caCertificates: /etc/ssl/certs/ca-bundle.crt
  endpoints:
    - address: "vulndb.fortinet.com"

---
# JWT validation for any pod labeled “app.kubernetes.io/name=orchestrator”.
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: fortiledger360-jwt-auth
  namespace: fortiledger360
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: orchestrator
  jwtRules:
    - issuer: "https://auth.fortiledger360.example.com/"
      audiences: ["fortiledger360"]
      jwksUri: "https://auth.fortiledger360.example.com/.well-known/jwks.json"

---
# Allow only authenticated principals bearing the correct OAuth2 scopes.
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: fortiledger360-global-policy
  namespace: fortiledger360
spec:
  selector:
    matchLabels:
      security.istio.io/tlsMode: "istio"
  rules:
    - from:
        - source:
            requestPrincipals: ["*/service-account-issuer"]
      to:
        - operation:
            methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    - when:
        - key: request.auth.claims[scope]
          values: ["mesh.read", "mesh.write"]

---
# Reject requests that don’t propagate tenant context “x-tenant-id”.
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: add-tenant-id-header
  namespace: fortiledger360
spec:
  workloadSelector:
    labels:
      app.kubernetes.io/part-of: fortiledger360
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
            inlineCode: |
              function envoy_on_request(request_handle)
                local tenant_id = request_handle:headers():get("x-tenant-id")
                if tenant_id == nil then
                  request_handle:respond(
                    {[":status"] = "400"},
                    "missing header: x-tenant-id"
                  )
                end
              end
---
# END OF FILE