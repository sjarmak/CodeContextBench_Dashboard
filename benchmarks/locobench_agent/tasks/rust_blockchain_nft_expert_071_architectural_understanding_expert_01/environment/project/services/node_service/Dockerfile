Dockerfile
# syntax=docker/dockerfile:1.4
###############################################################################
# CanvasChain Symphony â€“ Node Service
# Multi-stage Dockerfile for a production-grade Rust micro-service that exposes
# a gRPC API and auxiliary HTTP/JSON admin endpoints.
#
# Stages
#   1. planner : Generate an aggregate Cargo dependency graph (cargo-chef)
#   2. builder : Compile the application in release mode
#   3. runtime : Ship a minimal runtime image (non-root) with only the binary
#
# Build example:
#   docker buildx build --platform linux/amd64,linux/arm64 \
#       --build-arg RUST_VERSION=1.72.0 \
#       -t ghcr.io/canvaschain/node-service:latest .
###############################################################################

########################
# 1. Dependency Planner
########################
ARG RUST_VERSION=1.72.0

FROM rust:${RUST_VERSION}-slim-bookworm AS planner

LABEL stage=planner \
      org.opencontainers.image.authors="CanvasChain Engineering <eng@canvaschain.io>" \
      org.opencontainers.image.documentation="https://docs.canvaschain.io"

# `cargo-chef` allows Docker build-cache reuse between code changes by
# factoring out dependency compilation into its own layer.
RUN cargo install cargo-chef --locked

WORKDIR /app
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

####################
# 2. Release Builder
####################
FROM rust:${RUST_VERSION}-slim-bookworm AS builder

# Install build dependencies only (protobuf, openssl headers, etc.)
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        protobuf-compiler \
        pkg-config \
        libssl-dev \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN cargo install cargo-chef --locked
WORKDIR /app

# Leverage cached dependency layer generated by the planner stage
COPY --from=planner /app/recipe.json recipe.json
RUN cargo chef cook --release --recipe-path recipe.json

# Copy rest of sources & compile the binary
COPY . .

# Enable BuildKit cache mounts for faster incremental builds
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo build --release --bin node_service

##################
# 3. Slim Runtime
##################
FROM debian:bookworm-slim AS runtime

ENV APP_USER=canvas
LABEL org.opencontainers.image.title="CanvasChain Node Service" \
      org.opencontainers.image.description="gRPC node microservice for CanvasChain Symphony" \
      org.opencontainers.image.source="https://github.com/canvaschain/symphony" \
      org.opencontainers.image.licenses="Apache-2.0"

# Install runtime libs (OpenSSL, CA certs)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        openssl \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user for security
RUN useradd --create-home --shell /usr/sbin/nologin ${APP_USER}

WORKDIR /app

# Copy the statically-linked (or mostly-static) binary
COPY --from=builder /app/target/release/node_service /usr/local/bin/node_service

# Optional: default config shipped with the container
COPY config/docker_node.yaml /etc/canvas/node.yaml

USER ${APP_USER}

# gRPC + admin HTTP ports
EXPOSE 50051/tcp 8080/tcp

# Logging & config env vars
ENV RUST_LOG=info,canvas_chain=info \
    NODE_CONFIG=/etc/canvas/node.yaml

# Healthcheck calls a lightweight internal sub-command implemented by
# the service itself, avoiding curl/wget dependencies.
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD [ "node_service", "--healthcheck" ]

ENTRYPOINT [ "/usr/local/bin/node_service" ]
CMD [ "--config", "/etc/canvas/node.yaml" ]
