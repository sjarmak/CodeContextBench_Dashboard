# syntax=docker/dockerfile:1.4
######################################################################
# CanvasChain Symphony â€“ Minting Service                              #
#                                                                    #
# Production-grade, multi-stage build for the Rust-based microservice #
# `minting_service`. Optimised for deterministic, reproducible and   #
# cache-efficient CI pipelines.                                       #
######################################################################

###############
#   BUILDER   #
###############
FROM --platform=$BUILDPLATFORM rust:1.74-slim-bookworm AS chef
LABEL stage=chef
WORKDIR /workspace

# -------- Dependencies required to build gRPC + cryptography --------
RUN apt-get update -yqq \
    && apt-get install -y --no-install-recommends \
        pkg-config clang protobuf-compiler \
        libssl-dev ca-certificates curl \
    && rm -rf /var/lib/apt/lists/*

# -------- cargo-chef collects and cooks the dependency graph --------
# cargo-chef significantly improves incremental builds in CI/CD by
# caching all dependencies independently from the project source.
RUN cargo install --version "^0.1" cargo-chef

# Copy manifests *only* (no source code) to leverage Docker cache.
COPY Cargo.toml Cargo.lock ./
# Copy all workspace Cargo.toml files (if any)
COPY services ./services
RUN cargo chef prepare --recipe-path recipe.json


FROM --platform=$BUILDPLATFORM rust:1.74-slim-bookworm AS builder
LABEL stage=builder
WORKDIR /workspace

# Re-use the identical toolchain & system dependencies
RUN apt-get update -yqq \
    && apt-get install -y --no-install-recommends \
        pkg-config clang protobuf-compiler \
        libssl-dev ca-certificates curl \
    && rm -rf /var/lib/apt/lists/*

# Copy the dependency recipe generated by the chef stage.
COPY --from=chef /workspace/recipe.json recipe.json
RUN cargo chef cook --release --recipe-path recipe.json

# Copy *all* project sources now that dependency layers are cached.
COPY . .

# Build only the target binary for the minting service
ARG BIN_NAME=minting_service
RUN --mount=type=cache,target=/workspace/target \
    cargo build --package ${BIN_NAME} --release

################
#   RUNTIME    #
################
FROM gcr.io/distroless/cc-debian11 AS runtime
LABEL maintainer="CanvasChain Core <dev@canvaschain.io>"
LABEL org.opencontainers.image.source="https://github.com/canvaschain/symphony"
LABEL org.opencontainers.image.description="CanvasChain Symphony Minting Service"

# Non-root user for better security posture.
USER 1001:1001
WORKDIR /app

# Copy the statically linked executable from the builder.
COPY --from=builder /workspace/target/release/minting_service ./minting_service

# Expose the gRPC port (configurable via ENV in k8s / docker-compose)
EXPOSE 50051/tcp

# Basic liveness probe using the built-in health endpoint.
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s \
    CMD ["/app/minting_service", "--healthcheck"]

# Environment variables with sane defaults, overridable at runtime.
ENV RUST_LOG=info \
    SERVICE__GRPC_HOST=0.0.0.0 \
    SERVICE__GRPC_PORT=50051

ENTRYPOINT ["/app/minting_service"]