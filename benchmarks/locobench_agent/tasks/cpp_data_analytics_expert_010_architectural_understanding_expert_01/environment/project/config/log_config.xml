<?xml version="1.0" encoding="UTF-8"?>
<!--
    CardioInsight360 – Unified Healthcare Analytics Engine
    Logging Configuration

    This file configures log4cplus (https://github.com/log4cplus/log4cplus)
    and is parsed at application bootstrap by the LoggingSubsystem.

    The configuration supports five log targets:
        • console     – development / CI visibility
        • rollingFile – persistent rotating file logs
        • auditFile   – tamper-evident append-only audit trail
        • kafkaBus    – asynchronous stream for centralized log aggregation
        • syslog      – optional, enabled on Linux production nodes

    Build-time and run-time environment variables:
        LOG_CFG_LOG_LEVEL             – overrides the global log level
        LOG_CFG_BASE_PATH             – overrides the default directory (/var/log/cardio_insight_360)
        LOG_CFG_NODE_ID               – logical host identifier injected as MDC tag
        LOG_CFG_ENABLE_SYSLOG=true    – toggles the syslog appender

    Security Considerations:
        • Audit trail uses an append-only file with ‘0640’ permissions.
        • Sensitive PHI is scrubbed by the LogSanitizer filter chained at the root.
        • syslog traffic is tunneled over TLS where supported by rsyslog.
-->
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">

<log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">

    <!-- ================================================================== -->
    <!-- Properties                                                         -->
    <!-- ================================================================== -->
    <log4j:properties>
        <!-- Override at runtime by env-vars or JVM options -->
        <property name="LOG_PATH" value="${LOG_CFG_BASE_PATH:-/var/log/cardio_insight_360}" />
        <property name="LOG_LEVEL" value="${LOG_CFG_LOG_LEVEL:-INFO}" />
        <property name="NODE_ID"   value="${LOG_CFG_NODE_ID:-unknown-node}" />
    </log4j:properties>

    <!-- ================================================================== -->
    <!-- Layout Patterns                                                    -->
    <!-- ================================================================== -->
    <log4j:layout name="PatternLayoutShort" class="log4cplus::PatternLayout">
        <param name="ConversionPattern"
               value="%D{%Y-%m-%d %H:%M:%S.%q} | %-5p | %c{1} | %m%n"/>
    </log4j:layout>

    <log4j:layout name="PatternLayoutExtended" class="log4cplus::PatternLayout">
        <param name="ConversionPattern"
               value="%D{%Y-%m-%d %H:%M:%S.%q} | %-5p | %c | %x | node=%X{nodeId} | %m%n"/>
    </log4j:layout>

    <!-- ================================================================== -->
    <!-- Filters                                                            -->
    <!-- ================================================================== -->
    <!-- Filter scrubber for PHI & PII -->
    <log4j:filter name="LogSanitizer" class="ci360::logging::filters::SanitizerFilter" />

    <!-- Drop DEBUG statements in production -->
    <log4j:filter name="DenyDebugInProd" class="log4cplus::spi::DenyAllFilter">
        <param name="condition" value="${CI360_ENV:-dev} == prod && level == DEBUG"/>
    </log4j:filter>

    <!-- ================================================================== -->
    <!-- Appenders                                                          -->
    <!-- ================================================================== -->

    <!-- Console ---------------------------------------------------------- -->
    <log4j:appender name="console" class="log4cplus::ConsoleAppender">
        <log4j:layout ref="PatternLayoutShort" />
        <log4j:filter ref="LogSanitizer" />
    </log4j:appender>

    <!-- Rolling File ----------------------------------------------------- -->
    <log4j:appender name="rollingFile" class="log4cplus::RollingFileAppender">
        <param name="File"            value="${LOG_PATH}/ci360-rolling.log"/>
        <param name="MaxFileSize"     value="50MB" />
        <param name="MaxBackupIndex"  value="7" />
        <param name="Append"          value="true" />
        <log4j:layout ref="PatternLayoutExtended" />
        <log4j:filter ref="LogSanitizer" />
    </log4j:appender>

    <!-- Audit File (append-only, for compliance) ------------------------- -->
    <log4j:appender name="auditFile" class="ci360::logging::AppendOnlyFileAppender">
        <param name="File"           value="${LOG_PATH}/ci360-audit.log" />
        <param name="FilePermissions" value="640" />
        <log4j:layout ref="PatternLayoutExtended" />
        <!-- Audit ALL messages, including TRACE -->
    </log4j:appender>

    <!-- Kafka Bus -------------------------------------------------------- -->
    <log4j:appender name="kafkaBus" class="ci360::logging::KafkaAppender">
        <!-- librdkafka producer configuration -->
        <param name="Brokers"        value="${KAFKA_BROKERS:-localhost:9092}" />
        <param name="Topic"          value="ci360.logs" />
        <param name="Acks"           value="all" />
        <param name="Compression"    value="lz4" />
        <log4j:layout ref="PatternLayoutExtended" />
        <log4j:filter ref="LogSanitizer" />
    </log4j:appender>

    <!-- Syslog (optional) ------------------------------------------------ -->
    <log4j:appender name="syslog" class="log4cplus::SysLogAppender">
        <param name="Host"           value="${SYSLOG_HOST:-localhost}" />
        <param name="Facility"       value="LOG_LOCAL4" />
        <param name="Port"           value="514" />
        <param name="UseTls"         value="true" />
        <log4j:layout ref="PatternLayoutExtended" />
        <log4j:filter ref="LogSanitizer" />
        <log4j:filter ref="DenyDebugInProd" />
        <!-- Disabled by default; activated via ENABLE_SYSLOG -->
        <param name="Enabled"        value="${LOG_CFG_ENABLE_SYSLOG:-false}" />
    </log4j:appender>

    <!-- ================================================================== -->
    <!-- Loggers                                                            -->
    <!-- ================================================================== -->
    <!-- Root Logger (inherits all appenders) -->
    <log4j:root>
        <priority value="${LOG_LEVEL}" />
        <appender-ref ref="console"/>
        <appender-ref ref="rollingFile"/>
        <appender-ref ref="auditFile"/>
        <appender-ref ref="kafkaBus"/>
        <appender-ref ref="syslog"/>
        <filter-ref ref="LogSanitizer" />
    </log4j:root>

    <!-- Component-specific loggers --------------------------------------- -->
    <log4j:logger name="ci360.etl" additivity="false">
        <priority value="INFO"/>
        <appender-ref ref="rollingFile"/>
        <appender-ref ref="kafkaBus"/>
    </log4j:logger>

    <log4j:logger name="ci360.stream" additivity="false">
        <priority value="DEBUG"/>
        <appender-ref ref="console"/>
        <appender-ref ref="rollingFile"/>
    </log4j:logger>

    <log4j:logger name="ci360.validation" additivity="false">
        <priority value="WARN"/>
        <appender-ref ref="rollingFile"/>
        <appender-ref ref="auditFile"/>
    </log4j:logger>

    <log4j:logger name="ci360.visualization" additivity="true">
        <priority value="INFO"/>
        <!-- inherits root appenders -->
    </log4j:logger>

    <!-- Third-party noisy libraries muted to WARN ------------------------- -->
    <log4j:logger name="rdkafka" additivity="false">
        <priority value="WARN"/>
        <appender-ref ref="rollingFile"/>
    </log4j:logger>

    <!-- MDC Defaults ------------------------------------------------------ -->
    <!-- The init-block is executed by ci360::logging::Configurator         -->
    <log4j:context>
        <key name="nodeId" value="${NODE_ID}" />
    </log4j:context>

</log4j:configuration>
