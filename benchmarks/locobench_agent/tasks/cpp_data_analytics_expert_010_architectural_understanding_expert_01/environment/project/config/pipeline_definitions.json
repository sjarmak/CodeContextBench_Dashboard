{
  "$schema": "https://cardioinsight360.dev/schemas/pipeline_definitions.schema.json",
  "version": "2.4.0",
  "generated_at_utc": "2024-05-20T00:00:00Z",

  "globals": {
    "kafka": {
      "brokers": "kafka-prod-01.hospital.net:9092,kafka-prod-02.hospital.net:9092",
      "security_protocol": "sasl_ssl",
      "sasl_mechanism": "SCRAM-SHA-512",
      "ssl_ca_location": "/etc/pki/ci360/ca.pem",
      "ssl_certificate_location": "/etc/pki/ci360/client.crt",
      "ssl_key_location": "/etc/pki/ci360/client.key"
    },
    "storage": {
      "raw_root":  "/var/opt/ci360/data_lake/raw",
      "curated_root": "/var/opt/ci360/data_lake/curated",
      "compression": "zstd",
      "parquet": {
        "row_group_size": 512000,
        "page_compression": "zstd"
      }
    },
    "retry_defaults": {
      "retries": 5,
      "backoff": "exponential",
      "initial_delay_ms": 250,
      "max_delay_ms": 10000
    }
  },

  "pipelines": {
    "real_time_ecg_stream": {
      "description": "Low-latency ECG waveform processing and arrhythmia detection.",
      "type": "stream",
      "enabled": true,

      "source": {
        "kind": "kafka",
        "topic": "cis.ecg.raw.vitals",
        "format": "avro",
        "compression": "snappy",
        "max_batch_size": 5000,
        "timeout_ms": 1500
      },

      "sink": {
        "kind": "kafka",
        "topic": "cis.ecg.curated.vitals",
        "format": "parquet",
        "compression": "zstd"
      },

      "pre_conditions": [
        "network.latency < 30ms",
        "kafka.cluster.health == GREEN"
      ],

      "steps": [
        {
          "id": "validate_schema",
          "module": "cardio::validation::AvroSchemaValidator",
          "retry_policy": { "retries": 3, "backoff": "exponential" },
          "on_failure": "DLQ:cis.ecg.validation.errors"
        },
        {
          "id": "quality_gate",
          "module": "cardio::quality::SignalNoiseChecker",
          "config": { "snr_threshold_db": 16.0 },
          "retry_policy": { "retries": 2 }
        },
        {
          "id": "transform_to_physical_units",
          "module": "cardio::transform::ScaleWaveform",
          "config": { "lsb_weight_uV": 4.88 }
        },
        {
          "id": "detect_arrhythmia",
          "module": "cardio::algo::ArrhythmiaClassifier",
          "config": { "model_version": "r4.1.0" },
          "parallelism": {
            "threads": 8,
            "batch_size": 1024
          }
        }
      ],

      "post_actions": [
        "metrics.emit",
        "audit.log"
      ]
    },

    "nightly_cohort_analytics": {
      "description": "Batch ETL that aggregates previous day's vitals to compute cohort statistics for research dashboards.",
      "type": "batch",
      "enabled": true,

      "schedule": "0 3 * * *",     /* everyday at 03:00 local time */
      "sla_minutes": 180,

      "source": {
        "kind": "filesystem",
        "path": "${storage.raw_root}/ecg/%Y/%m/%d",
        "format": "parquet",
        "partitioning": "yyyy/MM/dd"
      },

      "sink": {
        "kind": "filesystem",
        "path": "${storage.curated_root}/cohorts/ecg/%Y/%m/%d",
        "format": "parquet",
        "partitioning": "yyyy/MM/dd"
      },

      "resources": {
        "tbb_threads": 24,
        "memory_limit_mb": 8192
      },

      "steps": [
        {
          "id": "merge_partitions",
          "module": "cardio::etl::PartitionMerger",
          "config": { "output_row_group_size": 1048576 }
        },
        {
          "id": "signal_statistics",
          "module": "cardio::analytics::SignalStats",
          "config": {
            "metrics": [ "mean_rr", "sdnn", "pnn50", "rmssd" ]
          }
        },
        {
          "id": "compute_cohorts",
          "module": "cardio::analytics::CohortBuilder",
          "config": { "icd10_filter": [ "I21", "I22", "I50" ] }
        },
        {
          "id": "write_results",
          "module": "cardio::sink::ParquetWriter",
          "retry_policy": { "retries": 3 },
          "on_failure": "rollback"
        }
      ],

      "notifications": {
        "on_success": [ "email:analytics-team@hospital.net" ],
        "on_failure": [ "pagerduty:ci360_oncall" ]
      }
    },

    "dicom_image_harvester": {
      "description": "Periodic polling of PACS archive for new cardiac CT studies and converting them to Parquet-based voxel cubes.",
      "type": "batch",
      "enabled": false,

      "schedule": "*/15 * * * *",  /* every 15 minutes */
      "sla_minutes": 45,

      "source": {
        "kind": "dicom_pacs",
        "aet": "CI360_INGEST",
        "host": "pacs-ct.hospital.net",
        "port": 104,
        "query": {
          "modality": "CT",
          "body_part": "HEART",
          "study_date": "TODAY"
        }
      },

      "sink": {
        "kind": "filesystem",
        "path": "${storage.curated_root}/imagery/ct/${StudyInstanceUID}",
        "format": "parquet",
        "partitioning": "none"
      },

      "steps": [
        {
          "id": "validate_dicom_metadata",
          "module": "cardio::validation::DicomMetadataValidator",
          "retry_policy": "${retry_defaults}"
        },
        {
          "id": "convert_to_voxel_cube",
          "module": "cardio::transform::DicomToVoxelParquet",
          "config": { "isotropic_voxel_mm": 0.5 }
        }
      ],

      "post_actions": [
        "metrics.emit",
        "audit.log"
      ]
    }
  }
}