```yaml
# =====================================================================
# GitHub Actions Workflow: CI / CD Pipeline for SprintCart Pro
#
# This workflow performs the following stages:
#   1. Build & Test            ‚Äì compile the Java code base and run all tests
#   2. Static Code Analysis     ‚Äì run SonarCloud scan and enforce quality gate
#   3. Build & Push Image       ‚Äì create a multi-arch Docker image and push to GHCR
#   4. Deploy to Staging        ‚Äì roll out the image to the staging K8s cluster
#   5. Smoke Test               ‚Äì run a lightweight health-check against staging
#
# NOTE:
#   ‚Äì Any secrets referenced below must be configured in the repository
#     or organization settings under ‚ÄúSettings ‚Üí Secrets ‚Üí Actions‚Äù.
#   ‚Äì The pipeline adheres to trunk-based development: only `main`
#     (and matching release branches) are eligible for deployment.
# =====================================================================

name: CI / CD Pipeline

on:
  push:
    branches: [main, 'release/**']
  pull_request:
    branches: [main]
  workflow_dispatch:        # manual trigger

# ---------------------------------------------------------------------
# Shared environment variables
# ---------------------------------------------------------------------
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: sprintcart-pro

# ---------------------------------------------------------------------
# JOB: Build & Test
# ---------------------------------------------------------------------
jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # Conservative default permissions ‚Äì overridden where necessary
    permissions:
      contents: read
      packages: write
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        java: [17, 21]       # Validate against LTS & latest JDK

    steps:
      - name: ‚è≥ Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è  Set up Temurin JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: üóÑÔ∏è  Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: üß™ Run unit & integration tests
        run: mvn -B clean verify --file pom.xml

      - name: üì¶ Archive test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports-${{ matrix.java }}
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml

# ---------------------------------------------------------------------
# JOB: Static Code Analysis with SonarCloud
# ---------------------------------------------------------------------
  sonar-quality-gate:
    name: Static Code Analysis
    needs: build-test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: ‚öôÔ∏è  Set up JDK 17 (required by SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: üîç SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: sprintcart-pro
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORG }}

      # Fail the build if quality gate is red
      - name: üõ°Ô∏è  Enforce Quality Gate
        uses: sonarsource/sonarcloud-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

# ---------------------------------------------------------------------
# JOB: Build & Push Docker Image
# ---------------------------------------------------------------------
  build-image:
    name: Build & Push Docker Image
    needs: [build-test, sonar-quality-gate]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: üõ†Ô∏è  Set up QEMU (multi-arch builds)
        uses: docker/setup-qemu-action@v3

      - name: üõ†Ô∏è  Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîñ Extract project version from POM
        id: project_version
        run: |
          VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: üèóÔ∏è  Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ steps.project_version.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository }}:latest
          build-args: |
            JAR_FILE=target/app.jar

# ---------------------------------------------------------------------
# JOB: Deploy to Staging
# ---------------------------------------------------------------------
  deploy-staging:
    name: Deploy to Staging
    needs: build-image
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: staging
      url: https://staging.sprintcart.pro
    concurrency:
      group: deploy-staging
      cancel-in-progress: false

    steps:
      - name: üóÑÔ∏è  Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.28.0

      - name: üîê Configure kubeconfig
        run: |
          mkdir -p "$HOME/.kube"
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"

      - name: üöÄ Rollout to Kubernetes
        uses: azure/k8s-deploy@v4
        with:
          manifests: |
            infra/k8s/deployment.yml
            infra/k8s/service.yml
          images: |
            ${{ env.REGISTRY }}/${{ github.repository }}:latest
          imagepullsecrets: |
            ghcr-credentials

# ---------------------------------------------------------------------
# JOB: Smoke Test after deployment
# ---------------------------------------------------------------------
  smoke-test:
    name: Smoke Test
    needs: deploy-staging
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ‚è±Ô∏è  Wait for rollout
        run: |
          kubectl rollout status deployment/sprintcart-pro --timeout=120s

      - name: ü©∫ Health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://staging.sprintcart.pro/actuator/health)
          if [ "$STATUS" -ne 200 ]; then
            echo "Health check failed with status $STATUS"
            exit 1
          fi

      - name: üîî Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "channel": "#devops-alerts",
              "text": ":fire: *SprintCart Pro* staging deployment failed :fire:",
              "attachments": [
                {
                  "color": "danger",
                  "title": "Workflow run",
                  "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
```