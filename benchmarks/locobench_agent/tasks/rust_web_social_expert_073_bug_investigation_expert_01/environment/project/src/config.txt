```rust
//! src/config.txt
//! ===============================================================
//! Although placed in `src/config.txt` by convention of this task,
//! this file contains Rust source code that can be `include!`-d or
//! copied into a proper `config.rs` module.  It provides _strongly-
//! typed_, environment-aware configuration loading for the
//! “EduPulse Live” platform.
//!
//! The implementation uses the `config` crate to merge multiple
//! sources in the following precedence (highest ↠ lowest):
//!   1. Process environment variables (prefixed with `EDUPULSE_`)
//!   2. `{BASE_PATH}/local.{json|yaml|toml}` (developer overrides)
//!   3. `{BASE_PATH}/default.{json|yaml|toml}` (immutable defaults)
//!
//! All structures derive `Deserialize` and are therefore _data-
//! driven_; callers only need to care about the resulting strongly
//! typed `AppConfig` object.
//
// ---------------------------------------------------------------
//! Example ⤵️  (`default.yaml` sitting next to the binary):
//!
//! ```yaml
//! environment: "production"
//! database:
//!   driver: "postgres"
//!   url: "postgres://epulse:secret@db/edupulse_live"
//!   pool_size: 30
//! broker:
//!   host: "rabbitmq"
//!   port: 5672
//!   username: "mq_user"
//!   password: "mq_pass"
//!   vhost: "/edupulse"
//!   heartbeat_secs: 30
//! auth:
//!   jwt_secret: "super-secret-key"
//!   token_lifetime_minutes: 120
//!   password_salt_cost: 12
//! server:
//!   listen_addr: "0.0.0.0:8443"
//!   tls_cert_path: "/etc/edupulse/certs/fullchain.pem"
//!   tls_key_path: "/etc/edupulse/certs/privkey.pem"
//!   allowed_origins: ["https://edupulse.live"]
//!   session_key: "01234567890123456789012345678901"    # 256-bit
//!   redis_uri: "redis://redis:6379"
//!   redis_session_ttl_secs: 86_400
//! search:
//!   elasticsearch_url: "http://elasticsearch:9200"
//!   index_prefix: "edupulse_live_"
//!   batch_size: 250
//! ```
// ===============================================================

use std::{fmt, path::Path};

use config::{builder::DefaultState, Config, ConfigBuilder, Environment, File};
use serde::Deserialize;

/// A convenience alias for the error type exposed by the `config` crate.
pub type ConfigError = config::ConfigError;

/// Database connectivity and pooling parameters.
#[derive(Debug, Clone, Deserialize)]
pub struct DatabaseConfig {
    pub driver: String,
    pub url: String,
    pub pool_size: u32,
}

/// AMQP / message-broker settings.
#[derive(Debug, Clone, Deserialize)]
pub struct BrokerConfig {
    pub host: String,
    pub port: u16,
    pub username: String,
    pub password: String,
    pub vhost: String,
    pub heartbeat_secs: u64,
}

/// Authentication and authorization settings (JWT, OAuth, etc.).
#[derive(Debug, Clone, Deserialize)]
pub struct AuthConfig {
    /// Symmetric key used to sign/verify JWTs (HS256).
    pub jwt_secret: String,
    /// Short-lived access token in minutes.
    pub token_lifetime_minutes: u32,
    /// Bcrypt cost factor for hashing passwords.
    pub password_salt_cost: u8,

    /// Optional OAuth registration for Google.
    pub oauth_google_client_id: Option<String>,
    pub oauth_google_client_secret: Option<String>,

    /// Optional OAuth registration for Microsoft EDU.
    pub oauth_microsoft_client_id: Option<String>,
    pub oauth_microsoft_client_secret: Option<String>,
}

/// Public HTTP server and TLS termination layer configuration.
#[derive(Debug, Clone, Deserialize)]
pub struct ServerConfig {
    pub listen_addr: String,
    pub tls_cert_path: String,
    pub tls_key_path: String,

    /// CORS origins allowed to access the API.
    pub allowed_origins: Vec<String>,

    /// 32-byte key used for encrypting server-side sessions.
    pub session_key: String,

    /// Redis connection string (scheme://host:port/db).
    pub redis_uri: String,
    /// Sliding expiration for session keys.
    pub redis_session_ttl_secs: u64,
}

/// Search backend (OpenSearch/Elasticsearch) configuration.
#[derive(Debug, Clone, Deserialize)]
pub struct SearchConfig {
    pub elasticsearch_url: String,
    pub index_prefix: String,
    pub batch_size: u16,
}

/// Top-level strongly typed application configuration object.
///
/// All nested fields are flattened from the merged configuration
/// sources and validated by `serde`.
#[derive(Debug, Clone, Deserialize)]
pub struct AppConfig {
    pub environment: String,
    pub database: DatabaseConfig,
    pub broker: BrokerConfig,
    pub auth: AuthConfig,
    pub server: ServerConfig,
    pub search: SearchConfig,
}

impl AppConfig {
    /// Build an `AppConfig` from layered sources.
    ///
    /// `base_path` – directory containing `default.*` / `local.*` files.
    /// `env_prefix` – environment variable prefix (e.g. `"EDUPULSE"`).
    ///
    /// # Errors
    ///
    /// Returns `ConfigError` when reading or (de)serializing fails.
    pub fn from_sources<P: AsRef<Path>>(
        base_path: P,
        env_prefix: &str,
    ) -> Result<Self, ConfigError> {
        let mut builder = Config::builder();

        // --- 1. Files on disk ------------------------------------------------
        // Accepted extensions: json, toml, yaml, ron, etc.
        for name in &["default", "local"] {
            // Note: `required(false)` allows the file to be missing silently.
            builder = builder.add_source(
                File::with_name(
                    base_path
                        .as_ref()
                        .join(name)
                        .to_str()
                        .ok_or_else(|| ConfigError::Foreign(Box::new(
                            std::io::Error::new(
                                std::io::ErrorKind::InvalidInput,
                                "Non-UTF8 file path in configuration",
                            ),
                        )))?,
                )
                .required(false),
            );
        }

        // --- 2. Environment variables ---------------------------------------
        //
        //   `EDUPULSE_DATABASE__URL=postgres://...` maps to
        //   `database.url`  (double underscore ⇒ nested field)
        builder = builder.add_source(
            Environment::with_prefix(env_prefix)
                .separator("__")
                .try_parsing(true)
                .list_separator(","),
        );

        // --------------------------------------------------------------------
        builder.build()?.try_deserialize::<AppConfig>()
    }
}

// ---------------------------------------------------------------
//! Sanity tests – `cargo test -p <crate> --lib config`
// ---------------------------------------------------------------
#[cfg(test)]
mod tests {
    use super::*;
    use std::env;

    /// Ensure we can load configuration from synthetic sources.
    #[test]
    fn smoke_loads_from_defaults() {
        // Place temporary config files in a temp-dir.
        let dir = tempfile::tempdir().expect("tmpdir");

        std::fs::write(
            dir.path().join("default.yaml"),
            r#"
            environment: "test"
            database: { driver: "sqlite", url: "file::memory:", pool_size: 1 }
            broker:   { host: "localhost", port: 5672, username: "u", password: "p", vhost: "/", heartbeat_secs: 60 }
            auth:     { jwt_secret: "s", token_lifetime_minutes: 10, password_salt_cost: 4 }
            server:
              listen_addr: "127.0.0.1:0"
              tls_cert_path: "/tmp/cert.pem"
              tls_key_path:  "/tmp/key.pem"
              allowed_origins: ["*"]
              session_key: "01234567890123456789012345678901"
              redis_uri: "redis://localhost"
              redis_session_ttl_secs: 5
            search:
              elasticsearch_url: "http://localhost:9200"
              index_prefix: "test_"
              batch_size: 10
            "#,
        )
        .unwrap();

        // Override a single parameter via environment variable.
        env::set_var("EDUPULSE_DATABASE__POOL_SIZE", "8");

        let cfg = AppConfig::from_sources(dir.path(), "EDUPULSE").expect("load config");
        assert_eq!(cfg.environment.as_str(), "test");
        assert_eq!(cfg.database.pool_size, 8);

        // Clean up the env var to not pollute other tests.
        env::remove_var("EDUPULSE_DATABASE__POOL_SIZE");
    }
}

// ----------------------------------------------------------------
// Display helpers – useful for logging loaded configuration.
// ----------------------------------------------------------------
impl fmt::Display for AppConfig {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        // Avoid leaking secrets while still providing diagnostics.
        write!(
            f,
            "Env={} DB_URL={} LISTEN={} ...",
            self.environment,
            self.database.url,
            self.server.listen_addr,
        )
    }
}
```