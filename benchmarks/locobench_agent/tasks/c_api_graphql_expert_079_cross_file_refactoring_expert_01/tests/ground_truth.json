{
  "ground_truth": "The solution requires modifications across multiple directories. Key changes would include:\n\n**1. In `libs/sc_common/include/sc_errors.h`:**\n```c\n// New enum\ntypedef enum {\n    SC_DOMAIN_UNKNOWN,\n    SC_DOMAIN_COMMON,\n    SC_DOMAIN_GATEWAY,\n    SC_DOMAIN_PALETTE,\n    SC_DOMAIN_TEXTURE,\n    SC_DOMAIN_AUDIO,\n    SC_DOMAIN_NARRATIVE\n} sc_service_domain_t;\n\n// New struct\ntypedef struct {\n    sc_service_domain_t domain;\n    int code; // Original, internal error code\n    int http_status_code;\n    char* message;\n} sc_error_t;\n\n// New function prototypes\nsc_error_t* sc_error_create(sc_service_domain_t domain, int code, int http_status, const char* format, ...);\nvoid sc_error_destroy(sc_error_t* err);\n```\n\n**2. Example refactoring in `services/palette-service/src/palette_service.c`:**\n\n*Before:*\n```c\nint get_palette_by_id(const char* id, palette_t** palette) {\n    // ... database logic ...\n    if (db_result == NOT_FOUND) {\n        return SC_PALETTE_ERROR_NOT_FOUND; // e.g., -1\n    }\n    // ... more logic ...\n    return 0; // Success\n}\n```\n\n*After:*\n```c\n#include \"sc_errors.h\"\n\nsc_error_t* get_palette_by_id(const char* id, palette_t** palette) {\n    // ... database logic ...\n    if (db_result == NOT_FOUND) {\n        return sc_error_create(SC_DOMAIN_PALETTE, SC_PALETTE_ERROR_NOT_FOUND, 404, \"Palette with ID '%s' not found.\", id);\n    }\n    // ... more logic ...\n    return NULL; // Success\n}\n```\n\n**3. Example refactoring in `api-gateway/src/rest/fallback_handlers.c`:**\n\n*Logic Change:*\nThe handler that previously might have had a `switch` statement on an integer error code now receives an `sc_error_t*`. It can directly use the fields:\n```c\nvoid handle_service_error(http_request_t* req, http_response_t* res, sc_error_t* err) {\n    if (err) {\n        set_http_status(res, err->http_status_code);\n        set_json_response_body(res, \"{\\\"error\\\": \\\"%s\\\"}\", err->message);\n        sc_error_destroy(err); // Clean up the error object\n    } else {\n        // ... handle unexpected case where error is NULL\n    }\n}\n```\n\n**4. List of files expected to be modified:**\n- `libs/sc_common/include/sc_errors.h`\n- `libs/sc_common/src/sc_errors.c`\n- `services/palette-service/include/palette_service.h`\n- `services/palette-service/src/palette_service.c`\n- `services/palette-service/src/palette_repository.c`\n- `services/palette-service/src/palette_handler.c`\n- `services/palette-service/tests/test_palette_service.c`\n- `services/texture-service/include/texture_service.h`\n- `services/texture-service/src/texture_service.c`\n- `services/texture-service/src/texture_repository.c`\n- `services/texture-service/src/texture_handler.c`\n- `services/texture-service/tests/test_texture_service.c`\n- `api-gateway/src/services/service_client.c`\n- `api-gateway/src/rest/fallback_handlers.c` (or equivalent router/error handling logic)\n- `CMakeLists.txt` files for affected modules if new dependencies are introduced (unlikely here, but possible).",
  "context_files": [
    "SynestheticCanvas/services/palette-service/include/palette_service.h",
    "SynestheticCanvas/services/palette-service/src/palette_handler.c",
    "SynestheticCanvas/services/palette-service/src/palette_service.c",
    "SynestheticCanvas/services/palette-service/tests/test_palette_service.c",
    "SynestheticCanvas/services/texture-service/include/texture_service.h",
    "SynestheticCanvas/services/texture-service/src/texture_handler.c",
    "SynestheticCanvas/services/texture-service/src/texture_service.c",
    "SynestheticCanvas/services/texture-service/tests/test_texture_service.c",
    "SynestheticCanvas/services/audio-service/include/audio_service.h",
    "SynestheticCanvas/services/audio-service/src/audio_handler.c",
    "SynestheticCanvas/services/audio-service/src/audio_service.c",
    "SynestheticCanvas/services/audio-service/tests/test_audio_service.c",
    "SynestheticCanvas/services/narrative-service/include/narrative_service.h",
    "SynestheticCanvas/services/narrative-service/src/narrative_handler.c",
    "SynestheticCanvas/services/narrative-service/src/narrative_service.c",
    "SynestheticCanvas/services/narrative-service/tests/test_narrative_service.c",
    "SynestheticCanvas/libs/sc_common/include/sc_types.h",
    "SynestheticCanvas/libs/sc_common/include/sc_config.h",
    "SynestheticCanvas/libs/sc_common/include/sc_errors.h",
    "SynestheticCanvas/services/texture-service/src/models/texture.c",
    "SynestheticCanvas/services/texture-service/include/models/texture.h",
    "SynestheticCanvas/libs/sc_common/src/sc_config.c",
    "SynestheticCanvas/services/narrative-service/src/narrative_repository.c",
    "SynestheticCanvas/services/narrative-service/src/main.c",
    "SynestheticCanvas/services/narrative-service/include/models/narrative_node.h",
    "SynestheticCanvas/services/narrative-service/src/models/narrative_node.c",
    "SynestheticCanvas/services/audio-service/include/models/audio_stream.h",
    "SynestheticCanvas/services/palette-service/README.md",
    "SynestheticCanvas/services/audio-service/src/main.c",
    "SynestheticCanvas/services/palette-service/src/main.c",
    "SynestheticCanvas/docs/architecture/microservices.md",
    "SynestheticCanvas/services/texture-service/src/main.c",
    "SynestheticCanvas/libs/sc_common/include/sc_logging.h",
    "SynestheticCanvas/services/palette-service/src/palette_repository.c",
    "SynestheticCanvas/services/audio-service/src/audio_repository.c",
    "SynestheticCanvas/api-gateway/src/services/service_client.c",
    "SynestheticCanvas/libs/sc_common/src/sc_logging.c",
    "SynestheticCanvas/services/texture-service/src/texture_repository.c",
    "SynestheticCanvas/services/palette-service/src/models/palette.c",
    "SynestheticCanvas/api-gateway/src/rest/fallback_handlers.c",
    "SynestheticCanvas/services/texture-service/CMakeLists.txt",
    "SynestheticCanvas/services/narrative-service/CMakeLists.txt",
    "SynestheticCanvas/services/audio-service/src/models/audio_stream.c",
    "SynestheticCanvas/services/palette-service/include/models/palette.h",
    "SynestheticCanvas/libs/sc_common/src/sc_errors.c",
    "SynestheticCanvas/services/texture-service/README.md",
    "SynestheticCanvas/services/audio-service/README.md",
    "SynestheticCanvas/services/palette-service/CMakeLists.txt",
    "SynestheticCanvas/services/audio-service/CMakeLists.txt",
    "SynestheticCanvas/services/narrative-service/config/narrative.toml.example",
    "SynestheticCanvas/libs/sc_common/CMakeLists.txt",
    "SynestheticCanvas/services/texture-service/Dockerfile",
    "SynestheticCanvas/services/texture-service/config/texture.toml.example",
    "SynestheticCanvas/services/palette-service/config/palette.toml.example",
    "SynestheticCanvas/services/narrative-service/README.md",
    "SynestheticCanvas/services/palette-service/Dockerfile",
    "SynestheticCanvas/services/audio-service/Dockerfile",
    "SynestheticCanvas/services/narrative-service/Dockerfile",
    "SynestheticCanvas/services/audio-service/config/audio.toml.example",
    "SynestheticCanvas/scripts/run_dev.sh",
    "SynestheticCanvas/libs/sc_ipc/src/sc_ipc.c",
    "SynestheticCanvas/api-gateway/src/middleware/auth.c",
    "SynestheticCanvas/LICENSE",
    "SynestheticCanvas/api-gateway/include/middleware/rate_limiter.h",
    "SynestheticCanvas/api-gateway/include/rest/router.h",
    "SynestheticCanvas/api-gateway/include/gateway_server.h",
    "SynestheticCanvas/scripts/build.sh",
    "SynestheticCanvas/api-gateway/src/rest/router.c",
    "SynestheticCanvas/api-gateway/include/middleware/auth.h",
    "SynestheticCanvas/scripts/deploy.sh",
    "SynestheticCanvas/CONTRIBUTING.md",
    "SynestheticCanvas/api-gateway/src/middleware/caching.c",
    "SynestheticCanvas/api-gateway/src/main.c",
    "SynestheticCanvas/api-gateway/graphql/resolvers.c",
    "SynestheticCanvas/CMakeLists.txt",
    "SynestheticCanvas/api-gateway/tests/test_routing.c",
    "SynestheticCanvas/api-gateway/graphql/schema.c",
    "SynestheticCanvas/api-gateway/src/gateway_server.c",
    "SynestheticCanvas/api-gateway/tests/test_middleware.c",
    "SynestheticCanvas/docs/architecture/api_gateway.md",
    "SynestheticCanvas/docs/index.md",
    "SynestheticCanvas/docs/api/authentication.md",
    "SynestheticCanvas/docs/api/v1_graphql.md",
    "SynestheticCanvas/api-gateway/CMakeLists.txt"
  ],
  "task_category": "cross_file_refactoring",
  "evaluation_criteria": [
    "**Correctness & Compilation:** The entire project must compile successfully without new warnings. All modified tests must pass, and no existing functionality should be broken.",
    "**Abstraction Quality:** The new `sc_error_t` abstraction in `sc_common` must be well-defined, and its helper functions must be correctly implemented, especially concerning memory management (e.g., `strdup` for the message, proper `free` in the destructor).",
    "**Refactoring Completeness:** Both `palette-service` and `texture-service` must be fully refactored to use the new error system, from the repository layer up to the handler.",
    "**Gateway Integration:** The API Gateway must correctly consume the new `sc_error_t` objects, using their fields to generate appropriate and consistent HTTP responses.",
    "**Test Adaptation:** Unit tests for the modified services must be updated to reflect the new function signatures and properly assert on the new error struct's contents.",
    "**Code Consistency:** The new error handling pattern must be applied consistently across all modified files.",
    "**Memory Safety:** The agent must correctly manage the lifecycle of `sc_error_t` objects, creating them on error and destroying them once handled to prevent memory leaks."
  ]
}