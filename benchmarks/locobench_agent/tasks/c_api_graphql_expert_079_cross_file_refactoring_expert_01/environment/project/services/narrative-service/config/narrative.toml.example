# =======================================================================
#  SynestheticCanvas Narrative Service – Example Configuration (TOML)
#  -------------------------------------------------------------------
#  File Path : services/narrative-service/config/narrative.toml.example
#
#  This file contains a complete, production-ready example configuration
#  for the Narrative Service.  Copy it to `narrative.toml` and adjust the
#  values to suit your deployment environment (Docker, Kubernetes, bare
#  metal, etc.).
#
#  The Narrative Service is responsible for:
#    • Storing and serving branching-path narrative graphs
#    • Real-time evaluation of plot logic, conditions, and variables
#    • Streaming change-sets to downstream renderers / clients
#    • Enforcing rate limits, quotas, and versioned schema compliance
#
#  HINT: All settings can be overridden via environment variables with
#        the pattern  SCN_<SECTION>_<KEY>  (case insensitive, underscores
#        instead of dots).  For example:
#
#           export SCN_SERVER_PORT=8082
#           export SCN_DB_PASSWORD="S3cr3t!"
#
# =======================================================================

# -----------------------------------------------------------------------
# [server] – Basic HTTP/2 gRPC + REST/GraphQL gateway configuration
# -----------------------------------------------------------------------
[server]
host            = "0.0.0.0"     # Interface to bind on
port            = 7080          # Public port for REST & GraphQL
grpc_port       = 7081          # Internal gRPC port
read_timeout    = "10s"         # Maximum duration for reading entire request
write_timeout   = "20s"         # Maximum duration before timing out response
shutdown_timeout= "30s"         # Graceful shutdown wait time
max_body_size   = "16MiB"       # Max request payload
enable_pprof    = true          # Enable /debug/pprof endpoints (off in prod)
trusted_proxies = ["10.0.0.0/8", "192.168.0.0/16"]  # CIDR blocks treated as internal

# -----------------------------------------------------------------------
# [logging] – Structured logging setup
# -----------------------------------------------------------------------
[logging]
level   = "info"                # One of: trace, debug, info, warn, error, fatal
format  = "json"                # "json" or "console"
color   = false                 # ANSI colors on console output
# Rotating file sink (falls back to stdout if disabled)
[logging.file]
enabled        = true
path           = "/var/log/synesthetic/narrative-service.log"
max_size_mb    = 100            # Rotate when size exceeds N MB
max_backups    = 7              # Keep N old log files
max_age_days   = 30             # Delete after N days
compress       = true           # GZIP old logs

# -----------------------------------------------------------------------
# [metrics] – Prometheus / OpenTelemetry metrics
# -----------------------------------------------------------------------
[metrics]
enabled        = true
listen_addr    = ":9106"
path           = "/metrics"
sampling_ratio = 0.75           # 0 – 1 (1 = sample all traces)
exporter       = "otlp"         # "prometheus" | "otlp"
[metrics.otlp]
endpoint       = "otel-collector:4317"
insecure       = true

# -----------------------------------------------------------------------
# [db] – Primary PostgreSQL persistence
# -----------------------------------------------------------------------
[db]
dsn               = "postgres://synesthetic:changeme@postgres:5432/narrative?sslmode=disable"
max_open_conns    = 64
max_idle_conns    = 16
conn_max_lifetime = "30m"
schema            = "narrative_v1"

# -----------------------------------------------------------------------
# [cache] – Redis-based narrative snapshot cache
# -----------------------------------------------------------------------
[cache]
enabled          = true
addr             = "redis:6379"
db               = 1
password         = ""
pool_size        = 32
ttl_default      = "5m"
ttl_branch_graph = "30m"

# -----------------------------------------------------------------------
# [rate_limit] – Token bucket configuration
# -----------------------------------------------------------------------
[rate_limit]
enabled          = true
bucket_capacity  = 150          # Max instantaneous requests
fill_rate        = 120          # Tokens added per minute per client IP
redis_key_prefix = "scn:narrative:rl:"
exempt_ips       = ["127.0.0.1"]

# -----------------------------------------------------------------------
# [graphql] – Versioned schema toggles
# -----------------------------------------------------------------------
[graphql]
# Set to "latest" to always expose most recent minor version
active_schema_version = "v2"
playground_enabled    = false   # GraphQL Playground UI (dev only)
# Global query limits
max_depth             = 15      # Tree depth limit
max_complexity        = 200     # Operation cost limit

# -----------------------------------------------------------------------
# [narrative] – Domain-specific behavior
# -----------------------------------------------------------------------
[narrative]
default_locale      = "en-US"
autosave_interval   = "2s"      # Snapshot in-flight state at interval
max_branches        = 256       # Hard cap for branching nodes per story
variables_namespace = "global"  # Root namespace for narrative variables
allow_hot_reload    = true      # Reload narrative assets without restart

# Dynamic scoring functions for narrative quality metrics.
# The Lua snippets below are hot-reloaded and executed inside a secure,
# sandboxed LuaJIT VM by the C runtime.
[narrative.scoring.scripts]
# Score for "emotional resonance"
emotional = """
function score(node)
  -- Node fields: sentiment (-1..1), impact (0..1), intensity (0..1)
  return (node.sentiment * 0.5 + node.impact * 0.3 + node.intensity * 0.2) * 100
end
"""
# Score for "pacing"
pacing = """
function score(node)
  local delta = math.abs(node.expected_time - node.actual_time)
  return math.max(0, 100 - delta * 10)
end
"""

# -----------------------------------------------------------------------
# [security] – JWT validation & RBAC
# -----------------------------------------------------------------------
[security]
jwt_public_key_path = "/run/secrets/narrative_jwt_pub.pem"
jwt_issuer          = "https://auth.synestheticcanvas.io/"
jwt_audience        = "synesthetic-narrative"
[security.rbac]
roles = ["viewer", "composer", "admin"]
default_role = "viewer"

# -----------------------------------------------------------------------
# [external] – Endpoints of other microservices
# -----------------------------------------------------------------------
[external.palette]
host = "palette-service"
port = 7030
[external.texture]
host = "texture-service"
port = 7040
[external.audio]
host = "audio-service"
port = 7050

# END OF FILE
