{
  "ground_truth": "The hidden architecture is a modular monolith implementing CQRS with a NATS message bus.\n\n-   **Core Components:**\n    -   `package.json` dependencies include `axum`, `tokio`, `sqlx`, `nats`, `serde`, `jsonwebtoken`.\n    -   `src/config.txt` defines `NATS_URL`, `DATABASE_WRITE_URL`, `DATABASE_READ_URL`, and `JWT_SECRET`.\n    -   **API Gateway:** `src/module_1.txt` contains the `axum::Router` setup. It receives HTTP requests and uses `module_15` for auth.\n    -   **Authentication:** `src/module_15.txt` handles JWT validation and session logic.\n    -   **Command Publishing:** The API Gateway (`module_1`) publishes commands (e.g., `CreatePostCommand`) to the NATS bus after a successful request.\n    -   **Command Handlers:** `src/module_68.txt` and `src/module_35.txt` subscribe to command topics. They contain business logic and, upon success, publish domain events (e.g., `PostCreatedEvent`).\n    -   **Event Consumers (Write-Side):** `src/module_48.txt` and `src/module_22.txt` are consumers that subscribe to domain events and update the 'write' database, which is the source of truth.\n    -   **Query Service / Denormalizers:** `src/module_4.txt` is a separate service/module that also consumes domain events to update a denormalized 'read' database. It exposes read-only API endpoints for fetching data efficiently.\n\n-   **Data Flow (Create Post):**\n    1.  HTTP POST `/posts` hits `module_1`.\n    2.  `module_1` authenticates the user via `module_15`.\n    3.  `module_1` constructs and publishes a `CreatePostCommand` to the `commands.posts` NATS topic.\n    4.  `module_68` (Post Command Handler) consumes the command, validates it, saves the core post data to the 'write' DB, and publishes a `PostCreatedEvent` to the `events.posts` topic.\n    5.  `module_4` (Query Denormalizer) consumes the `PostCreatedEvent` and updates its 'read' database with the new post data for fast retrieval.\n\n-   **Proposed Whiteboard Architecture:**\n    -   A new, independent module (`ProposedWhiteboardService`) that manages WebSocket connections.\n    -   This service subscribes to the main NATS bus for events like `StudyGroupSessionStarted` to know when to create a whiteboard session.\n    -   Client-side drawing actions are sent over the WebSocket directly to this service.\n    -   The service broadcasts drawing data to all other clients in the same session's WebSocket room.\n    -   For persistence, the service takes a snapshot of the whiteboard state (e.g., as SVG or JSON) every 10-20 seconds and issues a `SaveWhiteboardSnapshotCommand` to the NATS bus, which is then handled by a standard command handler to save to the primary DB.\n\n-   **Diagrams (MermaidJS):** The ground truth would include valid MermaidJS code for the 'Existing' and 'Proposed' architectures, reflecting the component interactions described above.\n\n-   **Risks:**\n    1.  **Scalability of WebSocket Service:** The new service is stateful (maintaining active connections) and could become a bottleneck. It needs to be designed for horizontal scaling.\n    2.  **Increased Load on Auth Service:** Every WebSocket connection will need to be authenticated, potentially DDOSing the auth module (`module_15`) if not handled carefully (e.g., with tickets or token-based auth).\n    3.  **Data Consistency:** There's a risk of inconsistency between the real-time state seen by users and the persisted snapshot in the database if the server crashes between snapshots.",
  "context_files": [
    "src/config.txt",
    "tests/test_main.txt",
    "package.json",
    "src/module_76.txt",
    "src/module_52.txt",
    "src/module_32.txt",
    "src/module_41.txt",
    "src/module_30.txt",
    "src/module_26.txt",
    "src/module_28.txt",
    "src/module_69.txt",
    "src/module_78.txt",
    "src/module_51.txt",
    "src/module_54.txt",
    "src/module_6.txt",
    "src/module_64.txt",
    "src/module_21.txt",
    "src/module_25.txt",
    "src/module_9.txt",
    "src/module_12.txt",
    "src/module_14.txt",
    "src/module_7.txt",
    "src/module_31.txt",
    "src/module_2.txt",
    "src/module_66.txt",
    "src/module_4.txt",
    "src/module_71.txt",
    "src/module_85.txt",
    "src/module_34.txt",
    "src/module_29.txt",
    "src/module_68.txt",
    "src/module_80.txt",
    "src/module_74.txt",
    "src/module_37.txt",
    "src/module_53.txt",
    "src/module_13.txt",
    "src/module_17.txt",
    "src/module_77.txt",
    "src/module_56.txt",
    "src/module_43.txt",
    "src/module_46.txt",
    "src/module_70.txt",
    "src/module_61.txt",
    "src/module_55.txt",
    "src/module_10.txt",
    "src/module_60.txt",
    "src/module_75.txt",
    "src/module_36.txt",
    "src/module_33.txt",
    "src/module_81.txt",
    "src/module_50.txt",
    "src/module_82.txt",
    "src/module_5.txt",
    "src/module_49.txt",
    "src/module_24.txt",
    "src/module_42.txt",
    "src/module_47.txt",
    "src/module_63.txt",
    "src/module_72.txt",
    "src/module_15.txt",
    "src/module_20.txt",
    "src/module_3.txt",
    "src/module_83.txt",
    "src/module_22.txt",
    "src/module_35.txt",
    "src/module_48.txt",
    "src/module_62.txt",
    "src/module_65.txt",
    "src/module_86.txt",
    "src/module_38.txt",
    "src/module_45.txt",
    "src/module_16.txt",
    "src/module_67.txt",
    "src/module_79.txt",
    "src/module_57.txt",
    "src/module_44.txt",
    "src/module_84.txt",
    "src/module_19.txt",
    "src/module_1.txt",
    "src/module_58.txt",
    "src/module_18.txt",
    "src/module_39.txt",
    "src/module_23.txt",
    "src/module_27.txt",
    "src/module_11.txt",
    "src/module_59.txt",
    "src/module_73.txt",
    "src/module_8.txt"
  ],
  "task_category": "architectural_understanding",
  "evaluation_criteria": [
    "**Component Identification Accuracy:** How accurately did the agent identify the roles of the key modules (`module_1`, `module_15`, `module_68`, `module_4`, etc.) based on code analysis?",
    "**Architectural Pattern Recognition:** Did the agent correctly identify the high-level patterns in use, specifically Event-Driven Architecture and CQRS, citing evidence like separate DB URLs or command/event naming?",
    "**Data Flow Analysis:** Was the agent's trace of the 'Create Post' flow logical and did it reference the correct sequence of component interactions (API -> Command -> Handler -> Event -> Consumer)?",
    "**Proposed Solution Viability:** Is the proposed architecture for the whiteboard feature sound? Does it correctly identify WebSockets as the appropriate technology and propose a reasonable strategy for state management and persistence?",
    "**Visualization Quality:** Are the MermaidJS diagrams syntactically correct, clear, and do they accurately represent both the existing and proposed architectures as described in the analysis?",
    "**Risk Assessment Insight:** Are the identified risks relevant to the proposed architecture? Does the explanation demonstrate a deep understanding of the trade-offs in distributed, real-time systems (e.g., stateful vs. stateless services, consistency vs. performance)?"
  ]
}