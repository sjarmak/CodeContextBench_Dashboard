{
  "ground_truth": "The solution is correct if the agent successfully creates the new shared module and refactors the specified services. Key indicators of a correct solution include:\n\n*   **New Files Created:** `HoloCanvas/shared/event_dispatcher/hc_event_dispatcher.h` and `HoloCanvas/shared/event_dispatcher/hc_event_dispatcher.c` exist and are populated.\n\n*   **Key Code Snippet in `hc_event_dispatcher.h`:**\n    ```c\n    // HoloCanvas/shared/event_dispatcher/hc_event_dispatcher.h\n    #include \"shared/common/errors.h\"\n    #include <protobuf-c/protobuf-c.h>\n\n    typedef struct EventDispatcher EventDispatcher;\n\n    typedef hc_error_t (*event_handler_func_t)(const ProtobufCMessage* msg, void* user_context);\n\n    EventDispatcher* event_dispatcher_create(const char* kafka_brokers, const char* topic, const char* group_id, void* user_context);\n    hc_error_t event_dispatcher_register_handler(EventDispatcher* dispatcher, const char* event_type_key, event_handler_func_t handler);\n    void event_dispatcher_run(EventDispatcher* dispatcher);\n    void event_dispatcher_destroy(EventDispatcher* dispatcher);\n    ```\n\n*   **Example of Refactored `main.c` (e.g., `governance_hall/src/main.c`):**\n    ```c\n    // HoloCanvas/services/governance_hall/src/main.c (Conceptual Change)\n    #include \"shared/event_dispatcher/hc_event_dispatcher.h\"\n    #include \"governance.h\" // Assumed to declare handlers like handle_proposal_created, etc.\n\n    int main(int argc, char **argv) {\n        // ... initial setup ...\n        GovernanceState* state = initialize_governance_state();\n        \n        EventDispatcher* dispatcher = event_dispatcher_create(\"kafka:9092\", \"governance_topic\", \"governance_group\", state);\n        if (!dispatcher) { /* handle error */ }\n\n        event_dispatcher_register_handler(dispatcher, \"PROPOSAL_CREATED\", handle_proposal_created_event);\n        event_dispatcher_register_handler(dispatcher, \"VOTE_CAST\", handle_vote_cast_event);\n        // ... register other handlers ...\n\n        printf(\"Starting Governance Hall event dispatcher...\\n\");\n        event_dispatcher_run(dispatcher);\n\n        printf(\"Shutting down...\\n\");\n        event_dispatcher_destroy(dispatcher);\n        destroy_governance_state(state);\n        return 0;\n    }\n    ```\n\n*   **Removal of Logic:** The large `switch` statement for routing events based on type is no longer present in `governance_hall/src/event_handler.c`, `mint_factory/src/event_handler.c`, etc.\n\n*   **`CMakeLists.txt` Modification:** `HoloCanvas/shared/CMakeLists.txt` should be updated:\n    ```cmake\n    # In shared/CMakeLists.txt\n    set(SHARED_SOURCES\n        common/types.c\n        common/errors.c\n        kafka_client/hc_kafka.c\n        crypto_wrapper/hc_crypto.c\n        event_dispatcher/hc_event_dispatcher.c # <-- ADDED LINE\n    )\n    ```",
  "context_files": [
    "HoloCanvas/services/cryptograph/src/crypto_service.c",
    "HoloCanvas/services/defi_garden/src/event_handler.c",
    "HoloCanvas/services/gallery_gateway/include/api_handler.h",
    "HoloCanvas/services/gallery_gateway/src/api_handler.c",
    "HoloCanvas/services/gallery_gateway/src/query_service.c",
    "HoloCanvas/services/governance_hall/src/event_handler.c",
    "HoloCanvas/services/governance_hall/src/voting_service.c",
    "HoloCanvas/services/ledger_core/src/consensus_manager.c",
    "HoloCanvas/services/mint_factory/src/event_handler.c",
    "HoloCanvas/services/oracle_bridge/src/feed_manager.c",
    "HoloCanvas/shared/common/types.c",
    "HoloCanvas/shared/common/errors.c",
    "HoloCanvas/shared/common/errors.h",
    "HoloCanvas/shared/common/types.h",
    "HoloCanvas/services/wallet_proxy/include/adapters.h",
    "HoloCanvas/shared/crypto_wrapper/hc_crypto.h",
    "HoloCanvas/services/oracle_bridge/include/feeds.h",
    "HoloCanvas/services/governance_hall/src/main.c",
    "HoloCanvas/services/ledger_core/include/block.h",
    "HoloCanvas/services/mint_factory/src/main.c",
    "HoloCanvas/shared/crypto_wrapper/hc_crypto.c",
    "HoloCanvas/services/muse_observer/src/trigger_engine.c",
    "HoloCanvas/services/muse_observer/include/muse.h",
    "HoloCanvas/services/ledger_core/include/state.h",
    "HoloCanvas/services/muse_observer/src/main.c",
    "HoloCanvas/services/muse_observer/src/evolution_strategist.c",
    "HoloCanvas/services/governance_hall/include/governance.h",
    "HoloCanvas/services/wallet_proxy/include/proxy.h",
    "HoloCanvas/services/ledger_core/src/block_builder.c",
    "HoloCanvas/shared/kafka_client/hc_kafka.h",
    "HoloCanvas/services/wallet_proxy/src/main.c",
    "HoloCanvas/services/gallery_gateway/tests/test_queries.c",
    "HoloCanvas/services/gallery_gateway/include/grpc_server.h",
    "HoloCanvas/services/ledger_core/src/transaction_processor.c",
    "HoloCanvas/services/defi_garden/src/main.c",
    "HoloCanvas/services/mint_factory/src/recipe_composer.c",
    "HoloCanvas/services/mint_factory/include/recipe.h",
    "HoloCanvas/services/ledger_core/src/main.c",
    "HoloCanvas/services/muse_observer/src/event_listener.c",
    "HoloCanvas/services/cryptograph/src/main.c",
    "HoloCanvas/services/oracle_bridge/src/main.c",
    "HoloCanvas/services/governance_hall/src/proposal_lifecycle.c",
    "HoloCanvas/services/ledger_core/include/consensus.h",
    "HoloCanvas/services/ledger_core/src/strategies/da_strategy.c",
    "HoloCanvas/services/ledger_core/include/transaction.h",
    "HoloCanvas/services/ledger_core/src/strategies/pos_strategy.c",
    "HoloCanvas/services/wallet_proxy/src/adapters/eip1193_adapter.c",
    "HoloCanvas/services/muse_observer/src/strategies/weather_evolver.c",
    "HoloCanvas/services/defi_garden/src/reward_calculator.c",
    "HoloCanvas/services/defi_garden/src/staking_pool.c",
    "HoloCanvas/services/muse_observer/src/strategies/popularity_evolver.c",
    "HoloCanvas/shared/kafka_client/hc_kafka.c",
    "HoloCanvas/services/cryptograph/include/cryptograph.h",
    "HoloCanvas/services/mint_factory/src/artifact_factory.c",
    "HoloCanvas/services/gallery_gateway/src/main.c",
    "HoloCanvas/services/wallet_proxy/src/proxy_server.c",
    "HoloCanvas/services/oracle_bridge/src/event_producer.c",
    "HoloCanvas/services/wallet_proxy/src/adapters/internal_adapter.c",
    "HoloCanvas/services/gallery_gateway/src/grpc_server.c",
    "HoloCanvas/services/wallet_proxy/tests/test_proxy.c",
    "HoloCanvas/shared/protocol/holocanvas.proto",
    "HoloCanvas/services/cryptograph/tests/test_signatures.c",
    "HoloCanvas/services/governance_hall/tests/test_governance.c",
    "HoloCanvas/services/defi_garden/include/defi.h",
    "HoloCanvas/services/ledger_core/CMakeLists.txt",
    "HoloCanvas/services/oracle_bridge/CMakeLists.txt",
    "HoloCanvas/services/mint_factory/tests/test_factory.c",
    "HoloCanvas/services/wallet_proxy/CMakeLists.txt",
    "HoloCanvas/shared/CMakeLists.txt",
    "HoloCanvas/services/muse_observer/tests/test_triggers.c",
    "HoloCanvas/services/ledger_core/src/state_machine.c",
    "HoloCanvas/services/defi_garden/tests/test_staking.c",
    "HoloCanvas/services/governance_hall/CMakeLists.txt",
    "HoloCanvas/shared/protocol/governance.proto",
    "HoloCanvas/services/mint_factory/include/artifact_factory.h",
    "HoloCanvas/services/oracle_bridge/tests/test_feeds.c",
    "HoloCanvas/services/cryptograph/CMakeLists.txt",
    "HoloCanvas/shared/protocol/ledger.proto",
    "HoloCanvas/services/mint_factory/CMakeLists.txt",
    "HoloCanvas/services/defi_garden/CMakeLists.txt",
    "HoloCanvas/services/gallery_gateway/CMakeLists.txt",
    "HoloCanvas/services/muse_observer/CMakeLists.txt",
    "HoloCanvas/services/ledger_core/tests/test_state_machine.c",
    "HoloCanvas/tests/integration/test_full_lifecycle.py",
    "HoloCanvas/CONTRIBUTING.md"
  ],
  "task_category": "cross_file_refactoring",
  "evaluation_criteria": [
    "**Correctness of Abstraction:** The created `hc_event_dispatcher` API must be generic, reusable, and correctly designed with an opaque struct and function pointers.",
    "**Completeness of Refactoring:** All three specified services (`governance_hall`, `mint_factory`, `muse_observer`) must be successfully refactored to use the new dispatcher.",
    "**Code Removal:** The agent must correctly identify and remove the duplicated Kafka consumption and event dispatching logic from the services' `main.c` and `event_handler.c`/`event_listener.c` files.",
    "**Build System Integrity:** The `CMakeLists.txt` files for both the `shared` library and the affected services must be updated correctly, allowing the project to compile without errors.",
    "**Non-Regression of Logic:** The core business logic inside the individual handler functions (e.g., the logic that processes a `PROPOSAL_CREATED` event) must be preserved and correctly integrated with the new handler signature.",
    "**File System Manipulation:** The agent must correctly create new files and directories and modify existing files across the project structure as required.",
    "**Resource Management:** The implementation of `hc_event_dispatcher.c` must demonstrate proper memory and resource management (e.g., freeing the dispatcher context, the handler registry, and closing Kafka handles)."
  ]
}