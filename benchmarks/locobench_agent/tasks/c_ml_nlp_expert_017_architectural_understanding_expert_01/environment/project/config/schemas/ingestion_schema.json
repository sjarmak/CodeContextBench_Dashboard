{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lexilearn.ai/schemas/ingestion_schema.json",
  "title": "LexiLearn Orchestrator â€“ Ingestion Payload Schema",
  "description": "Schema that validates multimodal classroom data ingested by the LexiLearn MVC Orchestrator. The schema supports strict versioning, polymorphic record types, and field-level validation so that downstream C components (pre-processing, feature engineering, etc.) can assume well-formed inputs.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "ingestion_id",
    "timestamp_utc",
    "source_system",
    "records"
  ],

  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^v(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
      "description": "Semantic version of this schema (e.g., v1.0.0)."
    },

    "ingestion_id": {
      "type": "string",
      "format": "uuid",
      "description": "UUID v4 that uniquely identifies this ingestion batch."
    },

    "timestamp_utc": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp representing when the orchestrator received the data."
    },

    "source_system": {
      "type": "string",
      "enum": [
        "LMS_API",
        "MANUAL_UPLOAD",
        "BATCH_IMPORT",
        "REALTIME_STREAM"
      ],
      "description": "Indicates where the data originated."
    },

    "records": {
      "description": "Collection of multimodal classroom artifacts.",
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/record"
      }
    }
  },

  "definitions": {
    "commonFields": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "record_id",
        "student_id",
        "course_id",
        "type",
        "ingested_at_utc"
      ],
      "properties": {
        "record_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the individual record."
        },
        "student_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9\\-]+$",
          "description": "Opaque student identifier supplied by the institution."
        },
        "course_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9\\-]+$",
          "description": "Identifier for the course or class section."
        },
        "assignment_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9\\-]+$",
          "description": "Optional assignment that the record is associated with."
        },
        "language": {
          "type": "string",
          "pattern": "^[a-z]{2}(-[A-Z]{2})?$",
          "description": "BCP-47 language code (e.g., en, en-US, es)."
        },
        "ingested_at_utc": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp captured by the orchestrator when the record was ingested."
        },
        "type": {
          "type": "string",
          "enum": [
            "VOICE_SNIPPET",
            "ESSAY_TEXT",
            "QUIZ_RESPONSE",
            "LMS_LOG"
          ],
          "description": "Polymorphic discriminator."
        }
      }
    },

    "voiceSnippet": {
      "allOf": [
        { "$ref": "#/definitions/commonFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "audio_url",
            "duration_seconds",
            "sampling_rate_hz"
          ],
          "properties": {
            "audio_url": {
              "type": "string",
              "format": "uri",
              "description": "HTTPS URL to the audio resource in cloud storage."
            },
            "transcript": {
              "type": "string",
              "description": "Optional human or ASR-generated transcript."
            },
            "duration_seconds": {
              "type": "number",
              "minimum": 0.1,
              "maximum": 1800,
              "description": "Length of the audio in seconds."
            },
            "sampling_rate_hz": {
              "type": "integer",
              "enum": [16000, 22050, 44100, 48000],
              "description": "Accepted sampling rates."
            },
            "audio_format": {
              "type": "string",
              "enum": ["wav", "flac", "mp3", "aac", "m4a"],
              "description": "Lossless formats are preferred."
            }
          }
        }
      ]
    },

    "essayText": {
      "allOf": [
        { "$ref": "#/definitions/commonFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["text"],
          "properties": {
            "text": {
              "type": "string",
              "minLength": 20,
              "maxLength": 20000,
              "description": "Student-submitted essay."
            },
            "word_count": {
              "type": "integer",
              "minimum": 5,
              "description": "Optional word count; will be validated against text length if provided."
            },
            "reading_level": {
              "type": "number",
              "minimum": 0,
              "maximum": 20,
              "description": "Flesch-Kincaid or similar metric."
            }
          }
        }
      ]
    },

    "quizResponse": {
      "allOf": [
        { "$ref": "#/definitions/commonFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "question_id",
            "answer_text",
            "is_correct"
          ],
          "properties": {
            "question_id": {
              "type": "string",
              "pattern": "^[A-Za-z0-9\\-]+$"
            },
            "answer_text": {
              "type": "string",
              "minLength": 1
            },
            "is_correct": {
              "type": "boolean"
            },
            "score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Partial credit allowed (0-1)."
            },
            "time_taken_ms": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      ]
    },

    "lmsLog": {
      "allOf": [
        { "$ref": "#/definitions/commonFields" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "event_type",
            "event_timestamp_utc"
          ],
          "properties": {
            "event_type": {
              "type": "string",
              "enum": [
                "RESOURCE_VIEW",
                "ASSIGNMENT_SUBMISSION",
                "DISCUSSION_POST",
                "GRADE_VIEW",
                "LOGIN",
                "LOGOUT"
              ]
            },
            "event_timestamp_utc": {
              "type": "string",
              "format": "date-time"
            },
            "details": {
              "type": "object",
              "description": "Free-form key/value pairs defined by the LMS adapter.",
              "additionalProperties": {
                "type": ["string", "number", "boolean", "null"]
              }
            }
          }
        }
      ]
    },

    "record": {
      "description": "Polymorphic record validated via oneOf based on 'type'.",
      "oneOf": [
        {
          "$ref": "#/definitions/voiceSnippet",
          "title": "VOICE_SNIPPET"
        },
        {
          "$ref": "#/definitions/essayText",
          "title": "ESSAY_TEXT"
        },
        {
          "$ref": "#/definitions/quizResponse",
          "title": "QUIZ_RESPONSE"
        },
        {
          "$ref": "#/definitions/lmsLog",
          "title": "LMS_LOG"
        }
      ]
    }
  }
}