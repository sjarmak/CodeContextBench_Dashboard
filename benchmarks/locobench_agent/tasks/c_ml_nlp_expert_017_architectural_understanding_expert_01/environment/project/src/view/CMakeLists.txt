# ====================================================================
#  LexiLearn MVC Orchestrator – View Layer
#  CMake build script for `lexilearn_orchestrator/src/view`
#
#  This CMakeLists.txt is intentionally opinionated.  It enforces modern
#  CMake best-practices (explicit source lists, private/public link
#  interfaces, target properties, etc.) and integrates seamlessly with
#  the rest of the LexiLearn monorepo, providing hooks for sanitizers,
#  coverage, and static analysis while remaining self-contained.
#
#  ────────────────────────────────────────────────────────────────────
#    Key features
#    • Builds `lexiview` as a shared OR static library
#    • Optional demo application (`lexiview_demo`)
#    • Unit-testing via CTest & Unity (ANSI C test framework)
#    • Sanitizer + coverage flags gated by options
#    • Strict warnings + clang-tidy support
#    • Version header autogenerated from Git metadata
#    • Proper install & export rules
# ====================================================================

cmake_minimum_required(VERSION 3.22 FATAL_ERROR)

# --------------------------------------------------
#  Project metadata
# --------------------------------------------------
project(lexiview
        VERSION 1.3.0
        DESCRIPTION "Real-time visualization layer for LexiLearn MVC Orchestrator"
        LANGUAGES C)

# --------------------------------------------------
#  User options
# --------------------------------------------------
option(LEXIVIEW_BUILD_DEMO          "Build demo dashboard executable"          ON)
option(LEXIVIEW_ENABLE_TESTS        "Build unit tests"                         ON)
option(LEXIVIEW_ENABLE_COVERAGE     "Enable GCOV/LCOV code-coverage build"     OFF)
option(LEXIVIEW_ENABLE_SANITIZERS   "Enable address/undefined sanitizers"      OFF)
option(LEXIVIEW_WARNINGS_AS_ERRORS  "Treat compiler warnings as errors"        ON)

# --------------------------------------------------
#  Compiler features + global flags
# --------------------------------------------------
include(CheckCCompilerFlag)

# Helper for adding a flag only if supported
function(add_if_supported _flag _target)
    set(_key  "HAS_${_flag}")
    check_c_compiler_flag("${_flag}" ${_key})
    if(${_key})
        target_compile_options(${_target} PRIVATE "${_flag}")
    endif()
endfunction()

# Establish an "all-targets" compile features interface
add_library(lexiview_warnings INTERFACE)

target_compile_features(lexiview_warnings INTERFACE c_std_11)

# Strict warnings (GCC/Clang -Wall/-Wextra etc.)
set(_WARN_FLAGS
    -Wall
    -Wextra
    -Wpedantic
    -Wconversion
    -Wdouble-promotion
    -Wformat=2
    -Wshadow
)

if(LEXIVIEW_WARNINGS_AS_ERRORS)
    list(APPEND _WARN_FLAGS -Werror)
endif()

target_compile_options(lexiview_warnings INTERFACE ${_WARN_FLAGS})

# Sanitizers -----------------------------------------------------------
if(LEXIVIEW_ENABLE_SANITIZERS AND (CMAKE_C_COMPILER_ID MATCHES "Clang|GNU"))
    message(STATUS "Sanitizers enabled")
    target_compile_options(lexiview_warnings INTERFACE -fsanitize=address,undefined)
    target_link_options(lexiview_warnings    INTERFACE -fsanitize=address,undefined)
endif()

# Coverage -------------------------------------------------------------
if(LEXIVIEW_ENABLE_COVERAGE AND CMAKE_C_COMPILER_ID MATCHES "GNU")
    message(STATUS "Code coverage flags enabled")
    target_compile_options(lexiview_warnings INTERFACE --coverage -O0)
    target_link_options(lexiview_warnings    INTERFACE --coverage)
endif()

# --------------------------------------------------
#  External dependencies
# --------------------------------------------------
include(FetchContent)

# SDL2 is used for window/context creation in dashboard rendering
find_package(SDL2 REQUIRED)
# Cairo for vector drawing
find_package(PkgConfig REQUIRED)
pkg_check_modules(CAIRO cairo>=1.16 REQUIRED)

# GLad & Dear ImGui pulled at configure time (source included)
FetchContent_Declare(
    glad
    GIT_REPOSITORY https://github.com/Dav1dde/glad.git
    GIT_TAG        v0.1.36
)
FetchContent_MakeAvailable(glad)

FetchContent_Declare(
    imgui
    GIT_REPOSITORY https://github.com/ocornut/imgui.git
    GIT_TAG        v1.90.3
)
FetchContent_MakeAvailable(imgui)

# --------------------------------------------------
#  Sources / headers
# --------------------------------------------------
set(LEXIVIEW_SRC
    src/lexiview.c
    src/renderer.c
    src/metrics_panel.c
    src/heatmap_widget.c
    include/lexiview/lexiview.h
    include/lexiview/renderer.h
    include/lexiview/metrics_panel.h
    include/lexiview/heatmap_widget.h
)

add_library(lexiview ${LEXIVIEW_SRC})

# Public include directories
target_include_directories(lexiview
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
    PRIVATE
        src
)

# Link dependencies
target_link_libraries(lexiview
    PUBLIC
        SDL2::SDL2
        glad
        imgui
        ${CAIRO_LIBRARIES}
    PRIVATE
        lexiview_warnings
)

# Transitive compile definitions for consumers
target_compile_definitions(lexiview
    PUBLIC
        "LEXIVIEW_VERSION=\"${PROJECT_VERSION}\""
)

# --------------------------------------------------
#  Version header (generated) -----------------------
# --------------------------------------------------
include(GNUInstallDirs)

set(VERSION_HEADER ${CMAKE_CURRENT_BINARY_DIR}/include/lexiview/version.h)

file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/include/lexiview)

add_custom_command(
    OUTPUT  ${VERSION_HEADER}
    BYPRODUCTS ${VERSION_HEADER}
    COMMAND ${CMAKE_COMMAND} -E echo
        "/* Auto-generated, do not edit */\n\
        #pragma once\n\
        #define LEXIVIEW_VERSION_MAJOR ${PROJECT_VERSION_MAJOR}\n\
        #define LEXIVIEW_VERSION_MINOR ${PROJECT_VERSION_MINOR}\n\
        #define LEXIVIEW_VERSION_PATCH ${PROJECT_VERSION_PATCH}\n\
        " > ${VERSION_HEADER}
    COMMENT "Generating version header"
)

add_custom_target(lexiview_version_header DEPENDS ${VERSION_HEADER})
add_dependencies(lexiview lexiview_version_header)
target_include_directories(lexiview PUBLIC ${CMAKE_CURRENT_BINARY_DIR}/include)

# --------------------------------------------------
#  Demo executable ---------------------------------
# --------------------------------------------------
if(LEXIVIEW_BUILD_DEMO)
    add_executable(lexiview_demo
        demos/demo_dashboard.c
    )
    target_link_libraries(lexiview_demo
        PRIVATE
            lexiview
            lexiview_warnings
    )
    set_property(TARGET lexiview_demo PROPERTY RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin")
endif()

# --------------------------------------------------
#  Tests (Unity + CTest) ----------------------------
# --------------------------------------------------
if(LEXIVIEW_ENABLE_TESTS)
    enable_testing()

    FetchContent_Declare(
        unity
        GIT_REPOSITORY https://github.com/ThrowTheSwitch/Unity.git
        GIT_TAG        v2.5.2
    )
    FetchContent_MakeAvailable(unity)

    add_executable(test_lexiview
        tests/test_renderer.c
        tests/test_metrics_panel.c
        tests/test_heatmap_widget.c
    )
    target_link_libraries(test_lexiview
        PRIVATE
            lexiview
            unity
            lexiview_warnings
    )
    add_test(NAME lexiview_unit_tests COMMAND test_lexiview)
endif()

# --------------------------------------------------
#  Install rules -----------------------------------
# --------------------------------------------------
include(CMakePackageConfigHelpers)

install(
    TARGETS lexiview
    EXPORT  lexiviewTargets
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

# Header installation
install(
    DIRECTORY include/lexiview
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# Generated version header
install(
    FILES ${VERSION_HEADER}
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/lexiview
)

# Export target configuration
install(
    EXPORT lexiviewTargets
    FILE   lexiviewTargets.cmake
    NAMESPACE LexiLearn::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/lexiview
)

# Config file for find_package()
configure_package_config_file(
    ${CMAKE_CURRENT_LIST_DIR}/cmake/lexiviewConfig.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/lexiviewConfig.cmake
    INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/lexiview
)

write_basic_package_version_file(
    ${CMAKE_CURRENT_BINARY_DIR}/lexiviewConfigVersion.cmake
    VERSION       ${PROJECT_VERSION}
    COMPATIBILITY AnyNewerVersion
)

install(
    FILES
        ${CMAKE_CURRENT_BINARY_DIR}/lexiviewConfig.cmake
        ${CMAKE_CURRENT_BINARY_DIR}/lexiviewConfigVersion.cmake
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/lexiview
)

# --------------------------------------------------
#  Packaging (CPack) -------------------------------
# --------------------------------------------------
include(CPack)

set(CPACK_PACKAGE_NAME              "lexiview")
set(CPACK_PACKAGE_VENDOR            "LexiLearn")
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY
    "Real-time visualization layer for the LexiLearn MVC Orchestrator")
set(CPACK_RESOURCE_FILE_LICENSE     "${CMAKE_CURRENT_SOURCE_DIR}/LICENSE")
set(CPACK_RESOURCE_FILE_README      "${CMAKE_CURRENT_SOURCE_DIR}/README.md")
set(CPACK_PACKAGE_VERSION           ${PROJECT_VERSION})
set(CPACK_PACKAGE_CONTACT           "opensource@lexilearn.ai")

# TGZ + DEB packages
set(CPACK_GENERATOR "TGZ;DEB")
set(CPACK_DEBIAN_PACKAGE_MAINTAINER "LexiLearn DevOps Team")

# Finalize CPack
cpack()

# --------------------------------------------------
#  clang-tidy (optional) ---------------------------
# --------------------------------------------------
find_program(CLANG_TIDY_EXE NAMES "clang-tidy")
if(CLANG_TIDY_EXE AND NOT DEFINED CMAKE_C_CLANG_TIDY)
    set(CMAKE_C_CLANG_TIDY "${CLANG_TIDY_EXE};-quiet")
    message(STATUS "clang-tidy enabled: ${CLANG_TIDY_EXE}")
endif()

# --------------------------------------------------
#  Summary -----------------------------------------
# --------------------------------------------------
message(STATUS "")
message(STATUS "──────────────── Build Configuration ────────────────")
message(STATUS " Project name            : ${PROJECT_NAME}")
message(STATUS " Project version         : ${PROJECT_VERSION}")
message(STATUS " Build type              : ${CMAKE_BUILD_TYPE}")
message(STATUS " Build demo              : ${LEXIVIEW_BUILD_DEMO}")
message(STATUS " Build unit tests        : ${LEXIVIEW_ENABLE_TESTS}")
message(STATUS " Sanitizers enabled      : ${LEXIVIEW_ENABLE_SANITIZERS}")
message(STATUS " Coverage enabled        : ${LEXIVIEW_ENABLE_COVERAGE}")
message(STATUS " Warnings as errors      : ${LEXIVIEW_WARNINGS_AS_ERRORS}")
message(STATUS " Install prefix          : ${CMAKE_INSTALL_PREFIX}")
message(STATUS "──────────────────────────────────────────────────────")
message(STATUS "")