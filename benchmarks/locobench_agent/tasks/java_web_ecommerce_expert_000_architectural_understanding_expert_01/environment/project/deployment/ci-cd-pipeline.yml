```yaml
# ===================================================================
#  CommerceSphere Enterprise Suite — Continuous Integration / Delivery
#  File: deployment/ci-cd-pipeline.yml
#  Purpose:
#    End-to-end build, test, security-scan, containerize, and deploy
#    pipeline for the monolithic Java 17 / Spring application.
#
#  Target Platform:
#    • GitHub Actions runners (ubuntu-latest)
#    • Maven 3.9.x, OpenJDK 17
#    • Docker 24.x
#
#  Key Stages:
#    1.  Checkout & dependency caching
#    2.  Build & unit-test via Maven
#    3.  Static code analysis (SonarCloud)
#    4.  Security & license scanning (OWASP-Dependency-Check + Snyk)
#    5.  Integration tests (containers / Testcontainers)
#    6.  Build & push Docker image to GHCR
#    7.  Blue/Green deployment to Kubernetes
# ===================================================================

name: commerce-sphere-ci-cd

# -------------------------------------------------------------------
# 1. Triggering strategy
# -------------------------------------------------------------------
on:
  push:
    branches: [ main, release/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy (staging | production)'
        required: true
        default: 'staging'

# -------------------------------------------------------------------
# 2. Global definitions
# -------------------------------------------------------------------
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  MAVEN_OPTS: "-Dmaven.test.failure.ignore=false -Dorg.slf4j.simpleLogger.showDateTime=true"
  JAVA_VERSION: '17'

# -------------------------------------------------------------------
# 3. Jobs
# -------------------------------------------------------------------
jobs:

  # ---------------------------------------------------------------
  # Build-and-Test Job
  # ---------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 3.1 Checkout
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for Sonar

      # 3.2 JDK Setup
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      # 3.3 Build & Unit Test
      - name: Build with Maven
        run: mvn --batch-mode --update-snapshots clean verify -Pcoverage

      # 3.4 Upload unit-test coverage for merge-request decoration
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: |
            **/target/surefire-reports/*.xml
            **/target/site/jacoco-aggregate/index.html

      # 3.5 Static Analysis — SonarCloud
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: commerce-sphere-enterprise-suite
          SONAR_ORGANIZATION: my-org
        with:
          args: >
            -Dsonar.projectVersion=${{ github.sha }}
            -Dsonar.host.url=https://sonarcloud.io

      # 3.6 Security Scan — OWASP Dependency Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@v2
        with:
          project: "CommerceSphere"
          path: "./"
          format: "HTML"
          failOnCVSS: "7"
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: ${{ github.workspace }}/reports

  # ---------------------------------------------------------------
  # Docker-Image Job (depends on build)
  # ---------------------------------------------------------------
  docker:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract project version
        id: project_version
        run: echo "version=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.1.0:exec)" >> $GITHUB_OUTPUT

      # Multi-stage build (referenced Dockerfile)
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.project_version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          build-args: |
            JAR_FILE=target/commerce-sphere.jar

  # ---------------------------------------------------------------
  # Deploy Job
  # ---------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: docker
    environment:
      name: ${{ github.event.inputs.deploy_environment || 'staging' }}
      url: https://commerce-${{ github.event.inputs.deploy_environment || 'staging' }}.example.com
    concurrency:
      group: "deploy-${{ github.event.inputs.deploy_environment || 'staging' }}"
      cancel-in-progress: false
    timeout-minutes: 30

    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          repository: org/commerce-sphere-infrastructure
          token: ${{ secrets.GH_PAT }}
          path: infra

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.28.3

      - name: Authenticate to AKS
        uses: Azure/aks-set-context@v3
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          cluster-name: ${{ secrets.AKS_CLUSTER }}
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}

      - name: Substitute image tag
        run: |
          export IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.docker.outputs.tag }}
          yq e '.spec.template.spec.containers[0].image = strenv(IMAGE)' -i infra/k8s/deployment.yaml

      - name: Deploy (Blue/Green)
        run: |
          kubectl apply -f infra/k8s/configmap.yaml
          kubectl apply -f infra/k8s/deployment.yaml
          kubectl rollout status deployment/commerce-sphere -n commerce

      - name: Smoke Test Endpoint
        run: |
          set -e
          ENDPOINT=https://commerce-${{ github.event.inputs.deploy_environment || 'staging' }}.example.com/actuator/health
          for i in {1..15}; do
            STATUS=$(curl -sSL -w "%{http_code}" -o /dev/null $ENDPOINT || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check succeeded"
              exit 0
            fi
            echo "Waiting for service...attempt $i"
            sleep 10
          done
          echo "Smoke test failed"
          exit 1

      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":rocket: Deployment of *CommerceSphere* `${{ needs.docker.outputs.tag }}` to `${{ github.event.inputs.deploy_environment || 'staging' }}` finished with status *${{ job.status }}*"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```