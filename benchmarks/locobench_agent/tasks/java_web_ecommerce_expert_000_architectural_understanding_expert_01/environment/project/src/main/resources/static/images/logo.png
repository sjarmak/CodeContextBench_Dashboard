package com.commercesphere.platform.assets;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Base64;
import java.util.Objects;
import java.util.concurrent.atomic.AtomicReference;

/**
 * Centralized access point for the CommerceSphere logo that is bundled inside the
 * application JAR/WAR.  All consumers—including REST controllers returning the
 * logo as a {@code byte[]} and Thymeleaf templates requiring a base64 string—
 * should use this utility instead of accessing the classpath resource directly.
 *
 * <p>This indirection offers:
 * <ul>
 *     <li>Lazy, thread-safe caching of the binary payload</li>
 *     <li>Graceful fallback if the resource is missing or corrupted</li>
 *     <li>A single place to audit read access for regulatory/logging purposes</li>
 * </ul>
 *
 * The logo is located at {@code src/main/resources/static/images/logo.png}.
 */
public final class LogoAsset {

    private static final Logger LOGGER = LoggerFactory.getLogger(LogoAsset.class);

    /**
     * Classpath location of the logo file (absolute).
     */
    private static final String RESOURCE_PATH = "/static/images/logo.png";

    /**
     * In-memory, lazy-loaded cache of the logo bytes. The {@link AtomicReference}
     * guarantees visibility across threads without synchronizing access on every
     * invocation.
     */
    private static final AtomicReference<byte[]> BYTES_CACHE = new AtomicReference<>();

    /**
     * Private constructor to prevent instantiation.
     */
    private LogoAsset() {
        throw new UnsupportedOperationException("Utility class—do not instantiate.");
    }

    /**
     * Returns the raw bytes of the CommerceSphere logo. The payload is loaded
     * lazily and cached for subsequent calls.
     *
     * @return non-null array containing the PNG bytes
     * @throws IllegalStateException if the resource is missing or cannot be read
     */
    public static byte[] getBytes() {
        byte[] cached = BYTES_CACHE.get();
        if (cached != null) {
            return cached.clone();
        }

        // Attempt to load the resource exactly once
        synchronized (BYTES_CACHE) {
            cached = BYTES_CACHE.get();
            if (cached != null) {
                return cached.clone();
            }

            try (InputStream is = LogoAsset.class.getResourceAsStream(RESOURCE_PATH)) {
                Objects.requireNonNull(is, "Logo resource not found: " + RESOURCE_PATH);

                byte[] bytes = is.readAllBytes();
                BYTES_CACHE.set(bytes);
                LOGGER.debug("Logo resource loaded ({} bytes).", bytes.length);
                return bytes.clone();
            } catch (IOException | NullPointerException ex) {
                String msg = "Failed to load logo resource from " + RESOURCE_PATH;
                LOGGER.error(msg, ex);
                throw new IllegalStateException(msg, ex);
            }
        }
    }

    /**
     * Returns the logo encoded as a Base64 string, suitable for embedding in an
     * <img> tag: {@code <img src="data:image/png;base64,${logo}"/>}
     *
     * @return Base64 representation of the logo bytes (never {@code null})
     */
    public static String getBase64() {
        return Base64.getEncoder().encodeToString(getBytes());
    }

    /**
     * Returns the logo as a {@link BufferedImage} for server-side manipulation,
     * such as dynamically overlaying “BETA” watermarks or generating thumbnails.
     *
     * @return the decoded {@link BufferedImage}
     * @throws IllegalStateException if the image cannot be decoded
     */
    public static BufferedImage getBufferedImage() {
        try (InputStream is = LogoAsset.class.getResourceAsStream(RESOURCE_PATH)) {
            Objects.requireNonNull(is, "Logo resource not found: " + RESOURCE_PATH);
            return ImageIO.read(is);
        } catch (IOException | NullPointerException ex) {
            String msg = "Failed to decode logo resource from " + RESOURCE_PATH;
            LOGGER.error(msg, ex);
            throw new IllegalStateException(msg, ex);
        }
    }

    /**
     * Writes the logo to the supplied {@link java.io.OutputStream}. The stream is
     * <em>not</em> closed by this method.
     *
     * @param out destination stream
     * @throws IOException if writing fails
     */
    public static void writeTo(java.io.OutputStream out) throws IOException {
        Objects.requireNonNull(out, "OutputStream must not be null");
        out.write(getBytes());
    }

    /**
     * Utility method that returns the size of the logo, in bytes, without forcing
     * an IO read if already cached.
     *
     * @return logo size in bytes
     */
    public static int size() {
        byte[] cached = BYTES_CACHE.get();
        return cached != null ? cached.length : loadSizeIfPresent();
    }

    private static int loadSizeIfPresent() {
        try (InputStream is = LogoAsset.class.getResourceAsStream(RESOURCE_PATH)) {
            return (is == null) ? 0 : is.available();
        } catch (IOException ioEx) {
            LOGGER.warn("Unable to determine logo size.", ioEx);
            return 0;
        }
    }

    /**
     * Converts the logo into another image format. Useful for on-the-fly
     * transformations (e.g., returning JPEG thumbnails on low-bandwidth
     * connections).
     *
     * @param formatName any format supported by ImageIO (e.g., "jpeg", "gif")
     * @return byte[] in requested format
     * @throws IllegalStateException if conversion fails
     */
    public static byte[] asFormat(String formatName) {
        try {
            BufferedImage img = getBufferedImage();
            try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
                boolean written = ImageIO.write(img, formatName, baos);
                if (!written) {
                    throw new IllegalArgumentException(
                            "Unsupported image format requested: " + formatName);
                }
                return baos.toByteArray();
            }
        } catch (IOException ex) {
            String msg = "Failed to convert logo to format: " + formatName;
            LOGGER.error(msg, ex);
            throw new IllegalStateException(msg, ex);
        }
    }
}