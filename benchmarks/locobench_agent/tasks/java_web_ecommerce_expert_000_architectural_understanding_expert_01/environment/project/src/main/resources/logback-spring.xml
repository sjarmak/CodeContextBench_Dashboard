<?xml version="1.0" encoding="UTF-8"?>
<!--
    ------------------------------------------------------------------------
    CommerceSphere Enterprise Suite – Unified Logging Configuration
    ------------------------------------------------------------------------
    Description  : Centralised Logback configuration used by every JVM
                   launched for the CommerceSphere Enterprise Suite.
    Goals        :
      • Provide consistent, audit-grade logging with PII masking
      • Stream structured logs to Logstash/ELK and local rotating files
      • Dynamically switch log levels via Spring profiles
      • Include MDC values like correlationId, tenantId, userName
    ------------------------------------------------------------------------
    Notes        :
      • This file is parsed by Spring Boot (logback-spring.xml) which allows
        profile-specific sections: <springProfile name="prod"> … </springProfile>
      • Requires dependencies:
          - ch.qos.logback:logback-classic
          - net.logstash.logback:logstash-logback-encoder
          - org.springframework.boot:spring-boot-starter-logging
    ------------------------------------------------------------------------
-->
<configuration scan="true" scanPeriod="30 seconds">

    <!-- ============================================================= -->
    <!--  Properties                                                   -->
    <!-- ============================================================= -->
    <property name="APP_NAME"           value="CommerceSphere" />
    <property name="LOG_HOME"           value="${LOG_HOME:-${HOME:-.}/logs}" />
    <property name="LOG_ARCHIVE"        value="${LOG_HOME}/archive" />
    <property name="MAX_FILE_SIZE"      value="50MB" />
    <property name="MAX_HISTORY"        value="90" />
    <property name="TOTAL_SIZE_CAP"     value="10GB" />

    <!-- Pattern with colour (for console) -->
    <property name="CONSOLE_PATTERN"
              value="%highlight([%d{HH:mm:ss.SSS}] [%thread] %-5level %cyan(${APP_NAME}) %yellow(%logger{36}) – %msg%n)" />

    <!-- Pattern without colour (for files) + masking of sensitive data -->
    <property name="FILE_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %X{correlationId:-N/A} %X{tenantId:-N/A} %X{userName:-system} %logger{36} – %replace(%msg){'(?i)(\"?(cardNumber|cvv|password|ssn)\"?\\s*:\\s*\"?)[^\",}]+(\"?)','$1***$3'}%n" />

    <!-- ============================================================= -->
    <!--  Encoders                                                     -->
    <!-- ============================================================= -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- Rolling file for general application logs -->
    <appender name="FILE_APP" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_HOME}/application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- Daily rollover with index in case of size trigger -->
            <fileNamePattern>${LOG_ARCHIVE}/application.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${FILE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- Rolling file dedicated to ERROR and FATAL logs -->
    <appender name="FILE_ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
        <file>${LOG_HOME}/error.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_ARCHIVE}/error.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${FILE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- Audit log in JSON for compliance -->
    <appender name="AUDIT_JSON" class="net.logstash.logback.appender.RollingFileAppender">
        <file>${LOG_HOME}/audit.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_ARCHIVE}/audit.%d{yyyy-MM-dd}.%i.json.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>UTC</timeZone>
                </timestamp>
                <pattern>
                    <pattern>
                        {
                          "level": "%level",
                          "thread": "%thread",
                          "logger": "%logger",
                          "message": "%msg",
                          "corrId": "%X{correlationId}",
                          "tenantId": "%X{tenantId}",
                          "user": "%X{userName}"
                        }
                    </pattern>
                </pattern>
                <arguments/>
                <mdc/>
                <stackTrace/>
            </providers>
        </encoder>
    </appender>

    <!-- Logstash TCP appender (non-blocking) -->
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>${LOGSTASH_HOST:-localhost}:${LOGSTASH_PORT:-5044}</destination>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <timeZone>UTC</timeZone>
                </timestamp>
                <pattern>
                    <pattern>
                        {
                          "app": "${APP_NAME}",
                          "profile": "${SPRING_PROFILES_ACTIVE:-default}",
                          "level": "%level",
                          "logger": "%logger",
                          "message": "%msg",
                          "corrId": "%X{correlationId}",
                          "tenantId": "%X{tenantId}",
                          "user": "%X{userName}"
                        }
                    </pattern>
                </pattern>
                <arguments/>
                <mdc/>
                <stackTrace/>
            </providers>
        </encoder>
        <!-- Retry logic to avoid back-pressure on application threads -->
        <keepAliveDuration>5 minutes</keepAliveDuration>
        <reconnectionDelay>10 seconds</reconnectionDelay>
    </appender>

    <!-- ============================================================= -->
    <!--  Async Wrappers – Ensure application threads are non-blocking -->
    <!-- ============================================================= -->
    <appender name="ASYNC_FILE_APP" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>10240</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
        <appender-ref ref="FILE_APP" />
    </appender>

    <appender name="ASYNC_FILE_ERROR" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>2048</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
        <appender-ref ref="FILE_ERROR" />
    </appender>

    <appender name="ASYNC_AUDIT" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>4096</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
        <appender-ref ref="AUDIT_JSON" />
    </appender>

    <appender name="ASYNC_LOGSTASH" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>8192</queueSize>
        <discardingThreshold>1</discardingThreshold>
        <neverBlock>true</neverBlock>
        <appender-ref ref="LOGSTASH" />
    </appender>

    <!-- ============================================================= -->
    <!--  Logger Definitions                                           -->
    <!-- ============================================================= -->

    <!-- Framework noise reduction -->
    <logger name="org.springframework"     level="INFO"  />
    <logger name="org.hibernate.SQL"       level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_FILE_APP" />
    </logger>
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>

    <!-- Application packages -->
    <logger name="com.commercesphere"      level="INFO" additivity="false">
        <appender-ref ref="ASYNC_FILE_APP" />
        <appender-ref ref="ASYNC_LOGSTASH" />
    </logger>

    <!-- Dedicated audit logger -->
    <logger name="AUDIT" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_AUDIT" />
    </logger>

    <!-- Production overrides -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE" />
            <appender-ref ref="ASYNC_FILE_APP" />
            <appender-ref ref="ASYNC_FILE_ERROR" />
            <appender-ref ref="ASYNC_LOGSTASH" />
        </root>
    </springProfile>

    <!-- Development overrides -->
    <springProfile name="dev,default">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE" />
            <appender-ref ref="ASYNC_FILE_APP" />
            <appender-ref ref="ASYNC_FILE_ERROR" />
        </root>
    </springProfile>

</configuration>
