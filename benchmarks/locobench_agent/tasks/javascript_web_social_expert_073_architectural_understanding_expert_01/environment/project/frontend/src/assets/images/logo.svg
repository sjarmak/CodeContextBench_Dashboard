/**
 * File: pulselearn-campus-hub/frontend/src/assets/images/logo.svg
 * NOTE:
 *   Despite the .svg extension, this file intentionally exports a React component that
 *   encapsulates PulseLearn’s animated logo. The build pipeline is configured to treat
 *   any `.svg` located under `assets/images` that begins with `"use strict";` as a
 *   JavaScript module instead of a static asset.  This allows us to co-locate the
 *   artwork and the interaction logic while keeping import paths unchanged:
 *
 *     import PulseLogo from '@/assets/images/logo.svg';
 *
 *   The component listens to domain events published on a very small, zero-dependency
 *   pub/sub bus (see `ensureGlobalEventBus`) and will “pulse” whenever important
 *   events such as `BadgeAwarded` or `AssignmentSubmitted` arrive.
 */

'use strict';

import React, { useEffect, useRef, useState } from 'react';
import PropTypes from 'prop-types';

/* -------------------------------------------------------------------------- */
/*                              Event-Bus Helpers                             */
/* -------------------------------------------------------------------------- */

/**
 * Ensures that a very tiny, global, in-memory event bus is available
 * on `window.PULSE_BUS`.  The platform’s real event-bus abstraction
 * (based on NATS or WebSocket streams) attaches itself to the same
 * interface so this component is environment-agnostic (storybook,
 * unit-tests, production, etc.).
 */
function ensureGlobalEventBus() {
  if (typeof window === 'undefined') {
    // SSR / unit tests – create a throw-away stub.
    return {
      subscribe: () => () => {},
      publish: () => {},
    };
  }

  if (!window.PULSE_BUS) {
    const listeners = new Map();

    window.PULSE_BUS = {
      subscribe(eventType, handler) {
        if (!listeners.has(eventType)) listeners.set(eventType, new Set());
        listeners.get(eventType).add(handler);

        // Return un-subscribe function
        return () => {
          listeners.get(eventType)?.delete(handler);
        };
      },

      publish(eventType, payload = {}) {
        if (!listeners.has(eventType)) return;
        listeners.get(eventType).forEach((cb) => {
          try {
            cb(payload);
          } catch (err) {
            // eslint-disable-next-line no-console
            console.error('[PulseBus] Event handler error:', err);
          }
        });
      },
    };
  }

  return window.PULSE_BUS;
}

const BUS = ensureGlobalEventBus();

/* -------------------------------------------------------------------------- */
/*                              Utility Helpers                               */
/* -------------------------------------------------------------------------- */

/**
 * Generates a random vibrant HSL color string that still provides enough
 * contrast against white backgrounds.
 */
function getRandomAccentHsl() {
  const hue = Math.floor(Math.random() * 360);
  const saturation = 70 + Math.random() * 20; // 70–90%
  const lightness = 45 + Math.random() * 10; // 45–55%
  return `hsl(${hue} ${saturation}% ${lightness}%)`;
}

/* -------------------------------------------------------------------------- */
/*                                 Component                                  */
/* -------------------------------------------------------------------------- */

const PULSABLE_EVENTS = new Set([
  'BadgeAwarded',
  'AssignmentSubmitted',
  'QuizCompleted',
  'AnnouncementPublished',
  'PeerFeedbackGiven',
]);

/**
 * PulseLogo
 *
 * Renders the PulseLearn Campus Hub logo as SVG.  When certain domain events
 * are received on the global event-bus the logo performs a quick “pulse”
 * animation and temporarily changes its accent color to visualize activity.
 */
export default function PulseLogo({
  width = 128,
  height = 128,
  className = '',
  eventBus = BUS,
}) {
  const [accentColor, setAccentColor] = useState(getRandomAccentHsl);

  const timeoutRef = useRef(null);
  const svgRef = useRef(null);

  useEffect(() => {
    // Subscribe to relevant domain events
    const unsubscribers = Array.from(PULSABLE_EVENTS, (evt) =>
      eventBus.subscribe(evt, handleDomainEvent),
    );

    return () => {
      // Clean up bus subscriptions & any pending timeout
      unsubscribers.forEach((unsub) => unsub());
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, [eventBus]);

  /**
   * Handler invoked for every relevant domain event.
   *   – triggers CSS pulse animation
   *   – assigns a new, pseudo-random accent color
   */
  function handleDomainEvent() {
    // ⚡ Trigger a new accent color
    setAccentColor(getRandomAccentHsl());

    // ⚡ Apply CSS class that starts the pulse animation
    const node = svgRef.current;
    if (!node) return;

    node.classList.remove('pl-pulse');
    // Force reflow to restart animation
    // eslint-disable-next-line no-unused-expressions
    node.offsetWidth; // Reflow
    node.classList.add('pl-pulse');

    // Ensure the class is removed after animation ends (600ms)
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    timeoutRef.current = setTimeout(() => {
      node.classList.remove('pl-pulse');
    }, 650);
  }

  /* ---------------------------------------------------------------------- */

  return (
    <svg
      ref={svgRef}
      width={width}
      height={height}
      viewBox="0 0 256 256"
      xmlns="http://www.w3.org/2000/svg"
      role="img"
      aria-label="PulseLearn Logo"
      className={`pl-logo ${className}`}
    >
      <defs>
        <linearGradient id="pulseGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor={accentColor} />
          <stop offset="100%" stopColor="#ffffff" />
        </linearGradient>

        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow
            dx="0"
            dy="3"
            stdDeviation="6"
            floodColor="rgba(0,0,0,0.25)"
          />
        </filter>
      </defs>

      {/* Outer ring */}
      <circle
        cx="128"
        cy="128"
        r="110"
        fill="none"
        stroke="url(#pulseGradient)"
        strokeWidth="18"
        filter="url(#shadow)"
      />

      {/* Inner bolt (⚡) */}
      <path
        d="M144.9 27.8c4.7-.8 8.3 4.1 6 8.4l-38.2 73.7h36c4.6 0 7.7 4.9 5.5 9l-53.8 104.7c-2.2 4.4-8.6 3.1-8.9-1.8l-3.6-63H63.8c-4.8 0-8-5.2-5.5-9.4L144.9 27.8z"
        fill={accentColor}
      />

      {/* Text */}
      <text
        x="128"
        y="235"
        textAnchor="middle"
        fontFamily="var(--pl-font-sans, sans-serif)"
        fontSize="24"
        fill="#1a1a1a"
      >
        PulseLearn
      </text>

      {/* Additional styles injected directly for encapsulation */}
      <style>{`
        .pl-logo .pl-pulse {
          animation: plPulse 0.6s ease-out;
        }

        @keyframes plPulse {
          0%   { transform: scale(1);   }
          50%  { transform: scale(1.15); }
          100% { transform: scale(1);   }
        }
      `}</style>
    </svg>
  );
}

/* -------------------------------------------------------------------------- */
/*                                Prop Types                                  */
/* -------------------------------------------------------------------------- */

PulseLogo.propTypes = {
  /** Width of the SVG in pixels */
  width: PropTypes.number,
  /** Height of the SVG in pixels */
  height: PropTypes.number,
  /** Optional additional CSS classes */
  className: PropTypes.string,
  /**
   * Custom event-bus implementation for advanced usage
   * (storybook mocks, tests, etc.).  Must expose { subscribe, publish }.
   */
  eventBus: PropTypes.shape({
    subscribe: PropTypes.func.isRequired,
    publish: PropTypes.func.isRequired,
  }),
};

PulseLogo.defaultProps = {
  width: 128,
  height: 128,
  className: '',
  eventBus: BUS,
};

/* -------------------------------------------------------------------------- */
/*                               Re-export Bus                                */
/* -------------------------------------------------------------------------- */

/**
 * Re-exporting the global bus instance allows other modules to import it
 * directly from the logo module without having to know its internal path.
 *
 *   import { pulseBus } from '@/assets/images/logo.svg';
 *   pulseBus.publish('AssignmentSubmitted', { assignmentId: 'A-123' });
 */
export const pulseBus = BUS;

/* -------------------------------------------------------------------------- */
/*                            Hot-Module Support                              */
/* -------------------------------------------------------------------------- */

if (import.meta && import.meta.hot) {
  import.meta.hot.accept();
}