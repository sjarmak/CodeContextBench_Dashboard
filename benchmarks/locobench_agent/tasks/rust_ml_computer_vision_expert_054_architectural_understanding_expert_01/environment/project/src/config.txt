# -----------------------------------------------------------------------
# VisuTility Orchestrator â€” Central Configuration
# Format: TOML
#
# This file drives every layer of the platform, from camera-stream
# ingestion down to model monitoring and observability.  All sections
# are read at start-up via the `config` crate and are *hot-reloadable*
# when the file changes on disk.
#
# Values here represent sane production defaults.  Environment-specific
# overrides (e.g. `config.prod.toml`) can selectively replace keys by
# using the same hierarchical path.
# -----------------------------------------------------------------------

############################################################################
# Global Server Settings
############################################################################
[server]
host                = "0.0.0.0"
rest_port           = 8080          # Public REST gateway
grpc_port           = 50051         # Internal gRPC interface
management_port     = 8081          # /health, /metrics, /ready
max_http_workers    = "num_cpus"    # Auto-scaled if set to "num_cpus"
graceful_shutdown_s = 30            # Seconds to wait before force exit

############################################################################
# Storage & Infrastructure Backends
############################################################################
[database]
url          = "postgresql://visutility:CHANGE_ME@localhost:5432/visutility"
pool_size    = 32
connect_secs = 5

[redis]
url              = "redis://127.0.0.1/"
cache_ttl_secs   = 600
connection_pool  = 20

[kafka]
brokers      = ["kafka1:9092", "kafka2:9092"]
group_id     = "visutility_ingress"
ingest_topic = "visutility.ingress"
result_topic = "visutility.results"
offset       = "earliest"

[s3]
bucket   = "visutility-prod"
region   = "us-east-1"
endpoint = "https://s3.amazonaws.com"

############################################################################
# File-system Locations
############################################################################
[storage]
raw_video_path        = "/mnt/visutility/raw/"
processed_frame_path  = "/mnt/visutility/processed/"
model_registry_path   = "/mnt/visutility/models/"
tmp_path              = "/tmp/visutility/"

############################################################################
# Ingress Layer
############################################################################
[ingress]
max_parallel_streams = 64
frame_batch_size     = 128
reconnect_backoff_s  = 10
supported_modalities = ["rgb", "thermal", "depth"]

[ingress.camera_defaults]
fps        = 30
resolution = "1920x1080"

[ingress.rtsp]
username     = "user"
password     = "pass"
timeout_secs = 5

############################################################################
# Data-Ops Layer
############################################################################
[data_ops]
frame_sampler   = { strategy = "adaptive", target_fps = 5 }
frame_cleansing = { enabled = true, denoise = true, motion_blur_threshold = 0.40 }
augmentation    = { enabled = true, brightness = [0.8, 1.2], flip = true, rotation = 15 }

############################################################################
# Feature-Ops Layer
############################################################################
[feature_ops]
extractor_factory  = "default"
enabled_extractors = ["hog", "orb", "cnn"]
dynamic_switching  = true

############################################################################
# Model-Ops Layer
############################################################################
[model_ops]
default_model        = "yolov7"
autoretrain_cron     = "0 3 * * 0"   # Weekly, Sunday 03:00
drift_threshold      = 0.15
hyperparameter_tuning = true
tuning_backend       = "optuna"
tuning_trials        = 50
experiment_tracking_uri = "http://mlflow:5000"

[model_ops.registry]
type              = "local"
path              = "/mnt/visutility/models/registry"
retention_versions = 10

############################################################################
# Serving-Ops Layer
############################################################################
[serving_ops]
inference_batch_size = 32
concurrency_limit    = 128
serialization_format = "onnx"

############################################################################
# Utility-Ops Layer
############################################################################
[utility_ops]
logging_level            = "info"
metrics_push_interval_s  = 15
sentry_dsn               = ""          # Fill to enable error reporting

############################################################################
# Authentication / Tenancy
############################################################################
[auth]
enabled               = true
jwt_secret            = "CHANGE_ME"
access_token_minutes  = 60

[tenancy]
mode                 = "multi"
default_tenant_quota = { streams = 20, storage_gb = 100 }

############################################################################
# Automated Retraining
############################################################################
[automated_retraining]
enabled              = true
min_dataset_size     = 10_000
evaluation_metric    = "mAP@0.5"
improvement_threshold = 0.02

############################################################################
# Model Monitoring & Alerting
############################################################################
[model_monitoring]
enabled               = true
latency_alert_ms      = 200
accuracy_drop_alert   = 0.05
slack_webhook_url     = "https://hooks.slack.com/services/CHANGE_ME"

############################################################################
# Hyperparameter Tuning
############################################################################
[hyperparameter_tuning]
strategy           = "bayesian"
max_parallel_jobs  = 4
early_stopping_rounds = 10

############################################################################
# Kubernetes Deployment Defaults
############################################################################
[kubernetes]
enabled           = true
namespace         = "visutility"
image_pull_secret = "regcred"
node_selector     = { "kubernetes.io/arch" = "amd64" }

############################################################################
# Observability
############################################################################
[observability]
jaeger_endpoint   = "http://jaeger:14268/api/traces"
log_format        = "json"

############################################################################
# Security / TLS
############################################################################
[security]
allowed_origins    = ["*"]
ingress_tls        = true
certificate_path   = "/etc/ssl/certs/visutility.crt"
key_path           = "/etc/ssl/private/visutility.key"

############################################################################
# Standard Endpoints
############################################################################
[endpoints]
health    = "/health"
metrics   = "/metrics"
readiness = "/ready"
liveness  = "/alive"

############################################################################
# Profiles
############################################################################
#
# profile.dev and profile.prod can override any of the keys above.  The
# `config` loader merges in the order: default -> {env} -> environment
# variables, where ENV can be picked up from VISUTILITY_ENV.
############################################################################

[profile.dev.server]
logging_level = "debug"

[profile.prod.server]
logging_level = "info"