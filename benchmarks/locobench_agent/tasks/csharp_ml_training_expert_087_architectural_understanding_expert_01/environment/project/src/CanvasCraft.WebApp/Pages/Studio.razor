@page "/studio/{ModelId:int?}"
@inject Services.IExperimentTrackingService ExperimentService
@inject Services.IModelTrainingService     TrainingService
@inject Services.IModelRegistryService     RegistryService
@inject ILogger<Studio>                    Logger
@inject NavigationManager                  NavManager
@inject IJSRuntime                         JsRuntime

@using CanvasCraft.WebApp.Models
@using CanvasCraft.WebApp.Shared
@using Microsoft.AspNetCore.SignalR.Client

<!--
    Studio.razor
    =============
    Central coordinating view for CanvasCraft ML Studio.  
    Lets creators:
        ‚Ä¢ Browse experiments and checkpoints  
        ‚Ä¢ Trigger new training runs ("Re-paint")  
        ‚Ä¢ Observe metrics / live logs in real-time  
        ‚Ä¢ Promote successful models to the Model Registry  

    NOTE: Heavy lifting (long-running tasks, data I/O) is delegated
          to backend services through typed gRPC / REST / SignalR clients.
-->

<PageTitle>CanvasCraft Studio</PageTitle>

<div class="studio-container">
    <h1 class="text-center">üñåÔ∏è CanvasCraft Studio</h1>

    @if (_isBusy)
    {
        <Spinner />
    }
    else if (_loadError is not null)
    {
        <ErrorBanner Exception="_loadError" OnRetry="ReloadAsync" />
    }
    else
    {
        <section class="row">
            <!-- Experiment "Palette" -->
            <aside class="col-3">
                <h4 class="mt-3">Experiments</h4>
                <button class="btn btn-primary w-100 mb-2" @onclick="CreateNewExperimentAsync">
                    <i class="bi bi-plus-circle"></i> New Experiment
                </button>

                <ul class="list-group experiment-list">
                    @foreach (var exp in _experiments)
                    {
                        <li class="list-group-item list-group-item-action
                                   @(exp.Id == _selectedExperiment?.Id ? "active" : string.Empty)"
                            @onclick="@(() => SelectExperiment(exp))">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>@exp.Name</span>
                                @if (exp.Status == ExperimentStatus.Running)
                                {
                                    <span class="spinner-border spinner-border-sm" title="Running"></span>
                                }
                            </div>
                            <small class="text-muted">@exp.CreatedAt.ToLocalTime().ToString("g")</small>
                        </li>
                    }
                </ul>
            </aside>

            <!-- Workspace -->
            <main class="col">
                @if (_selectedExperiment is null)
                {
                    <div class="alert alert-info">
                        Select or create an experiment to get started.
                    </div>
                }
                else
                {
                    <nav>
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link @(ActiveTab == TabName.Overview ? "active" : string.Empty)"
                                   @onclick="@(() => ActiveTab = TabName.Overview)">Overview</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ActiveTab == TabName.Metrics ? "active" : string.Empty)"
                                   @onclick="@(() => ActiveTab = TabName.Metrics)">Metrics</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ActiveTab == TabName.Logs ? "active" : string.Empty)"
                                   @onclick="@(() => ActiveTab = TabName.Logs)">Live Logs</a>
                            </li>
                        </ul>
                    </nav>

                    <div class="tab-content p-3 border border-top-0">
                        @switch (ActiveTab)
                        {
                            case TabName.Overview:
                                <StudioOverview Experiment="_selectedExperiment"
                                                OnTrainClick="StartTrainingAsync"
                                                OnStopClick="StopTrainingAsync"
                                                OnPromoteClick="PromoteModelAsync" />
                                break;

                            case TabName.Metrics:
                                @if (_metricsLoading)
                                {
                                    <Spinner />
                                }
                                else if (_metricsError is not null)
                                {
                                    <ErrorBanner Exception="_metricsError" OnRetry="LoadMetricsAsync" />
                                }
                                else
                                {
                                    <MetricGallery Metrics="_metrics" />
                                }
                                break;

                            case TabName.Logs:
                                <LogConsole Lines="_logLines" />
                                break;
                        }
                    </div>
                }
            </main>
        </section>
    }
</div>

@code
{
    #region Fields / State

    [Parameter] public int? ModelId { get; set; }

    private IEnumerable<ExperimentDto> _experiments           = Array.Empty<ExperimentDto>();
    private ExperimentDto?             _selectedExperiment;
    private IEnumerable<MetricDto>     _metrics               = Array.Empty<MetricDto>();

    private bool        _isBusy;
    private bool        _metricsLoading;
    private Exception?  _loadError;
    private Exception?  _metricsError;

    private HubConnection? _logHub;
    private readonly List<string> _logLines = new();
    private CancellationTokenSource? _liveLogCts;

    private TabName ActiveTab { get; set; } = TabName.Overview;

    #endregion

    #region Lifecycle

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_logHub is not null)
        {
            await _logHub.DisposeAsync();
        }
        _liveLogCts?.Cancel();
    }

    #endregion

    #region Data Loading

    private async Task ReloadAsync()
    {
        _isBusy    = true;
        _loadError = null;
        try
        {
            _experiments = await ExperimentService.ListExperimentsAsync();
            // Auto-select experiment passed via route
            if (ModelId.HasValue && _selectedExperiment is null)
            {
                SelectExperiment(_experiments.FirstOrDefault(e => e.Id == ModelId.Value));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load experiments");
            _loadError = ex;
        }
        finally
        {
            _isBusy = false;
        }
        StateHasChanged();
    }

    private async Task LoadMetricsAsync()
    {
        if (_selectedExperiment is null) return;

        _metricsLoading = true;
        _metricsError   = null;
        try
        {
            _metrics = await ExperimentService.GetMetricsAsync(_selectedExperiment.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load metrics");
            _metricsError = ex;
        }
        finally
        {
            _metricsLoading = false;
        }
    }

    #endregion

    #region Experiment Actions

    private void SelectExperiment(ExperimentDto? experiment)
    {
        if (experiment is null) return;

        _selectedExperiment = experiment;
        _logLines.Clear();
        ActiveTab = TabName.Overview;

        _ = LoadMetricsAsync();
        _ = ConnectLiveLogsAsync(experiment.Id);
    }

    private async Task CreateNewExperimentAsync()
    {
        var name = await JsRuntime.InvokeAsync<string>("prompt", "Name your new experiment:");
        if (string.IsNullOrWhiteSpace(name)) return;

        try
        {
            var newExp           = await ExperimentService.CreateExperimentAsync(name);
            _experiments         = _experiments.Prepend(newExp);
            SelectExperiment(newExp);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create experiment");
            await JsRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task StartTrainingAsync()
    {
        if (_selectedExperiment is null) return;

        try
        {
            await TrainingService.StartTrainingAsync(_selectedExperiment.Id);
            await ReloadAsync();
            await JsRuntime.InvokeVoidAsync("toast.success", "Training started");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start training");
            await JsRuntime.InvokeVoidAsync("toast.error", ex.Message);
        }
    }

    private async Task StopTrainingAsync()
    {
        if (_selectedExperiment is null) return;

        try
        {
            await TrainingService.CancelTrainingAsync(_selectedExperiment.Id);
            await ReloadAsync();
            await JsRuntime.InvokeVoidAsync("toast.info", "Training cancelled");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to stop training");
            await JsRuntime.InvokeVoidAsync("toast.error", ex.Message);
        }
    }

    private async Task PromoteModelAsync(ModelCheckpointDto checkpoint)
    {
        try
        {
            await RegistryService.PromoteModelAsync(checkpoint.Id);
            await JsRuntime.InvokeVoidAsync("toast.success", "Model promoted to registry");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Promotion failed");
            await JsRuntime.InvokeVoidAsync("toast.error", ex.Message);
        }
    }

    #endregion

    #region Live Logs

    private async Task ConnectLiveLogsAsync(int experimentId)
    {
        _liveLogCts?.Cancel();
        _liveLogCts = new CancellationTokenSource();

        // Dispose previous hub
        if (_logHub is not null)
        {
            await _logHub.DisposeAsync();
        }

        _logHub = new HubConnectionBuilder()
            .WithUrl(NavManager.ToAbsoluteUri($"/hubs/logs?experimentId={experimentId}"))
            .WithAutomaticReconnect()
            .Build();

        _logHub.On<string>("ReceiveLogLine", line =>
        {
            _logLines.Add(line);
            if (_logLines.Count > 1000)
            {
                _logLines.RemoveAt(0); // keep buffer manageable
            }
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await _logHub.StartAsync(_liveLogCts.Token);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to connect to live log hub");
        }
    }

    #endregion

    #region Helpers / Enums

    private enum TabName
    {
        Overview,
        Metrics,
        Logs
    }

    #endregion
}

<!-- Local CSS, could be moved to a .scss file -->
<style>
    .studio-container  { padding: 1rem 2rem; }
    .experiment-list   { max-height: 65vh; overflow-y: auto; }
    .tab-content       { min-height: 45vh; background: #fff; }
</style>