@using System.Reactive.Linq
@using CanvasCraft.WebApp.Services.Abstractions
@using CanvasCraft.WebApp.Shared.Components      // Re-usable UI components (e.g. Sidebar, Toasts)
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.Extensions.Logging

@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject ILogger<MainLayout> Logger
@inject IThemeService ThemeService
@inject IExperimentTracker ExperimentTracker
@inject INotificationService NotificationService

@implements IDisposable

<!--
    MainLayout.razor
    CanvasCraft ML Studio â€“ Application shell.
    Provides:
    â€¢  Top navigation bar
    â€¢  Collapsible side-bar
    â€¢  Toast / notification container
    â€¢  Theme (light / dark) toggle
    â€¢  Responsive behavior & keyboard shortcuts
    â€¢  Real-time experiment progress indicator
-->
<ErrorBoundary @ref="_errorBoundary" OnError="HandleError">
    <ErrorContent>
        <div class="alert alert-danger m-4" role="alert">
            <h4 class="alert-heading">Unexpected error ðŸ˜¢</h4>
            <p>Something went wrong while rendering the application shell.</p>
            <p class="mb-0">
                If the problem persists please reload the page or contact the CanvasCraft support team.
            </p>
        </div>
    </ErrorContent>

    <div class="@_containerCss">
        <!-- Side-bar (collapsible) -->
        <Sidebar CollapseRequested="@_collapseSidebar"
                 OnCollapseChanged="HandleSidebarCollapseChanged"
                 CurrentUri="@Navigation.Uri"
                 DarkModeEnabled="@ThemeService.IsDarkMode" />

        <div class="main-area flex-grow-1 d-flex flex-column">
            <!-- Top navigation ------------------------------------------------------------------->
            <nav class="navbar navbar-expand-lg @(_navbarCss)">
                <div class="container-fluid">
                    <button class="btn btn-link text-decoration-none me-3"
                            @onclick="_collapseSidebar"
                            aria-label="Toggle navigation menu">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <a class="navbar-brand fw-bold" href="">
                        <img src="images/logo.svg" alt="CanvasCraft" class="logo" />
                        ML Studio
                    </a>

                    <div class="flex-grow-1"></div>

                    <!-- Experiment progress ------------------------------------------------------>
                    @if (_activeExperiment != null)
                    {
                        <ExperimentProgressWidget ExperimentInfo="_activeExperiment" />
                    }

                    <!-- Theme toggle ------------------------------------------------------------->
                    <button class="btn btn-outline-secondary ms-3"
                            title="@(_themeTooltip)"
                            @onclick="ToggleTheme">
                        <i class="@_themeIcon"></i>
                    </button>
                </div>
            </nav>

            <!-- Main page content --------------------------------------------------------------->
            <main class="flex-grow-1 position-relative">
                <Router AppAssembly="@typeof(Program).Assembly"
                        OnNavigateAsync="HandleRouteChanged">
                    <Found Context="routeData">
                        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
                        <FocusOnNavigate RouteData="@routeData" Selector="h1" />
                    </Found>
                    <NotFound>
                        <PageNotFound />
                    </NotFound>
                </Router>
            </main>

            <!-- Footer -------------------------------------------------------------------------->
            <footer class="footer bg-light border-top p-2 text-muted text-center">
                Â© @DateTime.UtcNow.Year CanvasCraft â€“ Unleash your creative models.
            </footer>
        </div>
    </div>

    <!-- Global notification renderer -->
    <ToastContainer />
</ErrorBoundary>

@code
{
    private const string DarkThemeCss = "dark-theme";
    private readonly IDisposable? _experimentSub;
    private readonly Subject<bool> _disposeNotifier = new();

    private bool _isSidebarCollapsed;
    private bool _isBusyRouting;
    private ErrorBoundary? _errorBoundary;
    private ExperimentStatus? _activeExperiment;

    // Computed CSS helpers ---------------------------------------------------------
    private string _containerCss => $"d-flex min-vh-100 overflow-hidden {(_isSidebarCollapsed ? "sidebar-collapsed" : string.Empty)}";
    private string _navbarCss => ThemeService.IsDarkMode ? "navbar-dark bg-dark" : "navbar-light bg-white";
    private string _themeIcon => ThemeService.IsDarkMode ? "fas fa-sun" : "fas fa-moon";
    private string _themeTooltip => ThemeService.IsDarkMode ? "Switch to light mode" : "Switch to dark mode";

    public MainLayout()
    {
        // Reactive subscription to experiment tracker.
        _experimentSub = ExperimentTracker
                          .ActiveExperimentStream
                          .TakeUntil(_disposeNotifier)
                          .ObserveOn(SynchronizationContext.Current!)
                          .Subscribe(
                              exp =>
                              {
                                  _activeExperiment = exp;
                                  StateHasChanged();
                              },
                              ex => Logger.LogError(ex, "Failed to observe active experiment.")
                          );
    }

    #region UI event handlers --------------------------------------------------------
    private void ToggleTheme()
    {
        ThemeService.Toggle();
        StateHasChanged();
    }

    private void _collapseSidebar()
    {
        _isSidebarCollapsed = !_isSidebarCollapsed;
    }

    private void HandleSidebarCollapseChanged(bool isCollapsed)
    {
        _isSidebarCollapsed = isCollapsed;
    }

    private async Task HandleRouteChanged(NavigationContext args)
    {
        try
        {
            _isBusyRouting = true;
            // Example of async pre-navigation logic (e.g. unsaved changes guard).
            await Task.Delay(0); // placeholder for real logic
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Navigation to {Uri} failed.", args.Path);
            NotificationService.Error("Navigation error", "Unable to load the requested page.");
            _errorBoundary?.Recover();
        }
        finally
        {
            _isBusyRouting = false;
        }
    }

    private void HandleError(Exception exception)
    {
        Logger.LogError(exception, "Unhandled error bubbled to MainLayout.");
        NotificationService.Error("Application error", "Something went wrong. Please try again later.");
    }
    #endregion

    #region IDisposable -------------------------------------------------------------
    public void Dispose()
    {
        _disposeNotifier.OnNext(true);
        _disposeNotifier.Dispose();
        _experimentSub?.Dispose();
    }
    #endregion
}

/* ---------------------------------------------------------------------------------
 *  Styling note:
 *  â€“ .dark-theme toggled by IThemeService will swap bootstrap variables (implemented
 *    elsewhere). Body class is modified by the service.
 *  â€“ Sidebar, ToastContainer, and ExperimentProgressWidget are custom components.
 * --------------------------------------------------------------------------------*/
