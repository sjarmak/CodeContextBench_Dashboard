@page "/models"
@using CanvasCraft.WebApp.Hubs
@using CanvasCraft.WebApp.Models
@using CanvasCraft.WebApp.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IModelRegistryService ModelRegistryService
@inject NavigationManager Navigation
@inject ILogger<ModelGallery> Log

<!--
    ModelGallery.razor
    Displays a gallery of registered ML models, supports filtering, pagination, and real-time updates
    when a model is retrained or a new version is uploaded (via SignalR + Observer pattern).
-->

<PageTitle>Model Gallery</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-sm-6 col-lg-4 mb-2">
            <input class="form-control"
                   placeholder="Search by name, tag, or description…"
                   @bind="SearchTerm"
                   @bind:event="oninput" />
        </div>

        <div class="col-sm-6 col-lg-3 mb-2">
            <select class="form-select" @bind="SelectedSort">
                @foreach (var option in SortOptions)
                {
                    <option value="@option">@option</option>
                }
            </select>
        </div>

        <div class="col-lg-2 mb-2 d-grid">
            <button class="btn btn-primary"
                    @onclick="RefreshAsync"
                    disabled="@IsBusy">
                @if (IsBusy)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span class="visually-hidden">Refreshing…</span>
                }
                else
                {
                    <i class="bi bi-arrow-repeat"></i> Refresh
                }
            </button>
        </div>
    </div>

    @if (ErrorMessage is not null)
    {
        <div class="alert alert-danger" role="alert">@ErrorMessage</div>
    }

    @if (PagedModels.Count == 0 && !IsBusy)
    {
        <p class="lead text-muted text-center">No models match your criteria.</p>
    }

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var model in PagedModels)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@model.DisplayName</h5>
                        <h6 class="card-subtitle text-muted mb-2">v@model.Version</h6>
                        <p class="card-text flex-grow-1">@model.Description</p>

                        <div class="mb-2">
                            @foreach (var tag in model.Tags)
                            {
                                <span class="badge bg-secondary me-1">@tag</span>
                            }
                        </div>

                        <div>
                            <small class="text-muted">
                                <i class="bi bi-calendar3"></i>
                                @model.CreatedAt.ToLocalTime():ddd, dd MMM yyyy HH:mm
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-light border-0 d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-primary btn-sm" @onclick="() => NavigateToDetails(model.Id)">
                            <i class="bi bi-camera"></i> View
                        </button>

                        @if (model.Performance is not null)
                        {
                            <span class="text-success fw-bold">
                                <i class="bi bi-bar-chart-line"></i>
                                @model.Performance!.PrimaryMetric:P2
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <Pagination TotalItems="@FilteredModels.Count"
                PageSize="@PageSize"
                CurrentPage="@CurrentPage"
                OnPageChanged="OnPageChanged" />

</div>

@code
{
    // UI State
    private bool IsBusy { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string SearchTerm { get; set; } = string.Empty;
    private string SelectedSort { get; set; } = SortBy.CreatedDesc;
    private readonly List<string> SortOptions = new()
    {
        SortBy.CreatedDesc,
        SortBy.CreatedAsc,
        SortBy.NameAsc,
        SortBy.NameDesc,
        SortBy.PerformanceDesc
    };

    // Data
    private IReadOnlyList<ModelMetadata> AllModels { get; set; } = Array.Empty<ModelMetadata>();
    private List<ModelMetadata> FilteredModels { get; set; } = new();
    private List<ModelMetadata> PagedModels { get; set; } = new();

    // Paging
    private const int PageSize = 9;
    private int CurrentPage = 1;

    // Real-time hub
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadModelsAsync();
        await SetupHubAsync();
    }

    private async Task LoadModelsAsync(CancellationToken token = default)
    {
        IsBusy = true;
        ErrorMessage = null;

        try
        {
            AllModels = await ModelRegistryService.ListModelsAsync(token);
            ApplyFilteringAndSorting();
        }
        catch (OperationCanceledException)
        {
            // ignored
        }
        catch (Exception ex)
        {
            Log.LogError(ex, "Failed to load models.");
            ErrorMessage = $"Failed to load models: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
            StateHasChanged();
        }
    }

    private void ApplyFilteringAndSorting()
    {
        IEnumerable<ModelMetadata> query = AllModels;

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            var term = SearchTerm.Trim().ToLowerInvariant();
            query = query.Where(m =>
                m.DisplayName.ToLowerInvariant().Contains(term) ||
                m.Description?.ToLowerInvariant().Contains(term) == true ||
                m.Tags.Any(t => t.ToLowerInvariant().Contains(term)));
        }

        query = SelectedSort switch
        {
            SortBy.CreatedAsc     => query.OrderBy(m => m.CreatedAt),
            SortBy.NameAsc        => query.OrderBy(m => m.DisplayName),
            SortBy.NameDesc       => query.OrderByDescending(m => m.DisplayName),
            SortBy.PerformanceDesc=> query.OrderByDescending(m => m.Performance?.PrimaryMetric),
            _                     => query.OrderByDescending(m => m.CreatedAt),
        };

        FilteredModels = query.ToList();
        ApplyPagination();
    }

    private void ApplyPagination()
    {
        // Clamp current page after filters change
        var maxPage = (int)Math.Ceiling(FilteredModels.Count / (double)PageSize);
        CurrentPage = Math.Clamp(CurrentPage, 1, Math.Max(1, maxPage));

        PagedModels = FilteredModels
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private Task OnPageChanged(int page)
    {
        CurrentPage = page;
        ApplyPagination();
        return Task.CompletedTask;
    }

    private async Task RefreshAsync()
    {
        using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
        await LoadModelsAsync(cts.Token);
    }

    private void NavigateToDetails(Guid modelId)
    {
        Navigation.NavigateTo($"/models/{modelId}");
    }

    private async Task SetupHubAsync()
    {
        // Build SignalR connection to receive model registry events
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hubs/model-monitoring"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<Guid>("ModelUpdated", async (id) =>
        {
            // Reload only the updated model to minimize latency
            try
            {
                var updated = await ModelRegistryService.GetModelAsync(id);
                var index = AllModels.ToList().FindIndex(m => m.Id == id);

                if (index >= 0)
                {
                    // Replace existing item
                    var mutable = AllModels.ToList();
                    mutable[index] = updated;
                    AllModels = mutable;
                }
                else
                {
                    // New model
                    AllModels = AllModels.Append(updated).ToList();
                }
                ApplyFilteringAndSorting();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Log.LogWarning(ex, "Failed to refresh model {ModelId} from hub event.", id);
            }
        });

        _hubConnection.On<Guid>("ModelDeleted", (id) =>
        {
            AllModels = AllModels.Where(m => m.Id != id).ToList();
            ApplyFilteringAndSorting();
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Log.LogWarning(ex, "SignalR connection could not be established.");
            // Non-fatal: the page still works without real-time updates
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private static class SortBy
    {
        public const string CreatedDesc      = "Newest";
        public const string CreatedAsc       = "Oldest";
        public const string NameAsc          = "Name ↑";
        public const string NameDesc         = "Name ↓";
        public const string PerformanceDesc  = "Performance ↓";
    }
}
