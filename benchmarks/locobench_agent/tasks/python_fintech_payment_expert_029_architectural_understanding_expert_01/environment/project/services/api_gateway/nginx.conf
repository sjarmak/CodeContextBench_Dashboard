# ==============================================================
# CrowdPay Connect – API Gateway (N-GINX/OpenResty) Configuration
# --------------------------------------------------------------
# This configuration front-ends all CrowdPay Connect micro-
# services, providing:
#
#   • TLS termination + secure defaults
#   • JWT-aware authentication (via Lua)
#   • Intelligent routing based on URI prefixes
#   • Layer-7 rate-limiting & connection throttling
#   • Centralised request/response logging for audit-trail
#   • Resilient load-balancing with active health checks
#   • Optional Brotli compression for JSON payloads
#
# Author: CrowdPay Connect Platform Team
# ==============================================================

#------------------------------
# Global worker configuration
#------------------------------
user  nginx;
worker_processes  auto;
pid   /run/nginx.pid;

#---------------------------------
# Dynamically loaded NGINX modules
#---------------------------------
load_module  modules/ngx_http_brotli_filter_module.so;
load_module  modules/ngx_http_brotli_static_module.so;

#-----------------
# Events block
#-----------------
events {
    worker_connections  1024;
    # Use epoll for Linux kernels ≥ 2.6 (auto-detected).
}

#-----------------
# HTTP block
#-----------------
http {
    # MIME types & defaults
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ----------------------------
    # Logging & observability
    # ----------------------------
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" rt=$request_time '
                      'ua_rt=$upstream_response_time '
                      'trace=$request_id upstream=$upstream_addr';

    access_log  /var/log/nginx/access.log  main;
    error_log   /var/log/nginx/error.log   warn;

    # ----------------------------
    # Performance tuning
    # ----------------------------
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    # Brotli compression for JSON & text payloads
    brotli              on;
    brotli_comp_level   5;
    brotli_types        application/json text/plain text/css text/javascript application/javascript;

    # ----------------------------
    # Rate-limiting & connection caps
    # ----------------------------
    limit_req_zone   $binary_remote_addr zone=api_rate_limit:10m rate=20r/s;
    limit_conn_zone  $binary_remote_addr zone=perip:10m;
    limit_conn_status 429;

    # ----------------------------
    # Upstream micro-service pools
    # ----------------------------
    upstream auth_service {
        least_conn;
        server auth_svc_1:8080 max_fails=3 fail_timeout=15s;
        server auth_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    upstream kyc_service {
        least_conn;
        server kyc_svc_1:8080 max_fails=3 fail_timeout=15s;
        server kyc_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    upstream risk_service {
        least_conn;
        server risk_svc_1:8080 max_fails=3 fail_timeout=15s;
        server risk_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    upstream settlement_service {
        least_conn;
        server settlement_svc_1:8080 max_fails=3 fail_timeout=15s;
        server settlement_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    upstream compliance_service {
        least_conn;
        server compliance_svc_1:8080 max_fails=3 fail_timeout=15s;
        server compliance_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    upstream crowdpods_service {
        least_conn;
        server crowdpods_svc_1:8080 max_fails=3 fail_timeout=15s;
        server crowdpods_svc_2:8080 max_fails=3 fail_timeout=15s;
    }

    # ----------------------------
    # URI → Upstream mapping
    # ----------------------------
    #
    # This avoids a spaghetti of `location` blocks by
    # dynamically selecting the correct upstream based
    # solely on the URI prefix.
    #
    map $uri $upstream_name {
        default                       crowdpods_service;
        ~^/auth(/|$)                  auth_service;
        ~^/kyc(/|$)                   kyc_service;
        ~^/risk(/|$)                  risk_service;
        ~^/settlement(/|$)            settlement_service;
        ~^/compliance(/|$)            compliance_service;
    }

    # ----------------------------
    # Strict-Transport-Security map
    # ----------------------------
    map $scheme $hsts_header {
        https   "max-age=31536000; includeSubDomains; preload";
        default "";
    }

    # ==========================================================
    # Server block 1:  HTTP → HTTPS redirect (port 80)
    # ==========================================================
    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        return 308   https://$host$request_uri;
    }

    # ==========================================================
    # Server block 2:  Primary TLS API listener (port 443)
    # ==========================================================
    server {
        listen              443 ssl http2;
        listen              [::]:443 ssl http2;
        server_name         api.crowdpayconnect.com;

        # ----------------------------
        # TLS certificates & ciphers
        # ----------------------------
        ssl_certificate      /etc/nginx/ssl/crowdpayconnect.crt;
        ssl_certificate_key  /etc/nginx/ssl/crowdpayconnect.key;
        ssl_protocols        TLSv1.2 TLSv1.3;
        ssl_ciphers          EECDH+AESGCM:EDH+AESGCM;
        ssl_prefer_server_ciphers on;

        # ----------------------------
        # Security headers
        # ----------------------------
        add_header Strict-Transport-Security $hsts_header always;
        add_header X-Frame-Options           "DENY";
        add_header X-Content-Type-Options    "nosniff";
        add_header X-XSS-Protection          "1; mode=block";
        add_header Referrer-Policy           "no-referrer";
        add_header Content-Security-Policy   "default-src 'self'";

        # ----------------------------
        # JWT validation (OpenResty Lua)
        # ----------------------------
        lua_shared_dict jwt_keys 10m;
        init_by_lua_file   /etc/nginx/lua/jwt_init.lua;
        access_by_lua_file /etc/nginx/lua/jwt_access.lua;

        # ----------------------------
        # Connection limits
        # ----------------------------
        limit_conn perip 100;
        limit_req  zone=api_rate_limit burst=40 nodelay;

        # ----------------------------
        # Standard proxy headers
        # ----------------------------
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Traceability
        set $trace_id $request_id;
        proxy_set_header X-Trace-Id $trace_id;

        # Timeouts
        proxy_connect_timeout  10s;
        proxy_send_timeout     30s;
        proxy_read_timeout     30s;

        # ----------------------------
        # Routing logic
        # ----------------------------
        location / {
            # Dynamically proxy to the mapped upstream
            set $backend $upstream_name;
            proxy_pass http://$backend;
        }

        # ---------------------------------
        # Health check endpoint for DevOps
        # ---------------------------------
        location = /_health {
            access_log off;
            default_type application/json;
            return 200 '{"status":"up"}';
        }

        # ---------------------------------
        # Static Swagger /docs/ hosting
        # ---------------------------------
        location /docs/ {
            alias /var/www/static_docs/;
            try_files $uri $uri/ =404;
        }
    }
}
