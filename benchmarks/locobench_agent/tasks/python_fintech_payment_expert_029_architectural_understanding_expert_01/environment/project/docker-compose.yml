```yaml
# ========================================================================
# CrowdPay Connect ‒ docker-compose.yml
#
# A production-grade, multi-service stack orchestrating the core
# CrowdPay Connect platform.  The topology embraces the micro-service,
# event-sourcing and saga-orchestration architecture described in the
# project documentation.
#
# NOTE:
#   • All images are pinned to explicit versions to guarantee repeatable
#     builds. 
#   • Secrets / credentials are mounted through Docker secrets or
#     externalised .env* files—not hard-coded here. 
#   • Health-checks are included for robust zero-downtime deployments. 
#   • Services share an overlay network (“crowdpay_net”) to allow
#     service discovery via DNS (e.g. `user-service:8080`). 
# ========================================================================
version: "3.9"

x-healthcheck: &default_healthcheck
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 15s

x-common-env: &common_env
  SPRING_PROFILES_ACTIVE: docker
  JAVA_TOOL_OPTIONS: >
    -XX:+UseContainerSupport
    -XX:MaxRAMPercentage=75
    -XX:+ExitOnOutOfMemoryError

networks:
  crowdpay_net:
    driver: bridge
  monitoring_net:
    driver: bridge

volumes:
  pg_data:
  es_data:
  rabbitmq_data:
  redis_data:
  grafana_data:

secrets:
  jwt_private_key:
    file: ./secrets/jwt_private.pem
  jwt_public_key:
    file: ./secrets/jwt_public.pem
  pg_password:
    file: ./secrets/postgres_password.txt

services:
# ------------------------------------------------------------------------
# Core infrastructure
# ------------------------------------------------------------------------
  postgres:
    image: postgres:15.3-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: crowdpay
      POSTGRES_DB: crowdpay
      POSTGRES_PASSWORD_FILE: /run/secrets/pg_password
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
    networks: [crowdpay_net]
    secrets:
      - pg_password

  redis:
    image: redis:7.2-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "redis-cli", "ping"]
    networks: [crowdpay_net]

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    hostname: rabbitmq
    restart: unless-stopped
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: crowdpay
      RABBITMQ_DEFAULT_PASS_FILE: /run/secrets/pg_password
    ports:
      - "5672:5672"
      - "15672:15672"  # management UI
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
    networks: [crowdpay_net]
    secrets:
      - pg_password

  eventstore:
    image: eventstore/eventstore:23.10.0-bookworm-slim
    restart: unless-stopped
    environment:
      EVENTSTORE_CLUSTER_SIZE: 1
      EVENTSTORE_RUN_PROJECTIONS: All
      EVENTSTORE_START_STANDARD_PROJECTIONS: "true"
      EVENTSTORE_DEV: "true"
    volumes:
      - es_data:/var/lib/eventstore
    ports:
      - "2113:2113"   # HTTP API / Admin UI
      - "1113:1113"   # TCP
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:2113/health/live"]
    networks: [crowdpay_net]

# ------------------------------------------------------------------------
# Platform micro-services
# ------------------------------------------------------------------------
  gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    image: crowdpay/gateway:1.4.2
    restart: unless-stopped
    environment:
      <<: *common_env
      GATEWAY_CORS_ALLOWED_ORIGINS: "https://app.crowdpay.io"
    depends_on:
      - user-service
      - payment-service
    ports:
      - "8080:8080"  # Expose publicly
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
    networks: [crowdpay_net]

  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    image: crowdpay/user-service:1.3.7
    restart: unless-stopped
    environment:
      <<: *common_env
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: crowdpay
      DB_USER: crowdpay
      DB_PASSWORD_FILE: /run/secrets/pg_password
      JWT_PUBLIC_KEY: /run/secrets/jwt_public_key
      JWT_PRIVATE_KEY: /run/secrets/jwt_private_key
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
    ports:
      - "8081:8081"
    networks: [crowdpay_net]
    secrets:
      - pg_password
      - jwt_private_key
      - jwt_public_key

  payment-service:
    build:
      context: ./services/payment
      dockerfile: Dockerfile
    image: crowdpay/payment-service:2.0.1
    restart: unless-stopped
    environment:
      <<: *common_env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/crowdpay
      SPRING_DATASOURCE_USERNAME: crowdpay
      SPRING_DATASOURCE_PASSWORD_FILE: /run/secrets/pg_password
      RABBITMQ_HOST: rabbitmq
      EVENT_STORE_URL: tcp://eventstore:1113
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eventstore:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
    ports:
      - "8082:8082"
    networks: [crowdpay_net]
    secrets:
      - pg_password

  risk-service:
    build:
      context: ./services/risk
      dockerfile: Dockerfile
    image: crowdpay/risk-service:0.9.4
    restart: unless-stopped
    environment:
      <<: *common_env
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD-SHELL", "curl -f http://localhost:8083/actuator/health || exit 1"]
    networks: [crowdpay_net]

  kyc-service:
    build:
      context: ./services/kyc
      dockerfile: Dockerfile
    image: crowdpay/kyc-service:1.1.0
    restart: unless-stopped
    environment:
      <<: *common_env
      EXTERNAL_KYC_PROVIDER_URL: https://api.sumsub.com
      RABBITMQ_HOST: rabbitmq
      REDIS_HOST: redis
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
    networks: [crowdpay_net]

  settlement-service:
    build:
      context: ./services/settlement
      dockerfile: Dockerfile
    image: crowdpay/settlement-service:1.0.0
    restart: unless-stopped
    environment:
      <<: *common_env
      EVENT_STORE_URL: tcp://eventstore:1113
      RABBITMQ_HOST: rabbitmq
    depends_on:
      eventstore:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
    networks: [crowdpay_net]

  notification-service:
    build:
      context: ./services/notification
      dockerfile: Dockerfile
    image: crowdpay/notification-service:2.2.1
    restart: unless-stopped
    environment:
      <<: *common_env
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      <<: *default_healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
    networks: [crowdpay_net]

# ------------------------------------------------------------------------
# Observability stack
# ------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.47.0
    restart: unless-stopped
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command: --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks: [monitoring_net, crowdpay_net]

  grafana:
    image: grafana/grafana:10.2.2
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/provisioning:/etc/grafana/provisioning
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: crowdpay
    ports:
      - "3000:3000"
    depends_on:
      prometheus:
        condition: service_started
    networks: [monitoring_net, crowdpay_net]
```