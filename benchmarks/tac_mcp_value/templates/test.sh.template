#!/bin/bash
# TAC Task Verification Wrapper
# Runs TheAgentCompany's evaluator and converts to Harbor-compatible exit code

set -e

# Output paths
TRAJECTORY_PATH="${TRAJECTORY_PATH:-/logs/trajectory.jsonl}"
OUTPUT_PATH="/logs/tac_result.json"

# Create empty trajectory if not exists (TAC evaluator expects it)
if [ ! -f "$TRAJECTORY_PATH" ]; then
    echo '[]' > "$TRAJECTORY_PATH"
fi

# Source TAC environment if needed
if [ -n "$TAC_SERVER_HOSTNAME" ]; then
    export SERVER_HOSTNAME="$TAC_SERVER_HOSTNAME"
fi

# Run TAC evaluator
echo "Running TAC evaluator..."
cd /utils

# Check if we need to run init first (for tasks that require it)
if [ -f "/utils/init.sh" ] && [ ! -f "/workspace/.tac_initialized" ]; then
    echo "Initializing TAC task environment..."
    bash /utils/init.sh || true
    touch /workspace/.tac_initialized
fi

# Run the evaluator with decryption key
DECRYPTION_KEY="${DECRYPTION_KEY:-theagentcompany is all you need}" \
python_default /utils/eval.py \
    --trajectory_path "$TRAJECTORY_PATH" \
    --output_path "$OUTPUT_PATH" \
    2>&1 || {
    echo "TAC evaluator failed, attempting alternative evaluation..."
    # Some tasks may not need full TAC eval infrastructure
    echo '{"score": 0, "checkpoints": [], "error": "Evaluator failed"}' > "$OUTPUT_PATH"
}

# Parse result and determine pass/fail
if [ -f "$OUTPUT_PATH" ]; then
    SCORE=$(python3 -c "import json; print(json.load(open('$OUTPUT_PATH')).get('score', 0))" 2>/dev/null || echo "0")
    echo "TAC Score: $SCORE"
    
    # Copy result to Harbor's expected location
    cp "$OUTPUT_PATH" /logs/reward.json 2>/dev/null || true
    
    # Any score > 0 is considered a pass for comparison purposes
    if [ "$SCORE" != "0" ] && [ -n "$SCORE" ]; then
        echo "✓ Task passed with score: $SCORE"
        exit 0
    else
        echo "✗ Task failed with score: $SCORE"
        exit 1
    fi
else
    echo "✗ No result file generated"
    exit 1
fi
