#!/bin/bash
set -e

# Install basic dependencies
apt-get update
apt-get install -y curl build-essential git software-properties-common

# Check Python version (mini-swe-agent requires Python >=3.10)
PYTHON_VERSION=$(python3 --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)

echo "Detected Python version: $PYTHON_VERSION"

# Install Python 3.10+ if system Python is older
if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo "Python $PYTHON_VERSION is too old for mini-swe-agent (requires >=3.10). Installing Python 3.10..."
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y python3.10 python3.10-venv python3.10-dev python3.10-distutils

    # Install pip for Python 3.10
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10

    PYTHON_CMD=python3.10
    echo "Installed Python 3.10 with pip"
else
    echo "Python $PYTHON_VERSION is compatible, using system Python"
    apt-get install -y python3-pip python3-venv
    PYTHON_CMD=python3
fi

# Install mini-swe-agent using pip (avoids uv segfault on ARM64/QEMU)
echo "Installing mini-swe-agent with $PYTHON_CMD..."
{% if version %}
$PYTHON_CMD -m pip install --break-system-packages --index-url https://pypi.org/simple git+https://github.com/li-boxuan/mini-swe-agent.git@{{ version }}
{% else %}
$PYTHON_CMD -m pip install --break-system-packages --index-url https://pypi.org/simple git+https://github.com/li-boxuan/mini-swe-agent.git
{% endif %}

echo "INSTALL_SUCCESS"
