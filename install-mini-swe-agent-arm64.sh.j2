#!/bin/bash
set -e  # Exit immediately if any command fails

echo "Installing mini-swe-agent with Python 3.10+ support..."

# Install basic dependencies
apt-get update
apt-get install -y curl build-essential git software-properties-common

# Install Python 3.10+ (mini-swe-agent requires Python >=3.10)
# Use deadsnakes PPA for older Ubuntu versions that ship with Python 3.9
echo "Checking Python version..."
PYTHON_VERSION=$(python3 --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo "System Python $PYTHON_VERSION is too old (need >=3.10). Installing Python 3.10..."
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y python3.10 python3.10-venv python3.10-dev
    PYTHON_BIN=python3.10
else
    echo "System Python $PYTHON_VERSION is compatible (>=3.10)"
    PYTHON_BIN=python3
fi

# Create a virtual environment for the agent to avoid system package conflicts
echo "Creating virtual environment with $PYTHON_BIN..."
$PYTHON_BIN -m venv /opt/mini-swe-agent-venv
source /opt/mini-swe-agent-venv/bin/activate

# Verify we're using Python 3.10+
VENV_PYTHON_VERSION=$($PYTHON_BIN --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
echo "Virtual environment Python version: $VENV_PYTHON_VERSION"

# Install mini-swe-agent using pip inside the venv
echo "Installing mini-swe-agent..."
{% if version %}
if ! pip install --index-url https://pypi.org/simple git+https://github.com/li-boxuan/mini-swe-agent.git@{{ version }}; then
    echo "ERROR: pip install failed"
    exit 1
fi
{% else %}
if ! pip install --index-url https://pypi.org/simple git+https://github.com/li-boxuan/mini-swe-agent.git; then
    echo "ERROR: pip install failed"
    exit 1
fi
{% endif %}

# List installed binaries for debugging
echo "Installed binaries in venv:"
ls -la /opt/mini-swe-agent-venv/bin/ | grep -E '(mini|swe)' || echo "No mini/swe binaries found"

# Try to find the actual command name (could be mini-swe-agent, mini, mswea, etc.)
AGENT_CMD=""
for cmd in mini-swe-agent mini mswea; do
    if [ -f "/opt/mini-swe-agent-venv/bin/$cmd" ]; then
        AGENT_CMD="$cmd"
        echo "Found agent command: $cmd"
        break
    fi
done

if [ -z "$AGENT_CMD" ]; then
    echo "ERROR: No mini-swe-agent binary found in venv/bin/"
    echo "Contents of /opt/mini-swe-agent-venv/bin/:"
    ls -la /opt/mini-swe-agent-venv/bin/
    exit 1
fi

# Verify the command is executable
if [ ! -x "/opt/mini-swe-agent-venv/bin/$AGENT_CMD" ]; then
    echo "ERROR: $AGENT_CMD binary found but not executable (missing execute permission)"
    ls -la /opt/mini-swe-agent-venv/bin/$AGENT_CMD
    exit 1
fi

# Try to verify it works (some commands don't support --version, so check help or just run with no args)
if /opt/mini-swe-agent-venv/bin/$AGENT_CMD --version &>/dev/null; then
    echo "Agent command '$AGENT_CMD' verified with --version"
elif /opt/mini-swe-agent-venv/bin/$AGENT_CMD --help &>/dev/null; then
    echo "Agent command '$AGENT_CMD' verified with --help"
elif /opt/mini-swe-agent-venv/bin/$AGENT_CMD 2>&1 | head -1 | grep -qi "usage\|error"; then
    echo "Agent command '$AGENT_CMD' verified (responds to invocation)"
else
    echo "WARNING: Could not verify $AGENT_CMD responds correctly, but binary exists and is executable"
    echo "Proceeding anyway..."
fi

echo "Agent installation verified successfully"

# Create symlinks to the binary in /usr/local/bin so it is in the PATH
# Always create 'mini-swe-agent' symlink (standard name)
ln -sf /opt/mini-swe-agent-venv/bin/$AGENT_CMD /usr/local/bin/mini-swe-agent

# Also create symlink with the actual command name if different
if [ "$AGENT_CMD" != "mini-swe-agent" ]; then
    ln -sf /opt/mini-swe-agent-venv/bin/$AGENT_CMD /usr/local/bin/$AGENT_CMD
fi

# Also symlink 'mini' for backwards compatibility
ln -sf /opt/mini-swe-agent-venv/bin/$AGENT_CMD /usr/local/bin/mini

# Verify symlink exists and is accessible
if ! which mini-swe-agent &>/dev/null; then
    echo "ERROR: mini-swe-agent symlink failed - command not in PATH"
    echo "Attempting to diagnose..."
    ls -la /usr/local/bin/ | grep -E '(mini|swe)'
    echo "PATH: $PATH"
    exit 1
fi

echo "INSTALL_SUCCESS: mini-swe-agent installed successfully"

# Try to show version if supported
if mini-swe-agent --version 2>/dev/null; then
    echo "Version check successful"
elif mini-swe-agent --help 2>&1 | head -3; then
    echo "Command responds to --help"
else
    echo "Command is installed and in PATH"
fi