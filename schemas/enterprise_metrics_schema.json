{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Enterprise Metrics Schema",
  "description": "Comprehensive metrics for evaluating AI coding agent performance through enterprise-informed lens. Based on ENTERPRISE_CODEBASES.md research.",
  "type": "object",
  "required": ["metadata", "execution", "time_allocation", "navigation", "tool_usage"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Task and run identification",
      "required": ["task_id", "agent_type", "timestamp", "version"],
      "properties": {
        "task_id": {"type": "string"},
        "agent_type": {"type": "string", "enum": ["baseline", "mcp", "other"]},
        "timestamp": {"type": "string", "format": "date-time"},
        "version": {"type": "string", "description": "Metrics schema version"},
        "session_id": {"type": "string"},
        "model": {"type": "string"},
        "task_category": {"type": "string"},
        "repository": {"type": "string"},
        "repository_size": {"type": "string"}
      }
    },

    "execution": {
      "type": "object",
      "description": "Basic execution metrics",
      "required": ["start_time", "end_time", "total_duration", "total_events"],
      "properties": {
        "start_time": {"type": "string", "format": "date-time"},
        "end_time": {"type": "string", "format": "date-time"},
        "total_duration": {"type": "number", "description": "Duration in seconds"},
        "total_events": {"type": "integer"},
        "exit_status": {"type": "string", "enum": ["success", "failure", "timeout", "error"]},
        "exit_reason": {"type": "string"}
      }
    },

    "tokens": {
      "type": "object",
      "description": "Token usage and cost",
      "required": ["total_input", "total_output", "total"],
      "properties": {
        "total_input": {"type": "integer"},
        "total_output": {"type": "integer"},
        "total": {"type": "integer"},
        "cache_read": {"type": "integer"},
        "cache_creation": {"type": "integer"},
        "cost_usd": {"type": "number"},
        "by_phase": {
          "type": "object",
          "properties": {
            "comprehension": {"type": "integer"},
            "navigation": {"type": "integer"},
            "implementation": {"type": "integer"},
            "testing": {"type": "integer"}
          }
        }
      }
    },

    "time_allocation": {
      "type": "object",
      "description": "Time spent in different phases (inspired by 58% comprehension research)",
      "required": ["total_actions", "comprehension_pct", "navigation_pct", "implementation_pct"],
      "properties": {
        "total_actions": {"type": "integer"},
        "comprehension_actions": {"type": "integer"},
        "navigation_actions": {"type": "integer"},
        "implementation_actions": {"type": "integer"},
        "testing_actions": {"type": "integer"},
        "comprehension_pct": {"type": "number", "minimum": 0, "maximum": 100},
        "navigation_pct": {"type": "number", "minimum": 0, "maximum": 100},
        "implementation_pct": {"type": "number", "minimum": 0, "maximum": 100},
        "testing_pct": {"type": "number", "minimum": 0, "maximum": 100},
        "time_to_first_edit": {"type": "number", "description": "Seconds to first code change"},
        "time_to_first_test": {"type": "number", "description": "Seconds to first test run"},
        "baseline_comparison": {
          "type": "object",
          "description": "Comparison to research baseline (58% comprehension, 35% navigation)",
          "properties": {
            "comprehension_gap": {"type": "number", "description": "Percentage points from 58%"},
            "navigation_gap": {"type": "number", "description": "Percentage points from 35%"}
          }
        }
      }
    },

    "navigation": {
      "type": "object",
      "description": "Code navigation and search patterns",
      "required": ["file_reads", "file_writes", "navigation_efficiency"],
      "properties": {
        "file_reads": {"type": "integer"},
        "file_writes": {"type": "integer"},
        "unique_files_read": {"type": "integer"},
        "unique_files_written": {"type": "integer"},
        "navigation_efficiency": {"type": "number", "description": "Reads per write ratio"},
        "reread_ratio": {"type": "number", "description": "Files read multiple times / total unique files"},
        "rereads": {
          "type": "object",
          "description": "Files read multiple times (comprehension indicator)",
          "additionalProperties": {"type": "integer"}
        },
        "file_access_timeline": {
          "type": "array",
          "description": "Chronological file access pattern",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "action": {"type": "string", "enum": ["read", "write", "edit"]},
              "file": {"type": "string"},
              "context": {"type": "string", "description": "Why this file was accessed"}
            }
          }
        },
        "dwell_time": {
          "type": "object",
          "description": "Time spent in each file (seconds)",
          "additionalProperties": {"type": "number"}
        }
      }
    },

    "tool_usage": {
      "type": "object",
      "description": "Tool call patterns and effectiveness",
      "required": ["tool_calls", "mcp_searches"],
      "properties": {
        "tool_calls": {
          "type": "object",
          "description": "Count by tool type",
          "additionalProperties": {"type": "integer"}
        },
        "tool_timeline": {
          "type": "array",
          "description": "Chronological tool usage",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "tool": {"type": "string"},
              "phase": {"type": "string", "enum": ["comprehension", "navigation", "implementation", "testing"]},
              "input": {"type": "object"},
              "success": {"type": "boolean"}
            }
          }
        },
        "mcp_searches": {"type": "integer", "description": "Number of MCP/Sourcegraph searches"},
        "mcp_tools_detected": {"type": "array", "items": {"type": "string"}},
        "search_queries": {
          "type": "array",
          "description": "Search patterns and quality",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "tool": {"type": "string"},
              "query": {"type": "string"},
              "refinement_of": {"type": "string", "description": "Previous query this refines"},
              "success": {"type": "boolean"}
            }
          }
        }
      }
    },

    "build_test": {
      "type": "object",
      "description": "Build and test cycle metrics (68% burnout from slow feedback)",
      "required": ["test_runs", "build_attempts"],
      "properties": {
        "test_runs": {"type": "integer"},
        "build_attempts": {"type": "integer"},
        "test_passes": {"type": "integer"},
        "test_failures": {"type": "integer"},
        "build_successes": {"type": "integer"},
        "build_failures": {"type": "integer"},
        "time_in_feedback_loop": {"type": "number", "description": "Total seconds in build/test"},
        "avg_test_duration": {"type": "number"},
        "cycles_to_success": {"type": "integer", "description": "Attempts until first passing test"},
        "test_timeline": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "action": {"type": "string", "enum": ["test", "build"]},
              "result": {"type": "string", "enum": ["pass", "fail", "error"]},
              "duration": {"type": "number"},
              "error_type": {"type": "string", "enum": ["syntax", "logic", "timeout", "flaky"]}
            }
          }
        }
      }
    },

    "comprehension": {
      "type": "object",
      "description": "Indicators of code comprehension quality",
      "properties": {
        "documentation_reads": {"type": "integer"},
        "external_doc_lookups": {"type": "integer"},
        "code_summary_requests": {"type": "integer"},
        "architecture_queries": {"type": "integer"},
        "reread_for_understanding": {"type": "integer", "description": "Re-reads after failed implementation"},
        "think_time": {
          "type": "object",
          "description": "Pauses between actions (seconds)",
          "properties": {
            "avg_before_first_edit": {"type": "number"},
            "avg_between_reads": {"type": "number"},
            "avg_before_tests": {"type": "number"}
          }
        }
      }
    },

    "implementation": {
      "type": "object",
      "description": "Code implementation patterns",
      "properties": {
        "edit_operations": {"type": "integer"},
        "lines_added": {"type": "integer"},
        "lines_removed": {"type": "integer"},
        "lines_modified": {"type": "integer"},
        "reverts": {"type": "integer", "description": "Edits that undo previous edits"},
        "trial_and_error": {"type": "integer", "description": "Rapid edit-test-edit cycles"},
        "targeted_edits": {"type": "integer", "description": "Single successful edits"},
        "edit_success_rate": {"type": "number", "description": "Successful edits / total edits"}
      }
    },

    "context_switching": {
      "type": "object",
      "description": "Context switch patterns (23min recovery research)",
      "properties": {
        "file_switches": {"type": "integer"},
        "rapid_switches": {"type": "integer", "description": "Switches within 30 seconds"},
        "thrashing_detected": {"type": "boolean", "description": "Rapid unproductive switching"},
        "avg_dwell_time": {"type": "number", "description": "Average time per file (seconds)"},
        "context_switches": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "from_file": {"type": "string"},
              "to_file": {"type": "string"},
              "reason": {"type": "string"},
              "productive": {"type": "boolean"}
            }
          }
        }
      }
    },

    "quality_indicators": {
      "type": "object",
      "description": "Outcome quality metrics",
      "properties": {
        "task_completed": {"type": "boolean"},
        "correctness_score": {"type": "number", "minimum": 0, "maximum": 1},
        "test_pass_rate": {"type": "number", "minimum": 0, "maximum": 1},
        "code_review_score": {"type": "number", "minimum": 0, "maximum": 1},
        "architecture_score": {"type": "number", "minimum": 0, "maximum": 1},
        "regressions_introduced": {"type": "integer"},
        "bugs_fixed": {"type": "integer"},
        "bugs_introduced": {"type": "integer"}
      }
    },

    "errors": {
      "type": "object",
      "description": "Error patterns and analysis",
      "properties": {
        "syntax_errors": {"type": "integer"},
        "logic_errors": {"type": "integer"},
        "type_errors": {"type": "integer"},
        "import_errors": {"type": "integer"},
        "error_timeline": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "error_type": {"type": "string"},
              "error_message": {"type": "string"},
              "resolution_time": {"type": "number"},
              "resolution_method": {"type": "string"}
            }
          }
        }
      }
    },

    "derived_metrics": {
      "type": "object",
      "description": "Calculated enterprise-comparison metrics",
      "properties": {
        "enterprise_alignment_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "How well agent matches enterprise developer patterns"
        },
        "comprehension_index": {
          "type": "number",
          "description": "Composite: time_allocation + navigation + rereads"
        },
        "efficiency_score": {
          "type": "number",
          "description": "Quality per token spent"
        },
        "navigation_quality": {
          "type": "number",
          "description": "Effectiveness of navigation pattern for task complexity"
        },
        "token_efficiency": {
          "type": "number",
          "description": "Useful tokens / total tokens"
        },
        "rework_ratio": {
          "type": "number",
          "description": "Tokens spent fixing mistakes / total tokens"
        }
      }
    }
  }
}
